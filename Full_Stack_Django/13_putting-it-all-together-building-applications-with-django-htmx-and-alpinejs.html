<html><head><meta content="light dark" name="color-scheme"/><link href="../style/icons/default/16x16.png" rel="icon"/><link href="../style/themes/github-dark.css" id="_theme" rel="stylesheet" type="text/css"/><link href="../style/vendor/prism-okaidia.min.css" id="_prism" rel="stylesheet" type="text/css"/><link defer="" href="../style/style.css" rel="stylesheet"/><style>
.pre-container {
    position: relative;
}

.copy-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 3px 8px;
    font-size: 12px;
    background-color: #800000; /* Maroon */
    color: white;
    border: 1px solid #5c0000; /* Darker maroon */
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.copy-btn:hover {
    background-color: #a00000; /* Lighter maroon on hover */
}

.copy-btn.copied {
    background-color: #006400; /* Dark Green */
    border-color: #004d00;
    color: white;
}

.copy-btn.failed {
    background-color: #dc3545; /* Red */
    border-color: #c82333;
    color: white;
}
</style></head><body class="_theme-github _color-light"><div class="markdown-body" id="_html" style="visibility: visible;"><div class="akbar_container"><h1 id="chapter-13-putting-it-all-together--building-applications-with-django-htmx-and-alpinejs" tabindex="-1"><a class="anchor" href="#chapter-13-putting-it-all-together--building-applications-with-django-htmx-and-alpinejs" name="chapter-13-putting-it-all-together--building-applications-with-django-htmx-and-alpinejs" tabindex="-1"><span class="octicon octicon-link"></span></a>Chapter 13: Putting It All Together – Building Applications with Django, HTMX, and Alpine.js</h1>
<h2 id="131-introduction-the-integrated-stack-in-practice" tabindex="-1"><a class="anchor" href="#131-introduction-the-integrated-stack-in-practice" name="131-introduction-the-integrated-stack-in-practice" tabindex="-1"><span class="octicon octicon-link"></span></a>13.1 Introduction: The Integrated Stack in Practice</h2>
<p>Welcome to a pivotal chapter where theory meets application. Having journeyed through the individual capabilities of Django, HTMX, and Alpine.js, we now stand at the threshold of integrating these powerful tools to build dynamic, reactive web applications. This chapter is dedicated to moving beyond isolated concepts and demonstrating how these technologies coalesce into a cohesive and highly effective full-stack solution. Our focus will be on practical implementation, showcasing how to weave together Django's robust backend, HTMX's server-centric interactivity, and Alpine.js's client-side finesse to create engaging user experiences.</p>
<p>The ensuing sections will guide you through the development of several example applications. Each project is carefully chosen to highlight specific patterns and demonstrate the synergy of the stack in solving real-world problems. Prepare to translate foundational knowledge into tangible skills as we construct applications that are not only functional but also embody the principles of modern web development—responsiveness, efficiency, and maintainability—all while leveraging the unique strengths of our chosen toolkit.</p>
<h3 id="1311-recap-synergy-of-django-htmx-alpinejs" tabindex="-1"><a class="anchor" href="#1311-recap-synergy-of-django-htmx-alpinejs" name="1311-recap-synergy-of-django-htmx-alpinejs" tabindex="-1"><span class="octicon octicon-link"></span></a>13.1.1 Recap: Synergy of Django, HTMX, Alpine.js</h3>
<p>Before we dive into coding, let's briefly revisit the distinct roles of Django, HTMX, and Alpine.js and, more importantly, reaffirm <em>why</em> their combination is so compelling for building modern web applications. Understanding this synergy is crucial for making informed architectural decisions and truly mastering the "Django, HTMX, and Alpine.js way."</p>
<p><strong>Django: The Robust Foundation</strong></p>
<p>At the core of our stack lies Django, the high-level Python web framework that encourages rapid development and clean, pragmatic design.</p>
<ul>
<li><strong>Role</strong>: Django serves as the authoritative backend, managing data persistence through its ORM (Models), handling business logic and request processing (Views), and rendering initial HTML structures (Templates). It's also responsible for security, authentication, and administration.</li>
<li><strong>Why it's foundational</strong>: Django provides the structural integrity and reliability essential for any complex application. It is our "source of truth" for data and business rules. Its mature ecosystem and batteries-included philosophy mean we can build sophisticated backends efficiently. In our stack, Django doesn't just serve full pages; it also becomes a powerful engine for generating HTML partials that HTMX will consume.</li>
</ul>
<p><strong>HTMX: The Conduit for Server-Powered Interactivity</strong></p>
<p>HTMX revolutionizes how we add dynamic behavior to web pages by extending HTML with attributes that enable AJAX requests, CSS transitions, WebSocket interactions, and Server-Sent Events directly from markup.</p>
<ul>
<li><strong>Role</strong>: HTMX acts as the primary mechanism for updating portions of a web page without full reloads. It allows elements to make HTTP requests to the server (our Django backend) and swap the response (typically an HTML fragment) into the DOM.</li>
<li><strong>Why it's transformative</strong>: HTMX enables us to keep rendering logic predominantly on the server, aligning perfectly with Django's template system. This significantly reduces the amount of custom JavaScript needed for common interactive patterns like partial updates, form submissions, and dynamic content loading. It allows Django views to serve both full pages and targeted HTML fragments, simplifying the mental model for dynamic content. Think of HTMX as an intelligent messaging system that allows parts of your webpage to directly request and display fresh content from Django, without needing a JavaScript intermediary to parse data and manipulate the DOM extensively.</li>
</ul>
<p><strong>Alpine.js: The Lightweight Client-Side Enhancer</strong></p>
<p>Alpine.js provides reactive and declarative JavaScript for enhancing user interfaces directly within your HTML markup, offering a minimal footprint.</p>
<ul>
<li><strong>Role</strong>: Alpine.js handles client-side interactivity that doesn't necessarily require a server round-trip. This includes managing UI element states (e.g., dropdown visibility, modal toggles, tab selections), responding to user interactions locally, and adding small flourishes that improve the user experience.</li>
<li><strong>Why it's complementary</strong>: While HTMX excels at server interactions, Alpine.js shines in managing ephemeral, client-only state and behavior. It allows us to write expressive, declarative JavaScript directly in our HTML, keeping logic close to the elements it affects. It's the perfect tool for those UI details where a server request would be overkill or where immediate feedback is paramount. Alpine.js can work independently or in concert with HTMX, for instance, by managing the presentation of content fetched by HTMX or by preparing data for an HTMX request.</li>
</ul>
<p><strong>The Synergy: A Cohesive Full-Stack Approach</strong></p>
<p>The true power emerges when these three components work in concert:</p>
<ol>
<li><strong>Django</strong> builds the robust application core, serves initial pages, and provides API endpoints that return HTML partials.</li>
<li><strong>HTMX</strong> makes it trivial for the frontend to request these partials from Django and seamlessly integrate them into the existing page, creating dynamic experiences with minimal JavaScript.</li>
<li><strong>Alpine.js</strong> sprinkles in client-side interactivity, managing local UI state and enhancing the user experience where server communication isn't needed, or to prepare/react to HTMX interactions.</li>
</ol>
<p>Imagine Django as the central <strong>engine room and factory</strong> of your application, meticulously crafting data and HTML structures. HTMX acts as an efficient <strong>pneumatic tube system</strong>, swiftly delivering precisely the needed HTML components from the factory directly to the part of the user interface that requires updating. Alpine.js, then, is the <strong>local artisan's workshop</strong> right on the user's screen, adding fine-tuned interactive details, polishing the presentation, and managing local tools and states for a smoother, more responsive feel.</p>
<p>This integrated stack allows us to build applications that feel modern and reactive, akin to those built with heavier JavaScript frameworks, but with potentially less complexity, a smaller client-side footprint, and a development experience that remains deeply rooted in Django's strengths. We leverage the server for what it does best (managing state, rendering HTML) and use lightweight tools for targeted client-side enhancements and efficient server communication.</p>
<h3 id="1312-overview-of-example-applications" tabindex="-1"><a class="anchor" href="#1312-overview-of-example-applications" name="1312-overview-of-example-applications" tabindex="-1"><span class="octicon octicon-link"></span></a>13.1.2 Overview of Example Applications</h3>
<p>To solidify your understanding of how Django, HTMX, and Alpine.js collaborate, this chapter will walk you through the construction of three distinct example applications. Each project is designed to illustrate different facets of this integrated stack, progressively building your confidence and competence.</p>
<ol>
<li>
<p><strong>Project 1: Interactive To-Do List</strong></p>
<ul>
<li><strong>Concept &amp; Goals</strong>: A classic yet effective example to demonstrate core CRUD (Create, Read, Update, Delete) operations performed asynchronously. Users will be able to add, view, edit (inline), toggle completion, and delete tasks without any full-page reloads.</li>
<li><strong>Key Technologies &amp; Patterns Demonstrated</strong>:
<ul>
<li><strong>Django</strong>: Models for tasks, views to handle CRUD logic and render HTML fragments, forms for data validation.</li>
<li><strong>HTMX</strong>: <code>hx-post</code> for creating tasks, <code>hx-put</code> for updates (toggling completion, inline editing), <code>hx-delete</code> for removing tasks, <code>hx-target</code> to specify where responses are rendered, and <code>hx-swap</code> for defining how content is updated.</li>
<li><strong>Alpine.js</strong>: Potentially <code>x-data</code> for managing local edit states (e.g., showing/hiding an input field for inline editing), <code>x-show</code> for conditional visibility of UI elements, and <code>x-on</code> for handling client-side events that might trigger HTMX requests or manage local UI.</li>
</ul>
</li>
<li><strong>Learning Focus</strong>: Mastering fundamental reactive patterns for data manipulation, understanding how Django views can serve partial HTML responses for HTMX, and seeing basic Alpine.js usage for UI state.</li>
</ul>
</li>
<li>
<p><strong>Project 2: Live Search and Filterable Product Catalog</strong></p>
<ul>
<li><strong>Concept &amp; Goals</strong>: An application showcasing how to build a product listing page with live search capabilities and dynamic filtering options. As users type in a search box or select filter criteria, the product list will update instantly.</li>
<li><strong>Key Technologies &amp; Patterns Demonstrated</strong>:
<ul>
<li><strong>Django</strong>: QuerySets for efficient database searching and filtering, views that respond to search/filter parameters by returning updated product lists as HTML fragments.</li>
<li><strong>HTMX</strong>: <code>hx-get</code> for fetching filtered/searched data, <code>hx-trigger</code> (e.g., on <code>keyup changed delay:500ms</code> for search inputs, or <code>change</code> for filter dropdowns), <code>hx-target</code> to update the product list area, and <code>hx-push-url</code> to update the browser's URL, making search/filter states bookmarkable.</li>
<li><strong>Alpine.js</strong>: Managing the state of filter controls, perhaps providing immediate UI feedback for selected filters, or enhancing the presentation of search results.</li>
</ul>
</li>
<li><strong>Learning Focus</strong>: Implementing responsive data browsing, handling user input for dynamic server requests, managing URL state with HTMX, and leveraging Django's database querying power.</li>
</ul>
</li>
<li>
<p><strong>Project 3: Simple Real-Time Notification Feed</strong></p>
<ul>
<li><strong>Concept &amp; Goals</strong>: A feature that displays a list of notifications to the user, with new notifications appearing in near real-time without manual refreshes. This could be a simplified version using polling or, if infrastructure allows, Server-Sent Events (SSE).</li>
<li><strong>Key Technologies &amp; Patterns Demonstrated</strong>:
<ul>
<li><strong>Django</strong>: Models for notifications, views to serve notification data. For SSE, integration with Django Channels might be explored conceptually or implemented if focusing on advanced patterns. For polling, a simple Django view returning new notifications.</li>
<li><strong>HTMX</strong>: <code>hx-trigger="every 5s"</code> for polling, or <code>hx-sse</code> to connect to a Server-Sent Event stream. <code>hx-swap-oob</code> (Out-of-Band swaps) could be used to update a notification badge count simultaneously with the feed.</li>
<li><strong>Alpine.js</strong>: Enhancing the display of notifications, managing "mark as read" states locally before an HTMX sync, or controlling UI animations for new notifications.</li>
</ul>
</li>
<li><strong>Learning Focus</strong>: Exploring patterns for achieving real-time or near real-time updates, understanding different strategies (polling vs. SSE) with HTMX, and using OOB swaps for updating multiple UI elements from a single server response.</li>
</ul>
</li>
</ol>
<p>These projects are not just academic exercises; they represent common requirements in modern web applications. As we build them, we will focus on clear explanations of the code, the reasoning behind design choices, and how each piece of the Django, HTMX, and Alpine.js puzzle fits together. Let's begin this practical journey.</p>
<h2 id="132-project-1-interactive-to-do-list" tabindex="-1"><a class="anchor" href="#132-project-1-interactive-to-do-list" name="132-project-1-interactive-to-do-list" tabindex="-1"><span class="octicon octicon-link"></span></a>13.2 Project 1: Interactive To-Do List</h2>
<p>This first project serves as a practical introduction to integrating Django, HTMX, and Alpine.js to build a dynamic, single-page-like experience without the complexity of a full JavaScript framework. We'll create a classic To-Do List application, focusing on achieving seamless CRUD (Create, Read, Update, Delete) operations and inline editing capabilities.</p>
<h3 id="1321-concept--goals" tabindex="-1"><a class="anchor" href="#1321-concept--goals" name="1321-concept--goals" tabindex="-1"><span class="octicon octicon-link"></span></a>13.2.1 Concept &amp; Goals</h3>
<p><strong>Concept:</strong>
The application will be a straightforward To-Do list manager. Users will be able to:</p>
<ol>
<li>View a list of their tasks.</li>
<li>Add new tasks to the list.</li>
<li>Mark tasks as completed or incomplete.</li>
<li>Edit the description of existing tasks directly in the list (inline editing).</li>
<li>Delete tasks from the list.</li>
</ol>
<p><strong>Goals:</strong>
The primary goal is to demonstrate how HTMX can enhance a traditional Django application by making UI updates more granular and responsive, effectively eliminating full-page reloads for most interactions. Alpine.js will be introduced to manage client-side UI states that don't necessarily require server communication, such as toggling an "edit mode" for a task.</p>
<p>Specific technical goals include:</p>
<ul>
<li><strong>CRUD without Full Reloads:</strong> All core operations (adding, updating status, editing text, deleting) will update the UI dynamically using HTML fragments fetched via HTMX.</li>
<li><strong>Inline Editing:</strong> Users should be able to click an "edit" button next to a task, which transforms that task's display into an editable form. Saving or canceling reverts it to a display state, all without a page refresh.</li>
<li><strong>Clear Separation of Concerns:</strong> Django will handle business logic, data persistence, and rendering HTML (both full pages and partials). HTMX will manage AJAX requests and DOM updates. Alpine.js will handle ephemeral client-side state for UI enhancements.</li>
<li><strong>Progressive Enhancement:</strong> The application should ideally be functional (though perhaps less interactive) even if JavaScript (and thus HTMX/Alpine.js) is disabled, though our focus will be on the enhanced experience.</li>
</ul>
<p>This project is chosen for its familiarity and simplicity, allowing us to focus on the integration patterns of Django, HTMX, and Alpine.js rather than complex domain logic. It provides a solid foundation for understanding how these technologies can work in concert.</p>
<h3 id="1322-key-technologies-demonstrated" tabindex="-1"><a class="anchor" href="#1322-key-technologies-demonstrated" name="1322-key-technologies-demonstrated" tabindex="-1"><span class="octicon octicon-link"></span></a>13.2.2 Key Technologies Demonstrated</h3>
<p>To achieve our goals for the interactive To-Do list, we will leverage specific features from each part of our stack:</p>
<p><strong>Django:</strong></p>
<ul>
<li><strong>Models (<code>models.Model</code>):</strong> We'll define a <code>TodoItem</code> model to represent tasks, specifying fields like <code>title</code> and <code>completed_status</code>. This forms the backbone of our data structure.</li>
<li><strong>Views (Function-Based or Class-Based):</strong> Django views will process incoming HTTP requests. Crucially, they will learn to differentiate between standard requests (requiring a full HTML page) and HTMX requests (requiring only an HTML fragment).</li>
<li><strong>Forms (<code>django.forms.ModelForm</code>):</strong> We'll use Django forms for data validation and easy HTML rendering when creating or editing tasks. These forms will be submitted via HTMX.</li>
<li><strong>Templates (Django Template Language):</strong> We'll create templates for the overall page layout and, importantly, smaller partial templates that represent individual to-do items or forms. These partials are what HTMX will fetch and swap into the page.</li>
<li><strong>URL Routing:</strong> Django's URL dispatcher will route requests to the appropriate views, including specific endpoints for HTMX actions.</li>
</ul>
<p><strong>HTMX:</strong></p>
<ul>
<li><strong>Core Attributes (<code>hx-get</code>, <code>hx-post</code>, <code>hx-put</code>, <code>hx-delete</code>):</strong> These attributes will be embedded in our HTML to declare AJAX requests to Django endpoints. We'll use <code>hx-post</code> for creating tasks, <code>hx-put</code> for updates (toggling completion, saving edits), and <code>hx-delete</code> for removing tasks.</li>
<li><strong>Targeting (<code>hx-target</code>):</strong> This attribute specifies which DOM element should be updated with the HTML fragment returned by the server.</li>
<li><strong>Swapping (<code>hx-swap</code>):</strong> This defines <em>how</em> the content is updated (e.g., <code>innerHTML</code>, <code>outerHTML</code>, <code>beforeend</code>). We'll use various strategies depending on the action.</li>
<li><strong>Triggers (<code>hx-trigger</code>):</strong> While many HTMX requests are triggered by default events (like form submission or button click), <code>hx-trigger</code> allows for more complex event handling if needed.</li>
<li><strong>Request Indicators (e.g., <code>htmx-request</code> class):</strong> HTMX automatically adds classes during requests, allowing for visual feedback like loading spinners (though we might not implement complex ones in this basic example).</li>
<li><strong>CSRF Integration:</strong> We'll ensure HTMX requests correctly include Django's CSRF token, likely using the <code>django-htmx</code> library or manual configuration.</li>
</ul>
<p><strong>Alpine.js:</strong></p>
<ul>
<li><strong>Component Scope (<code>x-data</code>):</strong> This directive will define a reactive data object for a section of HTML, typically an individual to-do item when it needs client-side state for inline editing.</li>
<li><strong>Conditional Rendering (<code>x-show</code>, <code>x-if</code>):</strong> <code>x-show</code> will be used to toggle the visibility of elements, such as switching between the display view of a task and its edit form.</li>
<li><strong>Event Handling (<code>x-on</code>):</strong> We'll use <code>x-on:click</code> to trigger Alpine.js methods or change state within an <code>x-data</code> scope, for example, to enter "edit mode."</li>
<li><strong>Data Binding (<code>x-model</code>):</strong> For the inline edit form, <code>x-model</code> will provide two-way binding between an input field and a property in our Alpine.js <code>x-data</code> object.</li>
<li><strong>Initialization (<code>x-init</code>):</strong> Can be used to set up initial state or run code when an Alpine component is initialized.</li>
</ul>
<p><strong>The Synergy:</strong>
The magic lies in how these technologies collaborate:</p>
<ol>
<li>Django serves the initial HTML page.</li>
<li>HTMX attributes on elements within this page declare how to interact with the Django backend for dynamic updates.</li>
<li>When a user interacts (e.g., clicks "Add Task"), HTMX sends an AJAX request to a Django view.</li>
<li>The Django view processes the request (e.g., saves a new task to the database) and returns a small HTML fragment representing the updated state (e.g., the newly added task's HTML).</li>
<li>HTMX receives this fragment and intelligently swaps it into the designated part of the DOM, updating the UI without a full reload.</li>
<li>Alpine.js steps in for purely client-side interactions. For instance, clicking an "Edit" button on a task might use Alpine to toggle <code>x-show</code> on display text and an edit form, all within the browser. When "Save" is clicked on this Alpine-managed form, an HTMX request then sends the data to Django.</li>
</ol>
<p>This combination allows for rich interactivity while keeping the backend logic firmly within Django and minimizing custom JavaScript.</p>
<h3 id="1323-core-django-setup" tabindex="-1"><a class="anchor" href="#1323-core-django-setup" name="1323-core-django-setup" tabindex="-1"><span class="octicon octicon-link"></span></a>13.2.3 Core Django Setup</h3>
<p>Before we dive into the interactive elements, let's establish the foundational Django components for our To-Do application.</p>
<p><strong>1. Project and App Structure:</strong></p>
<p>First, ensure you have a Django project and an app for our to-do list. If you're starting fresh:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># THIS_CODE_SNIPPET</span>
django-admin startproject todo_project
<span class="token builtin class-name">cd</span> todo_project
python manage.py startapp todo
</code></pre>
<p><em>Explanation:</em></p>
<ol>
<li><code>django-admin startproject todo_project</code>: This command creates a new Django project named <code>todo_project</code>. A project is a collection of settings and apps for a particular website.</li>
<li><code>cd todo_project</code>: We navigate into the newly created project directory.</li>
<li><code>python manage.py startapp todo</code>: Inside the project, this command creates a Django app named <code>todo</code>. An app is a web application that does something – e.g., a blog system, a database of public records, or, in our case, a to-do list. Apps are designed to be reusable.</li>
</ol>
<p>Next, add the <code>todo</code> app and <code>django_htmx</code> (which we'll install shortly) to <code>INSTALLED_APPS</code> in your project's <code>todo_project/settings.py</code> file. <code>django-htmx</code> simplifies integrating HTMX, especially with CSRF protection.</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># THIS_CODE_SNIPPET</span>
pip <span class="token function">install</span> django-htmx
</code></pre>
<p><em>Explanation:</em>
This command installs the <code>django-htmx</code> package, which provides utilities to make working with HTMX in Django smoother, including middleware for CSRF token handling with HTMX requests.</p>
<p>Now, modify <code>todo_project/settings.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo_project/settings.py</span>

<span class="token comment"># ... other settings ...</span>

INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'todo'</span><span class="token punctuation">,</span>  <span class="token comment"># Our new app</span>
    <span class="token string">'django_htmx'</span><span class="token punctuation">,</span> <span class="token comment"># For HTMX integration</span>
<span class="token punctuation">]</span>

MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># ... other middleware ...</span>
    <span class="token string">'django_htmx.middleware.HtmxDetailsMiddleware'</span><span class="token punctuation">,</span> <span class="token comment"># For request.htmx</span>
    <span class="token comment"># ... other middleware ...</span>
<span class="token punctuation">]</span>

<span class="token comment"># ... other settings ...</span>
</code></pre>
<p><em>Explanation:</em></p>
<ol>
<li><code>INSTALLED_APPS</code>: This list tells Django which applications are active for this site.
<ul>
<li>We've added <code>'todo'</code> to include our newly created application.</li>
<li>We've added <code>'django_htmx'</code> to enable the <code>django-htmx</code> library's features.</li>
</ul>
</li>
<li><code>MIDDLEWARE</code>: Middleware are hooks into Django’s request/response processing.
<ul>
<li><code>'django_htmx.middleware.HtmxDetailsMiddleware'</code>: This middleware inspects incoming requests for HTMX-specific headers. If present, it sets <code>request.htmx</code> to <code>True</code> and populates <code>request.htmx</code> with an object containing details about the HTMX request (like the triggering element's ID, the target ID, etc.). This is incredibly useful in views to differentiate between full page loads and HTMX partial updates. It's generally recommended to place it after authentication and session middleware but before middleware that might short-circuit the request based on its type.</li>
</ul>
</li>
</ol>
<p><strong>2. Model Definition (<code>todo/models.py</code>):</strong></p>
<p>Let's define the <code>TodoItem</code> model. This class will map to a database table where our tasks are stored.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/models.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone

<span class="token keyword">class</span> <span class="token class-name">TodoItem</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    completed <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    updated_at <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>title

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'-created_at'</span><span class="token punctuation">]</span>
</code></pre>
<p><em>Explanation:</em>
Let's examine this <code>TodoItem</code> model in detail:</p>
<ol>
<li><code>from django.db import models</code>: This line imports the necessary <code>models</code> module from Django, which contains the base <code>Model</code> class and field types.</li>
<li><code>class TodoItem(models.Model):</code>: We define our model <code>TodoItem</code> by inheriting from <code>django.db.models.Model</code>. This inheritance provides all the machinery for database interaction (the ORM).</li>
<li><code>title = models.CharField(max_length=200)</code>:
<ul>
<li>This defines a field named <code>title</code> to store the description of the to-do task.</li>
<li><code>models.CharField</code> is used for short to medium-length strings.</li>
<li><code>max_length=200</code> is a required argument for <code>CharField</code> and sets the maximum length of the string in the database.</li>
</ul>
</li>
<li><code>completed = models.BooleanField(default=False)</code>:
<ul>
<li>This defines a boolean field named <code>completed</code> to track whether a task is done.</li>
<li><code>models.BooleanField</code> stores true/false values.</li>
<li><code>default=False</code> specifies that new tasks will be marked as incomplete by default.</li>
</ul>
</li>
<li><code>created_at = models.DateTimeField(auto_now_add=True)</code>:
<ul>
<li>This field stores the date and time when the task was created.</li>
<li><code>models.DateTimeField</code> is for date and time values.</li>
<li><code>auto_now_add=True</code> automatically sets this field to the current date and time when a <code>TodoItem</code> object is first created. It's non-editable afterwards.</li>
</ul>
</li>
<li><code>updated_at = models.DateTimeField(auto_now=True)</code>:
<ul>
<li>This field stores the date and time of the last update to the task.</li>
<li><code>auto_now=True</code> automatically updates this field to the current date and time whenever the object is saved (including on creation).</li>
</ul>
</li>
<li><code>def __str__(self): return self.title</code>:
<ul>
<li>This is a special Python method that defines the "string representation" of a <code>TodoItem</code> object.</li>
<li>It's what you'll see in the Django admin interface or when you print an object, making it more human-readable. Here, we choose to display the task's title.</li>
</ul>
</li>
<li><code>class Meta:</code>:
<ul>
<li>This inner class allows us to provide metadata options for our model.</li>
</ul>
</li>
<li><code>ordering = ['completed', '-created_at']</code>:
<ul>
<li>This option specifies the default ordering for querysets of <code>TodoItem</code> objects.</li>
<li>Tasks will be ordered first by their <code>completed</code> status (incomplete tasks, which are <code>False</code> or 0, typically come before completed tasks, <code>True</code> or 1).</li>
<li>Within each completion status group, tasks are ordered by <code>created_at</code> in descending order (the minus sign <code>-</code> indicates descending), so newer tasks appear first.</li>
<li>This ensures a consistent and logical display order for our to-do list.</li>
</ul>
</li>
</ol>
<p>This model provides a robust structure for our to-do items, including essential attributes and sensible defaults for ordering.</p>
<p><strong>3. Admin Registration (<code>todo/admin.py</code>):</strong></p>
<p>To easily manage <code>TodoItem</code> objects through Django's admin interface (useful for debugging and initial data population), register the model:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/admin.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> TodoItem

<span class="token decorator annotation punctuation">@admin<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span>TodoItem<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">TodoItemAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    list_display <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'created_at'</span><span class="token punctuation">,</span> <span class="token string">'updated_at'</span><span class="token punctuation">)</span>
    list_filter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'created_at'</span><span class="token punctuation">)</span>
    search_fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre>
<p><em>Explanation:</em></p>
<ol>
<li><code>from django.contrib import admin</code>: Imports the Django admin module.</li>
<li><code>from .models import TodoItem</code>: Imports our <code>TodoItem</code> model.</li>
<li><code>@admin.register(TodoItem)</code>: This decorator is a clean way to register the <code>TodoItem</code> model with the admin site, associating it with the <code>TodoItemAdmin</code> class for customization.</li>
<li><code>class TodoItemAdmin(admin.ModelAdmin):</code>: We create a custom admin class that inherits from <code>admin.ModelAdmin</code>. This allows us to configure how the <code>TodoItem</code> model is displayed and managed in the admin interface.</li>
<li><code>list_display = ('title', 'completed', 'created_at', 'updated_at')</code>:
<ul>
<li>This tuple specifies which fields of the <code>TodoItem</code> model should be displayed as columns in the admin's list view for to-do items.</li>
<li>It provides a quick overview of each task.</li>
</ul>
</li>
<li><code>list_filter = ('completed', 'created_at')</code>:
<ul>
<li>This adds a sidebar in the admin list view that allows filtering tasks by their <code>completed</code> status and by date ranges for <code>created_at</code>.</li>
<li>This is useful for navigating larger sets of data.</li>
</ul>
</li>
<li><code>search_fields = ('title',)</code>:
<ul>
<li>This adds a search bar to the admin list view, allowing administrators to search for tasks by their <code>title</code>.</li>
<li>The search will perform a case-insensitive containment test (e.g., <code>LIKE '%search_term%'</code> in SQL).</li>
</ul>
</li>
</ol>
<p>Registering the model with these customizations makes backend management more efficient.</p>
<p><strong>4. Forms (<code>todo/forms.py</code>):</strong></p>
<p>We'll need a form to handle the creation and editing of to-do items. Django's <code>ModelForm</code> is perfect for this as it can automatically generate form fields based on our <code>TodoItem</code> model.</p>
<p>Create a new file <code>todo/forms.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/forms.py</span>
<span class="token keyword">from</span> django <span class="token keyword">import</span> forms
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> TodoItem

<span class="token keyword">class</span> <span class="token class-name">TodoItemForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> TodoItem
        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token comment"># Only include title for creation/editing via this form</span>
        widgets <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'title'</span><span class="token punctuation">:</span> forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">,</span> <span class="token comment"># For Bootstrap styling, if used</span>
                <span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'Enter new task...'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
</code></pre>
<p><em>Explanation:</em></p>
<ol>
<li><code>from django import forms</code>: Imports the Django forms module.</li>
<li><code>from .models import TodoItem</code>: Imports our <code>TodoItem</code> model.</li>
<li><code>class TodoItemForm(forms.ModelForm):</code>: We define <code>TodoItemForm</code> inheriting from <code>forms.ModelForm</code>. This tells Django to build a form based on a model.</li>
<li><code>class Meta:</code>: The inner <code>Meta</code> class is where we configure the <code>ModelForm</code>.</li>
<li><code>model = TodoItem</code>: This links the form directly to our <code>TodoItem</code> model. Django will introspect this model to create appropriate form fields.</li>
<li><code>fields = ['title']</code>: This list specifies which fields from the <code>TodoItem</code> model should be included in the form. For adding or editing a task's description, we only need the <code>title</code>. The <code>completed</code> status will be handled by a separate mechanism (like a button/checkbox), and <code>created_at</code>/<code>updated_at</code> are managed automatically.</li>
<li><code>widgets = { ... }</code>: This dictionary allows us to customize the HTML widget used to render each form field.
<ul>
<li><code>'title': forms.TextInput(attrs={...})</code>: We specify that the <code>title</code> field should use a standard <code>TextInput</code> widget (an <code>&lt;input type="text"&gt;</code>).</li>
<li><code>attrs={'class': 'form-control', 'placeholder': 'Enter new task...'}</code>: We add HTML attributes to the input field.
<ul>
<li><code>'class': 'form-control'</code> is a common class used by CSS frameworks like Bootstrap for styling form inputs. Even if not using Bootstrap, it's a good hook for custom styling.</li>
<li><code>'placeholder': 'Enter new task...'</code> provides hint text within the input field.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>This form provides a clean and validated way to capture the task title from the user.</p>
<p><strong>5. URLs (<code>todo/urls.py</code> and <code>todo_project/urls.py</code>):</strong></p>
<p>We need to define URL patterns that map web addresses to our Django views.</p>
<p>First, create <code>todo/urls.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

app_name <span class="token operator">=</span> <span class="token string">'todo'</span> <span class="token comment"># Namespace for URLs</span>

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>todo_list_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'todo_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'add/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>add_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'add_todo'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/toggle/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>toggle_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'toggle_todo'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/edit/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>edit_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'edit_todo'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># For submitting edits</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>delete_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'delete_todo'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/get-edit-form/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>get_edit_form_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get_edit_form'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># For fetching the edit form</span>
<span class="token punctuation">]</span>
</code></pre>
<p><em>Explanation:</em></p>
<ol>
<li><code>from django.urls import path</code>: Imports the <code>path</code> function for defining URL patterns.</li>
<li><code>from . import views</code>: Imports the <code>views.py</code> file from the current application (<code>todo</code>). We'll define these views shortly.</li>
<li><code>app_name = 'todo'</code>: This sets a namespace for the URLs in this file. This is crucial for avoiding URL name collisions between different apps in a larger project and allows us to refer to these URLs unambiguously (e.g., <code>{% url 'todo:todo_list' %}</code>).</li>
<li><code>urlpatterns = [...]</code>: A list of URL patterns. Each <code>path()</code> call defines a route.
<ul>
<li><code>path('', views.todo_list_view, name='todo_list')</code>:
<ul>
<li>Maps the root URL of the <code>todo</code> app (e.g., <code>/todos/</code>) to <code>views.todo_list_view</code>.</li>
<li><code>name='todo_list'</code> gives this URL a unique name for easy reference in templates and views.</li>
</ul>
</li>
<li><code>path('add/', views.add_todo_view, name='add_todo')</code>:
<ul>
<li>Maps <code>/todos/add/</code> to <code>views.add_todo_view</code>. This will handle the creation of new to-do items.</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/toggle/', views.toggle_todo_view, name='toggle_todo')</code>:
<ul>
<li>Maps URLs like <code>/todos/1/toggle/</code> to <code>views.toggle_todo_view</code>.</li>
<li><code>&lt;int:pk&gt;</code> is a path converter. It captures an integer from the URL and passes it as a keyword argument named <code>pk</code> (primary key) to the view. This <code>pk</code> will identify which to-do item to toggle.</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/edit/', views.edit_todo_view, name='edit_todo')</code>:
<ul>
<li>Maps URLs like <code>/todos/1/edit/</code> to <code>views.edit_todo_view</code>. This will handle the submission of an edited task title.</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/delete/', views.delete_todo_view, name='delete_todo')</code>:
<ul>
<li>Maps URLs like <code>/todos/1/delete/</code> to <code>views.delete_todo_view</code> for deleting a task.</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/get-edit-form/', views.get_edit_form_view, name='get_edit_form')</code>:
<ul>
<li>Maps URLs like <code>/todos/1/get-edit-form/</code> to <code>views.get_edit_form_view</code>. This endpoint will be used by HTMX to fetch just the HTML for an item's edit form when the user clicks "Edit". This approach keeps the initial page load lighter if edit forms are not always needed immediately.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Next, include these app-specific URLs in your project's main <code>todo_project/urls.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo_project/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'todos/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'todo.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'todo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># Include our app's URLs</span>
<span class="token punctuation">]</span>
</code></pre>
<p><em>Explanation:</em></p>
<ol>
<li><code>from django.urls import path, include</code>: We also need <code>include</code> here.</li>
<li><code>path('todos/', include('todo.urls', namespace='todo'))</code>:
<ul>
<li>This line tells Django that any URL starting with <code>todos/</code> should be routed to the <code>todo.urls</code> module (our <code>todo/urls.py</code> file).</li>
<li><code>include('todo.urls')</code> effectively incorporates all patterns from <code>todo.urls</code> under the <code>todos/</code> prefix.</li>
<li><code>namespace='todo'</code> here matches the <code>app_name</code> in <code>todo/urls.py</code>. This allows us to use namespaced URLs like <code>{% url 'todo:todo_list' %}</code> in templates, ensuring clarity even if other apps have similarly named URLs.</li>
</ul>
</li>
</ol>
<p><strong>6. Templates:</strong></p>
<p>We'll need a base template, a main list template, and partial templates for individual items and forms.</p>
<p>Create the directory structure:</p>
<pre><code>todo/
└── templates/
    └── todo/
        ├── base.html
        ├── todo_list.html
        └── partials/
            ├── todo_item.html
            └── todo_item_form.html (for the edit form)
            └── add_todo_form.html (for the add form, if we want to make it a partial too)
</code></pre>
<p><em><code>todo/templates/todo/base.html</code></em>:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{% block title %}My To-Do App{% endblock %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Basic Styling (optional, replace with your preferred CSS framework/file) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
        <span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #f4f4f4<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.container</span> <span class="token punctuation">{</span> <span class="token property">max-width</span><span class="token punctuation">:</span> 600px<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span> <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 10px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">ul</span> <span class="token punctuation">{</span> <span class="token property">list-style-type</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">li</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span> <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #eee<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">li.completed span</span> <span class="token punctuation">{</span> <span class="token property">text-decoration</span><span class="token punctuation">:</span> line-through<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #aaa<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.actions button, .actions input[type="checkbox"]</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">form input[type="text"]</span> <span class="token punctuation">{</span> <span class="token property">padding</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span> <span class="token property">margin-right</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">flex-grow</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">form button</span> <span class="token punctuation">{</span> <span class="token property">padding</span><span class="token punctuation">:</span> 8px 12px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Basic indicator styling */</span>
        <span class="token selector">.htmx-request .htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Show when request is active */</span>
        <span class="token selector">.htmx-request.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* For elements that are indicators themselves */</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- HTMX --&gt;</span>
    &lt;script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLNB كيانات الويب الحديثة تتجه نحو الديناميكية والتفاعلية العالية، وهذا ما يسعى إليه المطورون في تطبيقاتهم. كتابنا، "Full-Stack Django: Crafting Reactive Apps the HTMX and AlpineJS Way"، يهدف إلى تزويدكم بالمعرفة اللازمة لبناء هذه التطبيقات باستخدام Django كقاعدة خلفية قوية، مع تعزيز الواجهة الأمامية بـ HTMX و Alpine.js لتحقيق تجربة مستخدم سلسة وسريعة الاستجابة.

في هذا الفصل، سنقوم ببناء أول مشروع متكامل يجمع هذه التقنيات: قائمة مهام تفاعلية. هذا المشروع سيوضح بشكل عملي كيف يمكن لـ HTMX أن يقلل من الحاجة إلى JavaScript معقد لإجراء تحديثات جزئية للصفحة، وكيف يمكن لـ Alpine.js أن يضيف لمسات تفاعلية دقيقة على مستوى العميل.

## 13.2 Project 1: Interactive To-Do List

مشروع قائمة المهام (To-Do List) هو مثال كلاسيكي ولكنه فعال للغاية لتوضيح مفاهيم تطوير الويب الحديثة. سنقوم ببناء تطبيق يسمح للمستخدمين بإدارة مهامهم اليومية، مع التركيز على تحقيق تجربة مستخدم سلسة تشبه تطبيقات الصفحة الواحدة (SPA) دون الحاجة إلى تعقيدات أطر عمل JavaScript الكبيرة.

### 13.2.1 Concept &amp; Goals

**المفهوم (Concept):**
سيقوم التطبيق بإدارة قائمة مهام بسيطة. سيتمكن المستخدمون من:
1.  عرض قائمة بمهامهم.
2.  إضافة مهام جديدة إلى القائمة.
3.  تمييز المهام كمكتملة أو غير مكتملة.
4.  تعديل وصف المهام الحالية مباشرة ضمن القائمة (تعديل مضمّن - inline editing).
5.  حذف المهام من القائمة.

**الأهداف (Goals):**
الهدف الأساسي هو توضيح كيف يمكن لـ HTMX تعزيز تطبيق Django تقليدي بجعل تحديثات واجهة المستخدم أكثر دقة واستجابة، مما يلغي فعليًا الحاجة إلى إعادة تحميل الصفحة بالكامل لمعظم التفاعلات. سيتم تقديم Alpine.js لإدارة حالات واجهة المستخدم من جانب العميل التي لا تتطلب بالضرورة اتصالاً بالخادم، مثل تبديل "وضع التعديل" لمهمة ما.

الأهداف التقنية المحددة تشمل:
*   **عمليات CRUD بدون إعادة تحميل كاملة:** جميع العمليات الأساسية (الإضافة، تحديث الحالة، تعديل النص، الحذف) ستقوم بتحديث واجهة المستخدم ديناميكيًا باستخدام أجزاء HTML يتم جلبها عبر HTMX.
*   **التعديل المضمّن (Inline Editing):** يجب أن يتمكن المستخدمون من النقر على زر "تعديل" بجوار المهمة، مما يحول عرض تلك المهمة إلى نموذج قابل للتعديل. الحفظ أو الإلغاء يعيدها إلى حالة العرض، كل ذلك دون تحديث الصفحة.
*   **فصل واضح للمسؤوليات:** سيتولى Django منطق الأعمال، واستمرارية البيانات، وعرض HTML (سواء صفحات كاملة أو أجزاء). سيتولى HTMX إدارة طلبات AJAX وتحديثات DOM. سيتولى Alpine.js حالة واجهة المستخدم المؤقتة من جانب العميل لتحسينات الواجهة.
*   **التحسين التدريجي (Progressive Enhancement):** من الناحية المثالية، يجب أن يكون التطبيق وظيفيًا (وإن كان أقل تفاعلية) حتى لو تم تعطيل JavaScript (وبالتالي HTMX/Alpine.js)، على الرغم من أن تركيزنا سيكون على التجربة المحسنة.

تم اختيار هذا المشروع لبساطته وألفته، مما يسمح لنا بالتركيز على أنماط تكامل Django و HTMX و Alpine.js بدلاً من منطق المجال المعقد. إنه يوفر أساسًا متينًا لفهم كيف يمكن لهذه التقنيات أن تعمل بتناغم.

### 13.2.2 Key Technologies Demonstrated

لتحقيق أهدافنا في قائمة المهام التفاعلية، سنستفيد من ميزات محددة من كل جزء من مجموعتنا التقنية:

**Django:**
*   **النماذج (`models.Model`):** سنقوم بتعريف نموذج `TodoItem` لتمثيل المهام، مع تحديد حقول مثل `title` و `completed_status`. هذا يشكل العمود الفقري لهيكل بياناتنا.
*   **العروض (Views) (القائمة على الدوال أو الفئات):** ستعالج عروض Django طلبات HTTP الواردة. بشكل حاسم، ستتعلم التمييز بين الطلبات القياسية (التي تتطلب صفحة HTML كاملة) وطلبات HTMX (التي تتطلب فقط جزء HTML).
*   **النماذج (`django.forms.ModelForm`):** سنستخدم نماذج Django للتحقق من صحة البيانات وعرض HTML بسهولة عند إنشاء أو تعديل المهام. سيتم إرسال هذه النماذج عبر HTMX.
*   **القوالب (Django Template Language):** سننشئ قوالب لتخطيط الصفحة العام، والأهم من ذلك، قوالب جزئية أصغر تمثل عناصر قائمة مهام فردية أو نماذج. هذه الأجزاء هي ما سيجلبه HTMX ويستبدله في الصفحة.
*   **توجيه URL (URL Routing):** سيوجه موجه URL في Django الطلبات إلى العروض المناسبة، بما في ذلك نقاط نهاية محددة لإجراءات HTMX.

**HTMX:**
*   **السمات الأساسية (`hx-get`, `hx-post`, `hx-put`, `hx-delete`):** سيتم تضمين هذه السمات في HTML الخاص بنا للإعلان عن طلبات AJAX إلى نقاط نهاية Django. سنستخدم `hx-post` لإنشاء المهام، `hx-put` للتحديثات (تبديل الإكمال، حفظ التعديلات)، و `hx-delete` لإزالة المهام.
*   **الاستهداف (`hx-target`):** تحدد هذه السمة أي عنصر DOM يجب تحديثه بجزء HTML الذي يتم إرجاعه بواسطة الخادم.
*   **التبديل (`hx-swap`):** يحدد هذا *كيف* يتم تحديث المحتوى (على سبيل المثال، `innerHTML`, `outerHTML`, `beforeend`). سنستخدم استراتيجيات مختلفة حسب الإجراء.
*   **المشغلات (`hx-trigger`):** بينما يتم تشغيل العديد من طلبات HTMX بواسطة أحداث افتراضية (مثل إرسال النموذج أو النقر فوق الزر)، يسمح `hx-trigger` بمعالجة أحداث أكثر تعقيدًا إذا لزم الأمر.
*   **مؤشرات الطلب (مثل فئة `htmx-request`):** يضيف HTMX تلقائيًا فئات أثناء الطلبات، مما يسمح بتعليقات مرئية مثل دوارات التحميل (على الرغم من أننا قد لا ننفذ مؤشرات معقدة في هذا المثال الأساسي).
*   **تكامل CSRF:** سنتأكد من أن طلبات HTMX تتضمن بشكل صحيح رمز CSRF الخاص بـ Django، ومن المحتمل استخدام مكتبة `django-htmx` أو التكوين اليدوي.

**Alpine.js:**
*   **نطاق المكون (`x-data`):** سيعرّف هذا التوجيه كائن بيانات تفاعليًا لقسم من HTML، عادةً عنصر قائمة مهام فردي عندما يحتاج إلى حالة من جانب العميل للتعديل المضمّن.
*   **العرض الشرطي (`x-show`, `x-if`):** سيتم استخدام `x-show` لتبديل رؤية العناصر، مثل التبديل بين عرض المهمة ونموذج التعديل الخاص بها.
*   **معالجة الأحداث (`x-on`):** سنستخدم `x-on:click` لتشغيل طرق Alpine.js أو تغيير الحالة ضمن نطاق `x-data`، على سبيل المثال، للدخول في "وضع التعديل".
*   **ربط البيانات (`x-model`):** بالنسبة لنموذج التعديل المضمّن، سيوفر `x-model` ربطًا ثنائي الاتجاه بين حقل الإدخال وخاصية في كائن `x-data` الخاص بـ Alpine.js.
*   **التهيئة (`x-init`):** يمكن استخدامه لإعداد الحالة الأولية أو تشغيل التعليمات البرمجية عند تهيئة مكون Alpine.

**التناغم (The Synergy):**
يكمن السحر في كيفية تعاون هذه التقنيات:
1.  يقوم Django بتقديم صفحة HTML الأولية.
2.  تعلن سمات HTMX على العناصر داخل هذه الصفحة عن كيفية التفاعل مع الواجهة الخلفية لـ Django لإجراء تحديثات ديناميكية.
3.  عندما يتفاعل المستخدم (على سبيل المثال، ينقر على "إضافة مهمة")، يرسل HTMX طلب AJAX إلى عرض Django.
4.  يعالج عرض Django الطلب (على سبيل المثال، يحفظ مهمة جديدة في قاعدة البيانات) ويعيد جزء HTML صغيرًا يمثل الحالة المحدثة (على سبيل المثال، HTML للمهمة المضافة حديثًا).
5.  يتلقى HTMX هذا الجزء ويستبدله بذكاء في الجزء المخصص من DOM، محدثًا واجهة المستخدم دون إعادة تحميل كاملة.
6.  يتدخل Alpine.js للتفاعلات من جانب العميل فقط. على سبيل المثال، قد يؤدي النقر فوق زر "تعديل" في مهمة ما إلى استخدام Alpine لتبديل `x-show` على نص العرض ونموذج التعديل، كل ذلك داخل المتصفح. عند النقر فوق "حفظ" في هذا النموذج الذي يديره Alpine، يرسل طلب HTMX البيانات إلى Django.

يسمح هذا المزيج بتفاعلية غنية مع الحفاظ على منطق الواجهة الخلفية بقوة داخل Django وتقليل JavaScript المخصص.

### 13.2.3 Core Django Setup

قبل أن نتعمق في العناصر التفاعلية، دعنا نؤسس مكونات Django الأساسية لتطبيق قائمة المهام الخاص بنا.

**1. هيكل المشروع والتطبيق (Project and App Structure):**

أولاً، تأكد من أن لديك مشروع Django وتطبيقًا لقائمة المهام الخاصة بنا. إذا كنت تبدأ من جديد:
```bash
# THIS_CODE_SNIPPET
django-admin startproject todo_project
cd todo_project
python manage.py startapp todo
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>django-admin startproject todo_project</code>: يقوم هذا الأمر بإنشاء مشروع Django جديد باسم <code>todo_project</code>. المشروع هو مجموعة من الإعدادات والتطبيقات لموقع ويب معين.</li>
<li><code>cd todo_project</code>: ننتقل إلى دليل المشروع الذي تم إنشاؤه حديثًا.</li>
<li><code>python manage.py startapp todo</code>: داخل المشروع، يقوم هذا الأمر بإنشاء تطبيق Django باسم <code>todo</code>. التطبيق هو تطبيق ويب يقوم بشيء ما - على سبيل المثال، نظام مدونة، قاعدة بيانات للسجلات العامة، أو في حالتنا، قائمة مهام. تم تصميم التطبيقات لتكون قابلة لإعادة الاستخدام.</li>
</ol>
<p>بعد ذلك، أضف تطبيق <code>todo</code> و <code>django_htmx</code> (الذي سنقوم بتثبيته قريبًا) إلى <code>INSTALLED_APPS</code> في ملف <code>todo_project/settings.py</code> الخاص بمشروعك. <code>django-htmx</code> يبسط تكامل HTMX، خاصة مع حماية CSRF.</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># THIS_CODE_SNIPPET</span>
pip <span class="token function">install</span> django-htmx
</code></pre>
<p><em>شرح الكود:</em>
يقوم هذا الأمر بتثبيت حزمة <code>django-htmx</code>، التي توفر أدوات مساعدة لجعل العمل مع HTMX في Django أكثر سلاسة، بما في ذلك البرامج الوسيطة (middleware) لمعالجة رمز CSRF مع طلبات HTMX.</p>
<p>الآن، قم بتعديل <code>todo_project/settings.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo_project/settings.py</span>

<span class="token comment"># ... other settings ...</span>

INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'todo'</span><span class="token punctuation">,</span>  <span class="token comment"># Our new app</span>
    <span class="token string">'django_htmx'</span><span class="token punctuation">,</span> <span class="token comment"># For HTMX integration</span>
<span class="token punctuation">]</span>

MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># ... other middleware ...</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django_htmx.middleware.HtmxDetailsMiddleware'</span><span class="token punctuation">,</span> <span class="token comment"># For request.htmx</span>
<span class="token punctuation">]</span>

<span class="token comment"># ... other settings ...</span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>INSTALLED_APPS</code>: هذه القائمة تخبر Django بالتطبيقات النشطة لهذا الموقع.
<ul>
<li>لقد أضفنا <code>'todo'</code> لتضمين تطبيقنا الذي تم إنشاؤه حديثًا.</li>
<li>لقد أضفنا <code>'django_htmx'</code> لتمكين ميزات مكتبة <code>django-htmx</code>.</li>
</ul>
</li>
<li><code>MIDDLEWARE</code>: البرامج الوسيطة هي نقاط ربط في معالجة طلب/استجابة Django.
<ul>
<li><code>'django_htmx.middleware.HtmxDetailsMiddleware'</code>: تقوم هذه البرمجية الوسيطة بفحص الطلبات الواردة بحثًا عن ترويسات خاصة بـ HTMX. إذا كانت موجودة، فإنها تعيّن <code>request.htmx</code> إلى <code>True</code> وتملأ <code>request.htmx</code> بكائن يحتوي على تفاصيل حول طلب HTMX (مثل معرف العنصر المشغل، معرف الهدف، إلخ). هذا مفيد للغاية في العروض للتمييز بين تحميلات الصفحة الكاملة وتحديثات HTMX الجزئية. يوصى عمومًا بوضعه بعد برمجيات المصادقة والجلسة الوسيطة ولكن قبل البرمجيات الوسيطة التي قد تقطع الطلب بناءً على نوعه. تأكد من وضعه في ترتيب منطقي ضمن قائمة <code>MIDDLEWARE</code> الخاصة بك، عادةً بعد <code>CsrfViewMiddleware</code> وقبل أي برمجيات وسيطة قد تعتمد على تفاصيل الطلب.</li>
</ul>
</li>
</ol>
<p><strong>2. تعريف النموذج (<code>todo/models.py</code>):</strong></p>
<p>دعنا نعرّف نموذج <code>TodoItem</code>. هذه الفئة ستُعين إلى جدول قاعدة بيانات حيث يتم تخزين مهامنا.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/models.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone

<span class="token keyword">class</span> <span class="token class-name">TodoItem</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    completed <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    updated_at <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>title

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'-created_at'</span><span class="token punctuation">]</span>
</code></pre>
<p><em>شرح الكود:</em>
دعنا نفحص نموذج <code>TodoItem</code> هذا بالتفصيل:</p>
<ol>
<li><code>from django.db import models</code>: يستورد هذا السطر وحدة <code>models</code> الضرورية من Django، والتي تحتوي على الفئة الأساسية <code>Model</code> وأنواع الحقول.</li>
<li><code>class TodoItem(models.Model):</code>: نعرّف نموذجنا <code>TodoItem</code> عن طريق الوراثة من <code>django.db.models.Model</code>. توفر هذه الوراثة كل الآلية للتفاعل مع قاعدة البيانات (ORM).</li>
<li><code>title = models.CharField(max_length=200)</code>:
<ul>
<li>يعرّف هذا حقلاً باسم <code>title</code> لتخزين وصف مهمة "ما يجب القيام به".</li>
<li>يُستخدم <code>models.CharField</code> للسلاسل النصية القصيرة إلى متوسطة الطول.</li>
<li><code>max_length=200</code> هو وسيط مطلوب لـ <code>CharField</code> ويحدد الحد الأقصى لطول السلسلة في قاعدة البيانات.</li>
</ul>
</li>
<li><code>completed = models.BooleanField(default=False)</code>:
<ul>
<li>يعرّف هذا حقلاً منطقيًا باسم <code>completed</code> لتتبع ما إذا كانت المهمة قد اكتملت.</li>
<li>يخزن <code>models.BooleanField</code> قيم true/false.</li>
<li><code>default=False</code> يحدد أن المهام الجديدة سيتم تمييزها كغير مكتملة بشكل افتراضي.</li>
</ul>
</li>
<li><code>created_at = models.DateTimeField(auto_now_add=True)</code>:
<ul>
<li>يخزن هذا الحقل تاريخ ووقت إنشاء المهمة.</li>
<li><code>models.DateTimeField</code> مخصص لقيم التاريخ والوقت.</li>
<li><code>auto_now_add=True</code> يعيّن هذا الحقل تلقائيًا إلى التاريخ والوقت الحاليين عند إنشاء كائن <code>TodoItem</code> لأول مرة. لا يمكن تعديله بعد ذلك.</li>
</ul>
</li>
<li><code>updated_at = models.DateTimeField(auto_now=True)</code>:
<ul>
<li>يخزن هذا الحقل تاريخ ووقت آخر تحديث للمهمة.</li>
<li><code>auto_now=True</code> يحدّث هذا الحقل تلقائيًا إلى التاريخ والوقت الحاليين كلما تم حفظ الكائن (بما في ذلك عند الإنشاء).</li>
</ul>
</li>
<li><code>def __str__(self): return self.title</code>:
<ul>
<li>هذه طريقة Python خاصة تعرّف "التمثيل النصي" لكائن <code>TodoItem</code>.</li>
<li>هذا ما ستراه في واجهة إدارة Django أو عند طباعة كائن، مما يجعله أكثر قابلية للقراءة من قبل الإنسان. هنا، نختار عرض عنوان المهمة.</li>
</ul>
</li>
<li><code>class Meta:</code>:
<ul>
<li>تسمح هذه الفئة الداخلية لنا بتوفير خيارات بيانات وصفية لنموذجنا.</li>
</ul>
</li>
<li><code>ordering = ['completed', '-created_at']</code>:
<ul>
<li>يحدد هذا الخيار الترتيب الافتراضي لمجموعات استعلام كائنات <code>TodoItem</code>.</li>
<li>سيتم ترتيب المهام أولاً حسب حالة <code>completed</code> (المهام غير المكتملة، وهي <code>False</code> أو 0، تأتي عادةً قبل المهام المكتملة، <code>True</code> أو 1).</li>
<li>ضمن كل مجموعة حالة إكمال، يتم ترتيب المهام حسب <code>created_at</code> بترتيب تنازلي (علامة الطرح <code>-</code> تشير إلى التنازلي)، لذا تظهر المهام الأحدث أولاً.</li>
<li>هذا يضمن ترتيب عرض متسق ومنطقي لقائمة المهام الخاصة بنا.</li>
</ul>
</li>
</ol>
<p>يوفر هذا النموذج بنية قوية لعناصر قائمة المهام الخاصة بنا، بما في ذلك السمات الأساسية والترتيب الافتراضي المعقول.</p>
<p><strong>3. تسجيل النموذج في لوحة التحكم (<code>todo/admin.py</code>):</strong></p>
<p>لتسهيل إدارة كائنات <code>TodoItem</code> من خلال واجهة إدارة Django (مفيدة لتصحيح الأخطاء وإدخال البيانات الأولية)، قم بتسجيل النموذج:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/admin.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> TodoItem

<span class="token decorator annotation punctuation">@admin<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span>TodoItem<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">TodoItemAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    list_display <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'created_at'</span><span class="token punctuation">,</span> <span class="token string">'updated_at'</span><span class="token punctuation">)</span>
    list_filter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'created_at'</span><span class="token punctuation">)</span>
    search_fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>from django.contrib import admin</code>: يستورد وحدة إدارة Django.</li>
<li><code>from .models import TodoItem</code>: يستورد نموذج <code>TodoItem</code> الخاص بنا.</li>
<li><code>@admin.register(TodoItem)</code>: هذا المُزخرف (decorator) هو طريقة نظيفة لتسجيل نموذج <code>TodoItem</code> مع موقع الإدارة، وربطه بفئة <code>TodoItemAdmin</code> للتخصيص.</li>
<li><code>class TodoItemAdmin(admin.ModelAdmin):</code>: ننشئ فئة إدارة مخصصة ترث من <code>admin.ModelAdmin</code>. هذا يسمح لنا بتكوين كيفية عرض نموذج <code>TodoItem</code> وإدارته في واجهة الإدارة.</li>
<li><code>list_display = ('title', 'completed', 'created_at', 'updated_at')</code>:
<ul>
<li>تحدد هذه المجموعة (tuple) أي حقول من نموذج <code>TodoItem</code> يجب عرضها كأعمدة في عرض قائمة الإدارة لعناصر قائمة المهام.</li>
<li>توفر نظرة عامة سريعة على كل مهمة.</li>
</ul>
</li>
<li><code>list_filter = ('completed', 'created_at')</code>:
<ul>
<li>يضيف هذا شريطًا جانبيًا في عرض قائمة الإدارة يسمح بتصفية المهام حسب حالة <code>completed</code> وحسب نطاقات التاريخ لـ <code>created_at</code>.</li>
<li>هذا مفيد للتنقل في مجموعات أكبر من البيانات.</li>
</ul>
</li>
<li><code>search_fields = ('title',)</code>:
<ul>
<li>يضيف هذا شريط بحث إلى عرض قائمة الإدارة، مما يسمح للمسؤولين بالبحث عن المهام حسب <code>title</code> الخاص بها.</li>
<li>سيقوم البحث بإجراء اختبار احتواء غير حساس لحالة الأحرف (على سبيل المثال، <code>LIKE '%search_term%'</code> في SQL).</li>
</ul>
</li>
</ol>
<p>تسجيل النموذج بهذه التخصيصات يجعل إدارة الواجهة الخلفية أكثر كفاءة.</p>
<p><strong>4. النماذج (<code>todo/forms.py</code>):</strong></p>
<p>سنحتاج إلى نموذج للتعامل مع إنشاء وتعديل عناصر قائمة المهام. <code>ModelForm</code> من Django مثالي لهذا لأنه يمكنه إنشاء حقول نموذج تلقائيًا بناءً على نموذج <code>TodoItem</code> الخاص بنا.</p>
<p>أنشئ ملفًا جديدًا <code>todo/forms.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/forms.py</span>
<span class="token keyword">from</span> django <span class="token keyword">import</span> forms
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> TodoItem

<span class="token keyword">class</span> <span class="token class-name">TodoItemForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> TodoItem
        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token comment"># Only include title for creation/editing via this form</span>
        widgets <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'title'</span><span class="token punctuation">:</span> forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'form-control'</span><span class="token punctuation">,</span> <span class="token comment"># For Bootstrap styling, if used</span>
                <span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'أدخل مهمة جديدة...'</span><span class="token punctuation">,</span>
                <span class="token string">'aria-label'</span><span class="token punctuation">:</span> <span class="token string">'عنوان المهمة'</span> <span class="token comment"># For accessibility</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        labels <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment"># Hide the default label, placeholder is enough</span>
        <span class="token punctuation">}</span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>from django import forms</code>: يستورد وحدة نماذج Django.</li>
<li><code>from .models import TodoItem</code>: يستورد نموذج <code>TodoItem</code> الخاص بنا.</li>
<li><code>class TodoItemForm(forms.ModelForm):</code>: نعرّف <code>TodoItemForm</code> بالوراثة من <code>forms.ModelForm</code>. هذا يخبر Django ببناء نموذج بناءً على نموذج.</li>
<li><code>class Meta:</code>: الفئة الداخلية <code>Meta</code> هي المكان الذي نكوّن فيه <code>ModelForm</code>.</li>
<li><code>model = TodoItem</code>: يربط هذا النموذج مباشرة بنموذج <code>TodoItem</code> الخاص بنا. سيقوم Django بفحص هذا النموذج لإنشاء حقول نموذج مناسبة.</li>
<li><code>fields = ['title']</code>: تحدد هذه القائمة أي حقول من نموذج <code>TodoItem</code> يجب تضمينها في النموذج. لإضافة أو تعديل وصف المهمة، نحتاج فقط إلى <code>title</code>. سيتم التعامل مع حالة <code>completed</code> بواسطة آلية منفصلة (مثل زر/مربع اختيار)، ويتم إدارة <code>created_at</code>/<code>updated_at</code> تلقائيًا.</li>
<li><code>widgets = { ... }</code>: يسمح لنا هذا القاموس بتخصيص أداة HTML المستخدمة لعرض كل حقل نموذج.
<ul>
<li><code>'title': forms.TextInput(attrs={...})</code>: نحدد أن حقل <code>title</code> يجب أن يستخدم أداة <code>TextInput</code> قياسية (عنصر <code>&lt;input type="text"&gt;</code>).</li>
<li><code>attrs={'class': 'form-control', 'placeholder': 'أدخل مهمة جديدة...', 'aria-label': 'عنوان المهمة'}</code>: نضيف سمات HTML إلى حقل الإدخال.
<ul>
<li><code>'class': 'form-control'</code> هي فئة شائعة تستخدمها أطر عمل CSS مثل Bootstrap لتصميم حقول الإدخال. حتى لو لم تكن تستخدم Bootstrap، فهي نقطة ربط جيدة للتصميم المخصص.</li>
<li><code>'placeholder': 'أدخل مهمة جديدة...'</code> يوفر نص تلميح داخل حقل الإدخال.</li>
<li><code>'aria-label': 'عنوان المهمة'</code> يحسن إمكانية الوصول من خلال توفير تسمية لبرامج قراءة الشاشة، خاصة وأننا سنخفي التسمية المرئية.</li>
</ul>
</li>
</ul>
</li>
<li><code>labels = { 'title': '', }</code>:
<ul>
<li>هذا القاموس يسمح لنا بتخصيص التسميات المعروضة لحقول النموذج.</li>
<li>بتعيين <code>'title': ''</code>، فإننا نزيل فعليًا التسمية المرئية الافتراضية لحقل العنوان. هذا شائع عندما يكون <code>placeholder</code> كافيًا للإشارة إلى الغرض من الحقل، مما يؤدي إلى واجهة مستخدم أنظف.</li>
</ul>
</li>
</ol>
<p>يوفر هذا النموذج طريقة نظيفة ومتحقق منها لالتقاط عنوان المهمة من المستخدم.</p>
<p><strong>5. عناوين URL (<code>todo/urls.py</code> و <code>todo_project/urls.py</code>):</strong></p>
<p>نحتاج إلى تعريف أنماط URL التي تعين عناوين الويب إلى عروض Django الخاصة بنا.</p>
<p>أولاً، أنشئ <code>todo/urls.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

app_name <span class="token operator">=</span> <span class="token string">'todo'</span> <span class="token comment"># Namespace for URLs</span>

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>todo_list_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'add/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>add_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/toggle/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>toggle_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'toggle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/edit-form/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>get_edit_form_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get_edit_form'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># GET request to fetch the edit form</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/update/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>update_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'update'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># PUT request to submit the edited title</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>delete_todo_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>from django.urls import path</code>: يستورد دالة <code>path</code> لتعريف أنماط URL.</li>
<li><code>from . import views</code>: يستورد ملف <code>views.py</code> من التطبيق الحالي (<code>todo</code>). سنعرّف هذه العروض قريبًا.</li>
<li><code>app_name = 'todo'</code>: يعيّن هذا مساحة اسم (namespace) لعناوين URL في هذا الملف. هذا أمر بالغ الأهمية لتجنب تضارب أسماء URL بين التطبيقات المختلفة في مشروع أكبر ويسمح لنا بالإشارة إلى عناوين URL هذه بشكل لا لبس فيه (على سبيل المثال، <code>{% url 'todo:list' %}</code>).</li>
<li><code>urlpatterns = [...]</code>: قائمة بأنماط URL. كل استدعاء <code>path()</code> يعرّف مسارًا.
<ul>
<li><code>path('', views.todo_list_view, name='list')</code>:
<ul>
<li>يعيّن عنوان URL الجذر لتطبيق <code>todo</code> (على سبيل المثال، <code>/todos/</code>) إلى <code>views.todo_list_view</code>.</li>
<li><code>name='list'</code> يعطي هذا العنوان اسمًا فريدًا لسهولة الرجوع إليه في القوالب والعروض. (تم تغيير الاسم من <code>todo_list</code> إلى <code>list</code> ليكون أقصر ضمن نطاق التطبيق).</li>
</ul>
</li>
<li><code>path('add/', views.add_todo_view, name='add')</code>:
<ul>
<li>يعيّن <code>/todos/add/</code> إلى <code>views.add_todo_view</code>. سيتعامل هذا مع إنشاء عناصر قائمة مهام جديدة.</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/toggle/', views.toggle_todo_view, name='toggle')</code>:
<ul>
<li>يعيّن عناوين URL مثل <code>/todos/1/toggle/</code> إلى <code>views.toggle_todo_view</code>.</li>
<li><code>&lt;int:pk&gt;</code> هو محول مسار. يلتقط عددًا صحيحًا من عنوان URL ويمرره كوسيط كلمة مفتاحية باسم <code>pk</code> (مفتاح أساسي) إلى العرض. سيحدد هذا <code>pk</code> أي عنصر قائمة مهام يجب تبديل حالته.</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/edit-form/', views.get_edit_form_view, name='get_edit_form')</code>:
<ul>
<li>يعيّن عناوين URL مثل <code>/todos/1/edit-form/</code> إلى <code>views.get_edit_form_view</code>. سيتم استخدام نقطة النهاية هذه بواسطة HTMX (عبر طلب <code>GET</code>) لجلب HTML الخاص بنموذج تعديل عنصر ما عندما ينقر المستخدم على "تعديل".</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/update/', views.update_todo_view, name='update')</code>:
<ul>
<li>يعيّن عناوين URL مثل <code>/todos/1/update/</code> إلى <code>views.update_todo_view</code>. سيتعامل هذا مع إرسال عنوان المهمة المعدل (عبر طلب <code>PUT</code> من HTMX).</li>
</ul>
</li>
<li><code>path('&lt;int:pk&gt;/delete/', views.delete_todo_view, name='delete')</code>:
<ul>
<li>يعيّن عناوين URL مثل <code>/todos/1/delete/</code> إلى <code>views.delete_todo_view</code> لحذف مهمة.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>بعد ذلك، قم بتضمين عناوين URL الخاصة بالتطبيق هذه في ملف <code>todo_project/urls.py</code> الرئيسي لمشروعك:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo_project/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'todos/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'todo.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'todo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># Include our app's URLs</span>
<span class="token punctuation">]</span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>from django.urls import path, include</code>: نحتاج أيضًا إلى <code>include</code> هنا.</li>
<li><code>path('todos/', include('todo.urls', namespace='todo'))</code>:
<ul>
<li>يخبر هذا السطر Django بأن أي عنوان URL يبدأ بـ <code>todos/</code> يجب توجيهه إلى وحدة <code>todo.urls</code> (ملف <code>todo/urls.py</code> الخاص بنا).</li>
<li><code>include('todo.urls')</code> يدمج بشكل فعال جميع الأنماط من <code>todo.urls</code> تحت البادئة <code>todos/</code>.</li>
<li><code>namespace='todo'</code> هنا يطابق <code>app_name</code> في <code>todo/urls.py</code>. هذا يسمح لنا باستخدام عناوين URL ذات مساحات أسماء مثل <code>{% url 'todo:list' %}</code> في القوالب، مما يضمن الوضوح حتى لو كانت هناك تطبيقات أخرى لها عناوين URL مسماة بشكل مشابه.</li>
</ul>
</li>
</ol>
<p><strong>6. القوالب (Templates):</strong></p>
<p>سنحتاج إلى قالب أساسي، وقالب قائمة رئيسي، وقوالب جزئية للعناصر الفردية والنماذج.</p>
<p>أنشئ هيكل الدليل:</p>
<pre><code>todo/
└── templates/
    └── todo/  &lt;-- Note: an extra 'todo' directory for namespacing
        ├── base.html
        ├── todo_list.html
        └── partials/
            ├── todo_item_display.html  &lt;-- For displaying an item
            ├── todo_item_form.html     &lt;-- For the inline edit form
            └── add_todo_form.html      &lt;-- For the main "add task" form
</code></pre>
<p><em>ملاحظة هامة حول هيكل القوالب:</em> من الممارسات الجيدة في Django إنشاء دليل فرعي داخل <code>templates</code> يحمل نفس اسم التطبيق (هنا <code>todo/templates/todo/</code>). هذا يساعد Django على التمييز بين القوالب التي قد تحمل نفس الاسم ولكنها تنتمي إلى تطبيقات مختلفة، وهو ما يُعرف بـ "قوالب التطبيقات ذات مساحات الأسماء".</p>
<p><em><code>todo/templates/todo/base.html</code></em>:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ar<span class="token punctuation">"</span></span> <span class="token attr-name">dir</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rtl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{% block title %}تطبيق قائمة المهام{% endblock %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Basic Styling (optional, replace with your preferred CSS framework/file) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
        <span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'Segoe UI'</span><span class="token punctuation">,</span> Tahoma<span class="token punctuation">,</span> Geneva<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #f4f7f6<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.container</span> <span class="token punctuation">{</span> <span class="token property">max-width</span><span class="token punctuation">:</span> 700px<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 25px<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 4px 12px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> #2c3e50<span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token selector">ul#todo-list</span> <span class="token punctuation">{</span> <span class="token property">list-style-type</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.todo-item-container</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 12px 0<span class="token punctuation">;</span> <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #ecf0f1<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.todo-item-container:last-child</span> <span class="token punctuation">{</span> <span class="token property">border-bottom</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.todo-item-display, .todo-item-edit-form</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span> <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token selector">.todo-item-display.completed .item-title</span> <span class="token punctuation">{</span> <span class="token property">text-decoration</span><span class="token punctuation">:</span> line-through<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #95a5a6<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.item-title</span> <span class="token punctuation">{</span> <span class="token property">flex-grow</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0 10px<span class="token punctuation">;</span> <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.actions button, .actions input[type="checkbox"]</span> <span class="token punctuation">{</span> <span class="token property">margin-right</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 6px 10px<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #bdc3c7<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span> <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #f8f9fa<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.actions button:hover</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #e9ecef<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.actions .delete-btn</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #e74c3c<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border-color</span><span class="token punctuation">:</span> #c0392b<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token selector">.actions .delete-btn:hover</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #c0392b<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.actions .edit-btn</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #3498db<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border-color</span><span class="token punctuation">:</span> #2980b9<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token selector">.actions .edit-btn:hover</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #2980b9<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.actions .save-btn</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #2ecc71<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border-color</span><span class="token punctuation">:</span> #27ae60<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token selector">.actions .save-btn:hover</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #27ae60<span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token selector">form#add-todo-form</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">form#add-todo-form input[type="text"]</span> <span class="token punctuation">{</span> <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">flex-grow</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #dfe6e9<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">form#add-todo-form button</span> <span class="token punctuation">{</span> <span class="token property">padding</span><span class="token punctuation">:</span> 10px 15px<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #1abc9c<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span> <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">form#add-todo-form button:hover</span> <span class="token punctuation">{</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #16a085<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        
        <span class="token selector">.todo-item-edit-form input[type="text"]</span> <span class="token punctuation">{</span> <span class="token property">padding</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0 10px<span class="token punctuation">;</span> <span class="token property">flex-grow</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #bdc3c7<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span><span class="token punctuation">}</span>

        <span class="token selector">.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">opacity</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span> <span class="token property">transition</span><span class="token punctuation">:</span> opacity 200ms ease-in<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.htmx-request .htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">opacity</span><span class="token punctuation">:</span>1 <span class="token punctuation">}</span>
        <span class="token selector">.htmx-request.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">opacity</span><span class="token punctuation">:</span>1 <span class="token punctuation">}</span>
        <span class="token selector">#loading-spinner</span> <span class="token punctuation">{</span> <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- HTMX --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/htmx.org@1.9.10<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLNBDRLo1SnsPuxoEHxF1lrYJ2R5MREAc<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Alpine.js --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/alpinejs@3.13.10/dist/cdn.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    {% block extra_head %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{% block page_title %}قائمة المهام{% endblock %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        {% block content %}
        {% endblock %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    {% block extra_js %}{% endblock %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token comment">// Include CSRF token in HTMX requests</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'htmx:configRequest'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-CSRFToken'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'{{ csrf_token }}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>&lt;!DOCTYPE html&gt; &lt;html lang="ar" dir="rtl"&gt;</code>: التعريف القياسي لمستند HTML5، مع تحديد اللغة العربية (<code>lang="ar"</code>) واتجاه النص من اليمين إلى اليسار (<code>dir="rtl"</code>).</li>
<li><code>&lt;meta charset="UTF-8"&gt; &lt;meta name="viewport" ...&gt;</code>: إعدادات أساسية للميتا، بما في ذلك ترميز الأحرف وتكوين منفذ العرض للاستجابة.</li>
<li><code>&lt;title&gt;{% block title %}...{% endblock %}&lt;/title&gt;</code>: وسم <code>title</code> للصفحة، مع استخدام وسم القالب <code>{% block title %}</code> للسماح للقوالب الفرعية بتجاوز العنوان الافتراضي.</li>
<li><code>&lt;style&gt;...&lt;/style&gt;</code>: قسم CSS مضمّن لتوفير بعض الأنماط الأساسية. في مشروع حقيقي، من الأفضل وضع هذا في ملف CSS منفصل.
<ul>
<li>الأنماط تستهدف عناصر HTML الشائعة وجعل القائمة تبدو لائقة.</li>
<li><code>.htmx-indicator</code>: يُستخدم لإظهار مؤشر تحميل أثناء طلبات HTMX. يتم إخفاؤه افتراضيًا ويُظهر عندما يكون طلب HTMX نشطًا (بفضل فئات <code>.htmx-request</code> التي يضيفها HTMX).</li>
</ul>
</li>
<li><code>&lt;script src="https://unpkg.com/htmx.org@..."&gt;</code>: تضمين مكتبة HTMX من شبكة توصيل المحتوى (CDN). <code>integrity</code> و <code>crossorigin</code> هما ميزتا أمان.</li>
<li><code>&lt;script defer src="https://unpkg.com/alpinejs@..."&gt;</code>: تضمين مكتبة Alpine.js من CDN. السمة <code>defer</code> تضمن تحميل السكربت بعد تحليل HTML ولكنه يُنفذ قبل حدث <code>DOMContentLoaded</code>.</li>
<li><code>{% block extra_head %}{% endblock %}</code>: كتلة قالب فارغة يمكن للقوالب الفرعية استخدامها لإضافة عناصر إضافية إلى قسم <code>&lt;head&gt;</code> (مثل ملفات CSS إضافية).</li>
<li><code>&lt;div class="container"&gt; ... &lt;/div&gt;</code>: حاوية رئيسية لمحتوى الصفحة.</li>
<li><code>&lt;h1&gt;{% block page_title %}...{% endblock %}&lt;/h1&gt;</code>: عنوان رئيسي للصفحة، قابل للتجاوز.</li>
<li><code>{% block content %}{% endblock %}</code>: هذه هي الكتلة الرئيسية حيث سيتم إدخال محتوى الصفحة المحدد من القوالب الفرعية.</li>
<li><code>{% block extra_js %}{% endblock %}</code>: كتلة قالب فارغة لإضافة JavaScript إضافي في نهاية الجسم.</li>
<li><code>&lt;script&gt; document.body.addEventListener('htmx:configRequest', ... &lt;/script&gt;</code>:
<ul>
<li>هذا جزء مهم جدًا لتكامل HTMX مع حماية CSRF في Django.</li>
<li><code>htmx:configRequest</code> هو حدث يطلقه HTMX قبل إرسال أي طلب AJAX.</li>
<li>نستمع إلى هذا الحدث على <code>document.body</code>.</li>
<li>داخل معالج الحدث، نضيف ترويسة <code>X-CSRFToken</code> إلى الطلب.</li>
<li><code>event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';</code>: قيمة <code>{{ csrf_token }}</code> يتم توفيرها بواسطة Django في القالب (بفضل <code>CsrfViewMiddleware</code>) وهي رمز CSRF الحالي.</li>
<li>هذا يضمن أن جميع طلبات HTMX (POST, PUT, DELETE, etc.) ستتضمن رمز CSRF، مما يسمح لـ Django بالتحقق منها وقبولها. بدلاً من هذا الإعداد اليدوي، يمكن لمكتبة <code>django-htmx</code> التعامل مع هذا تلقائيًا إذا تم تكوينها بشكل صحيح. ومع ذلك، فإن فهم كيفية عملها يدويًا أمر مفيد.</li>
</ul>
</li>
</ol>
<p>هذا القالب الأساسي يوفر الهيكل المشترك لجميع صفحاتنا، بما في ذلك تضمين HTMX و Alpine.js والتعامل مع CSRF.</p>
<p><em><code>todo/templates/todo/partials/add_todo_form.html</code></em>:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>add-todo-form<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-post</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:add' %}<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-list<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>beforeend<span class="token punctuation">"</span></span>
      <span class="token attr-name"><span class="token namespace">hx-on:</span>:after-request</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>if(event.detail.successful) this.reset()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% csrf_token %}
    {{ form.title }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>إضافة مهمة<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>add-loading-spinner<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>⏳<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>&lt;form id="add-todo-form" ...&gt;</code>: هذا هو نموذج HTML لإضافة مهمة جديدة.</li>
<li><code>hx-post="{% url 'todo:add' %}"</code>:
<ul>
<li>السمة الأساسية لـ HTMX. تخبر HTMX بإرسال طلب <code>POST</code> إلى عنوان URL المحدد عند إرسال النموذج.</li>
<li><code>{% url 'todo:add' %}</code>: يستخدم وسم القالب <code>url</code> الخاص بـ Django لإنشاء عنوان URL بشكل ديناميكي للعرض المسمى <code>add</code> ضمن مساحة الاسم <code>todo</code>. هذا يضمن أن عنوان URL صحيح دائمًا حتى لو قمت بتغيير نمط URL في <code>urls.py</code>.</li>
</ul>
</li>
<li><code>hx-target="#todo-list"</code>:
<ul>
<li>يخبر HTMX أين يجب وضع استجابة الخادم (التي ستكون جزء HTML للمهمة الجديدة).</li>
<li><code>"#todo-list"</code> هو محدد CSS يستهدف عنصر <code>&lt;ul&gt;</code> (أو أي حاوية أخرى) حيث يتم عرض قائمة المهام. سنقوم بتعريف هذا العنصر في <code>todo_list.html</code>.</li>
</ul>
</li>
<li><code>hx-swap="beforeend"</code>:
<ul>
<li>يحدد كيفية إدراج استجابة الخادم في العنصر الهدف.</li>
<li><code>"beforeend"</code> تعني أن المحتوى الجديد سيتم إلحاقه كآخر ابن للعنصر الهدف (<code>#todo-list</code>). هذا مثالي لإضافة مهمة جديدة إلى نهاية القائمة.</li>
</ul>
</li>
<li><code>hx-on::after-request="if(event.detail.successful) this.reset()"</code>:
<ul>
<li>هذه سمة HTMX متقدمة قليلاً للتعامل مع الأحداث.</li>
<li><code>hx-on::after-request</code>: يستمع إلى حدث <code>htmx:afterRequest</code> الذي يتم إطلاقه بعد اكتمال طلب HTMX.</li>
<li><code>if(event.detail.successful) this.reset()</code>: هذا هو JavaScript الذي يتم تنفيذه.
<ul>
<li><code>event.detail.successful</code>: يتحقق مما إذا كان الطلب ناجحًا (عادةً استجابة 2xx).</li>
<li><code>this.reset()</code>: إذا كان الطلب ناجحًا، فإنه يستدعي طريقة <code>reset()</code> على النموذج نفسه (<code>this</code> يشير إلى عنصر النموذج). هذا يمسح حقل الإدخال بعد إضافة مهمة بنجاح، مما يحسن تجربة المستخدم.</li>
</ul>
</li>
</ul>
</li>
<li><code>{% csrf_token %}</code>:
<ul>
<li>وسم قالب Django ضروري. يقوم بإدراج حقل إدخال مخفي يحتوي على رمز CSRF (الحماية من تزوير الطلبات عبر المواقع). يجب أن يكون هذا الوسم موجودًا داخل أي نموذج Django يتم إرساله عبر <code>POST</code>. HTMX سيقوم بتضمين هذا الرمز في الطلب.</li>
</ul>
</li>
<li><code>{{ form.title }}</code>:
<ul>
<li>يعرض هذا حقل <code>title</code> من كائن <code>TodoItemForm</code> الذي سنمرره إلى هذا القالب من العرض.</li>
<li>Django سيقوم بعرضه كعنصر <code>&lt;input type="text"&gt;</code> مع السمات التي حددناها في <code>TodoItemForm</code> (مثل <code>class="form-control"</code> و <code>placeholder</code>).</li>
</ul>
</li>
<li><code>&lt;button type="submit"&gt;إضافة مهمة&lt;/button&gt;</code>: زر الإرسال القياسي للنموذج.</li>
<li><code>&lt;span id="add-loading-spinner" class="htmx-indicator"&gt;⏳&lt;/span&gt;</code>:
<ul>
<li>هذا عنصر <code>&lt;span&gt;</code> سيعمل كمؤشر تحميل بسيط.</li>
<li><code>class="htmx-indicator"</code>: يربطه بنظام مؤشرات HTMX. سيتم إظهاره (بفضل أنماط CSS التي أضفناها في <code>base.html</code>) عندما يكون طلب HTMX من هذا النموذج قيد التقدم.</li>
</ul>
</li>
</ol>
<p>هذا القالب الجزئي مسؤول فقط عن نموذج إضافة المهمة، مما يجعله قابلاً لإعادة الاستخدام ويمكن تحميله أو تحديثه بشكل مستقل إذا لزم الأمر.</p>
<p><em><code>todo/templates/todo/todo_list.html</code></em>:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
{% extends "todo/base.html" %}

{% block title %}قائمة مهامي - {{ block.super }}{% endblock %}

{% block page_title %}قائمة المهام التفاعلية{% endblock %}

{% block content %}
    {% include "todo/partials/add_todo_form.html" with form=add_form %}

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo-list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% for item in todo_items %}
            {% include "todo/partials/todo_item_display.html" with item=item %}
        {% empty %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>empty-message<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>لا توجد مهام حتى الآن. قم بإضافة واحدة!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        {% endfor %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>{% extends "todo/base.html" %}</code>:
<ul>
<li>يشير هذا إلى أن هذا القالب يرث من <code>todo/base.html</code>. سيرث الهيكل الأساسي (HTML, HEAD, BODY)، بما في ذلك تضمينات HTMX و Alpine.js.</li>
</ul>
</li>
<li><code>{% block title %}قائمة مهامي - {{ block.super }}{% endblock %}</code>:
<ul>
<li>يتجاوز كتلة <code>title</code> المحددة في <code>base.html</code>.</li>
<li><code>{{ block.super }}</code>: يقوم بإدراج محتوى كتلة <code>title</code> من القالب الأصل، مما يسمح لنا بإضافة نص إلى العنوان الحالي بدلاً من استبداله بالكامل.</li>
</ul>
</li>
<li><code>{% block page_title %}قائمة المهام التفاعلية{% endblock %}</code>:
<ul>
<li>يتجاوز كتلة <code>page_title</code> لتوفير عنوان خاص لهذه الصفحة.</li>
</ul>
</li>
<li><code>{% block content %}</code>:
<ul>
<li>هذا هو المكان الذي يتم فيه إدخال المحتوى الرئيسي لهذه الصفحة.</li>
</ul>
</li>
<li><code>{% include "todo/partials/add_todo_form.html" with form=add_form %}</code>:
<ul>
<li>يتضمن هذا القالب الجزئي <code>add_todo_form.html</code> الذي أنشأناه سابقًا.</li>
<li><code>with form=add_form</code>: يمرر هذا متغير سياق يسمى <code>add_form</code> (والذي سنوفره من عرض Django) إلى القالب الجزئي المضمن. سيتم تعيين هذا المتغير إلى متغير <code>form</code> داخل <code>add_todo_form.html</code>.</li>
</ul>
</li>
<li><code>&lt;ul id="todo-list"&gt; ... &lt;/ul&gt;</code>:
<ul>
<li>هذه هي القائمة غير المرتبة (<code>&lt;ul&gt;</code>) التي ستحتوي على عناصر قائمة المهام.</li>
<li><code>id="todo-list"</code>: هذا المعرف مهم جدًا. إنه الهدف (<code>hx-target</code>) الذي حددناه في <code>add_todo_form.html</code> لطلبات <code>hx-post</code>. عندما يتم إرجاع مهمة جديدة من الخادم، سيقوم HTMX بإلحاقها داخل هذا <code>&lt;ul&gt;</code>.</li>
</ul>
</li>
<li><code>{% for item in todo_items %}</code>:
<ul>
<li>حلقة Django القياسية للتكرار عبر قائمة <code>todo_items</code> (التي سنمررها من العرض).</li>
<li><code>{% include "todo/partials/todo_item_display.html" with item=item %}</code>: لكل <code>item</code> في القائمة، نقوم بتضمين قالب جزئي آخر، <code>todo_item_display.html</code>. هذا القالب سيكون مسؤولاً عن عرض مهمة واحدة. نمرر كائن <code>item</code> الحالي إلى هذا القالب الجزئي.</li>
</ul>
</li>
<li><code>{% empty %}</code>:
<ul>
<li>يتم تنفيذ هذا الجزء من الحلقة إذا كانت قائمة <code>todo_items</code> فارغة.</li>
<li><code>&lt;li id="empty-message"&gt;لا توجد مهام حتى الآن. قم بإضافة واحدة!&lt;/li&gt;</code>: يعرض رسالة ودية للمستخدم.</li>
</ul>
</li>
<li><code>{% endfor %}</code>: يغلق حلقة <code>for</code>.</li>
</ol>
<p>يعرض هذا القالب الصفحة الرئيسية لتطبيق قائمة المهام، بما في ذلك نموذج الإضافة وقائمة المهام الحالية. إنه يعتمد بشكل كبير على القوالب الجزئية للحفاظ على تنظيم الكود وقابليته لإعادة الاستخدام.</p>
<p><em><code>todo/templates/todo/partials/todo_item_display.html</code></em>:
(هذا القالب سيعرض المهمة وسيتضمن منطق Alpine.js لتبديل وضع التعديل)</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo-item-container {% if item.completed %}completed{% endif %}<span class="token punctuation">"</span></span>
    <span class="token attr-name">x-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ editing: false, currentTitle: '{{ item.title|escapejs }}' }<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Display View --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo-item-display<span class="token punctuation">"</span></span> <span class="token attr-name">x-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!editing<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span>
               <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-completed-toggle<span class="token punctuation">"</span></span>
               <span class="token attr-name">{%</span> <span class="token attr-name">if</span> <span class="token attr-name">item.completed</span> <span class="token attr-name">%}checked{%</span> <span class="token attr-name">endif</span> <span class="token attr-name">%}</span>
               <span class="token attr-name">hx-put</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:toggle' item.pk %}<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-title<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ item.title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>actions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>edit-btn<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>تعديل<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>delete-btn<span class="token punctuation">"</span></span>
                    <span class="token attr-name">hx-delete</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:delete' item.pk %}<span class="token punctuation">"</span></span>
                    <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
                    <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span>
                    <span class="token attr-name">hx-confirm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>هل أنت متأكد أنك تريد حذف هذه المهمة؟<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>حذف<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Edit Form View (initially hidden by Alpine.js) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo-item-edit-form<span class="token punctuation">"</span></span> <span class="token attr-name">x-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing<span class="token punctuation">"</span></span> <span class="token attr-name">x-cloak</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>
              <span class="token attr-name">hx-put</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:update' item.pk %}<span class="token punctuation">"</span></span>
              <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
              <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span>
              <span class="token attr-name">@submit.prevent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = false; htmx.process(htmx.closest(event.target, 'form'))<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            {# Note: No {% csrf_token %} needed for PUT if handled by middleware/global config #}
            {# If not, you might need to add it or ensure X-CSRFToken header is sent #}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">x-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>currentTitle<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>تعديل عنوان المهمة<span class="token punctuation">"</span></span> <span class="token attr-name">x-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editField<span class="token punctuation">"</span></span> <span class="token attr-name">@keydown.escape</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>actions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>save-btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>حفظ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = false<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cancel-btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>إلغاء<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>🔄<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><em>شرح الكود:</em>
هذا القالب هو قلب التفاعل لكل عنصر مهمة. دعنا نحلله:</p>
<ol>
<li>
<p><code>&lt;li id="todo-item-{{ item.pk }}" ...&gt;</code>:</p>
<ul>
<li>عنصر القائمة (<code>&lt;li&gt;</code>) الذي يغلف مهمة واحدة.</li>
<li><code>id="todo-item-{{ item.pk }}"</code>: معرف فريد لكل عنصر مهمة، باستخدام المفتاح الأساسي (<code>pk</code>) للمهمة. هذا مهم جدًا لـ HTMX لاستهداف هذا العنصر المحدد للتحديثات أو الحذف.</li>
<li><code>class="todo-item-container {% if item.completed %}completed{% endif %}"</code>: يطبق فئة <code>completed</code> إذا كانت المهمة مكتملة، مما يسمح بتصميم مختلف للمهام المكتملة (مثل الخط المشطوب).</li>
<li><code>x-data="{ editing: false, currentTitle: '{{ item.title|escapejs }}' }"</code>:
<ul>
<li>هذه هي بداية سحر Alpine.js! <code>x-data</code> يحدد نطاق مكون Alpine.js لهذا العنصر <code>&lt;li&gt;</code>.</li>
<li><code>editing: false</code>: نعرّف متغير حالة يسمى <code>editing</code> ونضبطه مبدئيًا على <code>false</code>. سيتحكم هذا في ما إذا كنا نعرض المهمة أو نموذج التعديل الخاص بها.</li>
<li><code>currentTitle: '{{ item.title|escapejs }}'</code>: نعرّف متغير حالة آخر <code>currentTitle</code> ونقوم بتهيئته بعنوان المهمة الحالي. <code>|escapejs</code> هو مرشح Django يتأكد من أن العنوان يتم تضمينه بشكل آمن كسلسلة JavaScript (مهم إذا كان العنوان يحتوي على علامات اقتباس أو أحرف خاصة أخرى). سنستخدم هذا لربط البيانات في حقل الإدخال الخاص بالتعديل.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>&lt;!-- Display View --&gt;</code></strong></p>
<ul>
<li><code>&lt;div class="todo-item-display" x-show="!editing"&gt;</code>: هذا <code>div</code> يحتوي على عرض المهمة العادي.
<ul>
<li><code>x-show="!editing"</code>: توجيه Alpine.js. سيتم عرض هذا <code>div</code> فقط عندما يكون متغير <code>editing</code> في <code>x-data</code> هو <code>false</code>.</li>
</ul>
</li>
<li><code>&lt;input type="checkbox" ...&gt;</code>: مربع الاختيار لتبديل حالة الإكمال.
<ul>
<li><code>{% if item.completed %}checked{% endif %}</code>: يضبط مربع الاختيار ليكون محددًا إذا كانت المهمة مكتملة.</li>
<li><code>hx-put="{% url 'todo:toggle' item.pk %}"</code>: عند تغيير مربع الاختيار (النقر عليه)، يرسل HTMX طلب <code>PUT</code> إلى عنوان URL <code>todo:toggle</code> مع <code>pk</code> الخاص بالمهمة.</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code>: يستهدف عنصر <code>&lt;li&gt;</code> الحالي للتحديث.</li>
<li><code>hx-swap="outerHTML"</code>: يستبدل عنصر <code>&lt;li&gt;</code> بأكمله بالاستجابة من الخادم (التي ستكون HTML المحدث لهذا العنصر).</li>
</ul>
</li>
<li><code>&lt;span class="item-title" @click="editing = true"&gt;{{ item.title }}&lt;/span&gt;</code>:
<ul>
<li>يعرض عنوان المهمة.</li>
<li><code>@click="editing = true"</code> (اختصار لـ <code>x-on:click</code>): توجيه Alpine.js. عند النقر على عنوان المهمة، فإنه يضبط متغير <code>editing</code> على <code>true</code>. هذا سيخفي عرض المهمة ويظهر نموذج التعديل (بفضل <code>x-show</code> على كلا القسمين).</li>
</ul>
</li>
<li><code>&lt;div class="actions"&gt; ... &lt;/div&gt;</code>: يحتوي على أزرار الإجراءات.
<ul>
<li><code>&lt;button class="edit-btn" @click="editing = true"&gt;تعديل&lt;/button&gt;</code>: زر "تعديل". عند النقر، يضبط <code>editing = true</code> في Alpine.js، مما يؤدي إلى تبديل العرض إلى نموذج التعديل.</li>
<li><code>&lt;button class="delete-btn" ...&gt;</code>: زر "حذف".
<ul>
<li><code>hx-delete="{% url 'todo:delete' item.pk %}"</code>: يرسل طلب <code>DELETE</code> إلى عنوان URL <code>todo:delete</code>.</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code> و <code>hx-swap="outerHTML"</code>: يستهدف عنصر <code>&lt;li&gt;</code> الحالي ويستبدله (عادةً ما تعني استجابة فارغة من الخادم لـ DELETE أن HTMX سيزيل العنصر).</li>
<li><code>hx-confirm="هل أنت متأكد أنك تريد حذف هذه المهمة؟"</code>: يعرض مربع حوار تأكيد للمستخدم قبل إرسال طلب الحذف.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>&lt;!-- Edit Form View (initially hidden by Alpine.js) --&gt;</code></strong></p>
<ul>
<li><code>&lt;div class="todo-item-edit-form" x-show="editing" x-cloak&gt;</code>: هذا <code>div</code> يحتوي على نموذج التعديل المضمّن.
<ul>
<li><code>x-show="editing"</code>: سيتم عرض هذا <code>div</code> فقط عندما يكون متغير <code>editing</code> هو <code>true</code>.</li>
<li><code>x-cloak</code>: توجيه Alpine.js يساعد على منع "وميض المحتوى غير المصمم" (FOUC). العناصر التي تحتوي على <code>x-cloak</code> تكون مخفية بواسطة CSS (<code>[x-cloak] { display: none !important; }</code> - يجب إضافته إلى CSS العام الخاص بك أو <code>base.html</code>) حتى يقوم Alpine.js بتهيئتها وإزالة السمة.</li>
</ul>
</li>
<li><code>&lt;form ...&gt;</code>: نموذج التعديل.
<ul>
<li><code>style="display: flex; width: 100%;"</code>: بعض الأنماط المضمنة لجعل النموذج يمتد عبر العرض المتاح.</li>
<li><code>hx-put="{% url 'todo:update' item.pk %}"</code>: عند إرسال هذا النموذج، يرسل HTMX طلب <code>PUT</code> إلى عنوان URL <code>todo:update</code> لتحديث المهمة.</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code> و <code>hx-swap="outerHTML"</code>: يستهدف عنصر <code>&lt;li&gt;</code> الحالي ويستبدله بالاستجابة (التي ستكون عرض المهمة المحدث).</li>
<li><code>@submit.prevent="editing = false; htmx.process(htmx.closest(event.target, 'form'))"</code>:
<ul>
<li><code>@submit.prevent</code>: معالج أحداث Alpine.js. <code>.prevent</code> يمنع سلوك إرسال النموذج الافتراضي (الذي قد يتسبب في إعادة تحميل الصفحة).</li>
<li><code>editing = false;</code>: بعد إرسال النموذج (الذي يتم التعامل معه بواسطة HTMX)، نعيد متغير <code>editing</code> إلى <code>false</code> في Alpine.js. هذا يضمن أنه إذا فشل طلب HTMX لسبب ما ولم يتم استبدال المحتوى، فإننا لا نبقى عالقين في وضع التعديل.</li>
<li><code>htmx.process(htmx.closest(event.target, 'form'))</code>: هذا جزء مهم. نظرًا لأننا منعنا الإرسال الافتراضي للنموذج، نحتاج إلى إخبار HTMX يدويًا بمعالجة هذا النموذج. <code>htmx.closest(event.target, 'form')</code> يجد عنصر النموذج، و <code>htmx.process()</code> يطلب من HTMX البحث عن سمات <code>hx-*</code> عليه وتنفيذ الطلب.</li>
</ul>
</li>
</ul>
</li>
<li><code>&lt;input type="text" name="title" x-model="currentTitle" ...&gt;</code>: حقل الإدخال لتعديل العنوان.
<ul>
<li><code>name="title"</code>: اسم الحقل الذي سيتم إرساله إلى الخادم.</li>
<li><code>x-model="currentTitle"</code>: توجيه Alpine.js لربط البيانات ثنائي الاتجاه. قيمة هذا الحقل مرتبطة بمتغير <code>currentTitle</code> في <code>x-data</code>. أي تغييرات في الحقل ستحدّث <code>currentTitle</code>، وأي تغييرات برمجية في <code>currentTitle</code> ستحدّث الحقل.</li>
<li><code>x-ref="editField"</code>: يعطي هذا الحقل اسم مرجع <code>editField</code> في Alpine. يمكن استخدامه للوصول إلى عنصر DOM هذا برمجيًا (على سبيل المثال، للتركيز عليه عند الدخول في وضع التعديل، وهو ما لم نقم به هنا ولكن يمكن إضافته باستخدام <code>x-init</code> أو عند تغيير <code>editing</code>).</li>
<li><code>@keydown.escape="editing = false"</code>: إذا ضغط المستخدم على مفتاح <code>Escape</code> أثناء التركيز على هذا الحقل، فإنه يعيد <code>editing</code> إلى <code>false</code>، ويلغي وضع التعديل.</li>
</ul>
</li>
<li><code>&lt;div class="actions"&gt; ... &lt;/div&gt;</code>: أزرار الحفظ والإلغاء.
<ul>
<li><code>&lt;button type="submit" class="save-btn"&gt;حفظ&lt;/button&gt;</code>: زر إرسال النموذج.</li>
<li><code>&lt;button type="button" @click="editing = false" class="cancel-btn"&gt;إلغاء&lt;/button&gt;</code>: زر "إلغاء". عند النقر، يضبط <code>editing = false</code>، ويعود إلى عرض المهمة دون إرسال أي شيء إلى الخادم. <code>type="button"</code> مهم لمنع هذا الزر من إرسال النموذج.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>&lt;span class="htmx-indicator"&gt;🔄&lt;/span&gt;</code>: مؤشر تحميل خاص بهذا العنصر، سيظهر أثناء طلبات HTMX التي تستهدف هذا العنصر <code>&lt;li&gt;</code>.</p>
</li>
</ol>
<p>هذا القالب الجزئي هو مثال ممتاز على كيفية دمج Django (لتوفير البيانات الأولية وعناوين URL)، و HTMX (للتفاعلات مع الخادم)، و Alpine.js (لإدارة حالة واجهة المستخدم من جانب العميل) لإنشاء مكون تفاعلي غني.</p>
<p><em><code>todo/templates/todo/partials/todo_item_form.html</code></em>:
(هذا القالب مخصص لنموذج التعديل <em>إذا</em> قررنا جلبه بشكل منفصل عبر <code>hx-get</code> بدلاً من تضمينه مباشرة في <code>todo_item_display.html</code> وإظهاره/إخفائه بـ Alpine.js. للنهج الحالي حيث يتم تضمين نموذج التعديل وإدارته بواسطة Alpine.js داخل <code>todo_item_display.html</code>، قد لا يكون هذا الملف ضروريًا أو سيحتوي فقط على جزء النموذج من <code>todo_item_display.html</code>.)</p>
<p>للحفاظ على البساطة الأولية والتركيز على Alpine.js لتبديل الحالة، سنعتمد على نموذج التعديل المضمّن داخل <code>todo_item_display.html</code>. إذا كنت تفضل جلب نموذج التعديل ديناميكيًا عند النقر على "تعديل" (مما قد يكون مفيدًا إذا كان النموذج معقدًا أو نادر الاستخدام)، فستقوم بإنشاء <code>todo_item_form.html</code> وتعديل <code>todo_item_display.html</code> لاستخدام <code>hx-get</code> لجلبه.</p>
<p><strong>7. العروض (<code>todo/views.py</code>):</strong></p>
<p>هنا حيث يحدث منطق Django. سنقوم بإنشاء عروض للتعامل مع كل إجراء.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> get_object_or_404
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token punctuation">,</span> HttpResponseRedirect
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>http <span class="token keyword">import</span> require_http_methods

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> TodoItem
<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> TodoItemForm

<span class="token keyword">def</span> <span class="token function">todo_list_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handles displaying the list of to-do items and the form to add new items.
    For HTMX POST requests (adding an item), it returns only the new item's HTML.
    """</span>
    add_form <span class="token operator">=</span> TodoItemForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    todo_items <span class="token operator">=</span> TodoItem<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Fetches all items, ordered by Meta class</span>
    
    context <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'todo_items'</span><span class="token punctuation">:</span> todo_items<span class="token punctuation">,</span>
        <span class="token string">'add_form'</span><span class="token punctuation">:</span> add_form<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/todo_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">add_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handles POST requests to add a new to-do item.
    Returns an HTML fragment of the new item for HTMX, or redirects on non-HTMX.
    """</span>
    form <span class="token operator">=</span> TodoItemForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
            <span class="token comment"># If it's an HTMX request, return the partial for the new item</span>
            <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment"># For non-HTMX, redirect to the list (traditional form handling)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># If form is not valid</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># For HTMX, re-render the add_todo_form with errors</span>
        <span class="token comment"># This assumes your add_todo_form.html can display form.errors</span>
        <span class="token comment"># Or, you might return a specific error message partial</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/add_todo_form.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">422</span><span class="token punctuation">)</span> <span class="token comment"># 422 Unprocessable Entity</span>
    
    <span class="token comment"># For non-HTMX, re-render the whole list page with the invalid form</span>
    todo_items <span class="token operator">=</span> TodoItem<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'todo_items'</span><span class="token punctuation">:</span> todo_items<span class="token punctuation">,</span>
        <span class="token string">'add_form'</span><span class="token punctuation">:</span> form<span class="token punctuation">,</span> <span class="token comment"># Pass the invalid form back</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/todo_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">422</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"PUT"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">toggle_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handles PUT requests to toggle the 'completed' status of a to-do item.
    Returns an HTML fragment of the updated item for HTMX.
    """</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>completed <span class="token operator">=</span> <span class="token keyword">not</span> item<span class="token punctuation">.</span>completed
    item<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Fallback for non-HTMX</span>

<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"PUT"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">update_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handles PUT requests to update the title of a to-do item (from inline edit).
    Returns an HTML fragment of the updated item for HTMX.
    """</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    <span class="token comment"># HTMX PUT requests don't populate request.POST like forms do.</span>
    <span class="token comment"># We need to parse the request body. For simple key-value data like 'title=new title',</span>
    <span class="token comment"># Django's QueryDict can parse it.</span>
    <span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> QueryDict
    put_data <span class="token operator">=</span> QueryDict<span class="token punctuation">(</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    new_title <span class="token operator">=</span> put_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> new_title<span class="token punctuation">:</span>
        item<span class="token punctuation">.</span>title <span class="token operator">=</span> new_title
        item<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Handle error: title was not provided or empty</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
            <span class="token comment"># You could return the edit form again with an error message,</span>
            <span class="token comment"># or the original item display. For simplicity, return original.</span>
            <span class="token comment"># A more robust solution would involve Django forms for validation here too.</span>
            <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span> <span class="token comment"># Bad Request</span>

    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Fallback</span>

<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"DELETE"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">delete_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handles DELETE requests to remove a to-do item.
    Returns an empty response for HTMX (which then removes the element).
    """</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token comment"># Or 204 No Content. HTMX will remove the target.</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Fallback</span>

<span class="token comment"># This view is not strictly needed if the edit form is part of todo_item_display.html</span>
<span class="token comment"># and shown/hidden by Alpine.js. However, if you wanted to fetch the edit form</span>
<span class="token comment"># separately via hx-get, you would use a view like this.</span>
<span class="token comment"># For our current Alpine-driven inline edit, this view might not be used.</span>
<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_edit_form_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handles GET requests to fetch the HTML for an item's edit form.
    This is useful if you want to load the edit form dynamically via hx-get.
    """</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    <span class="token comment"># We don't have a separate form class for editing just the title in this simple example,</span>
    <span class="token comment"># but in a more complex scenario, you might.</span>
    <span class="token comment"># For now, we'll render a partial that assumes it gets 'item'.</span>
    <span class="token comment"># This partial would be 'todo/partials/todo_item_form.html'</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># This assumes todo_item_form.html is designed to take an 'item'</span>
        <span class="token comment"># and render an editable form for its title.</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_form.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Fallback for non-HTMX (though less likely for this specific action)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<p><em>شرح الكود:</em>
دعنا نحلل كل عرض بالتفصيل:</p>
<ol>
<li>
<p><strong><code>todo_list_view(request)</code></strong>:</p>
<ul>
<li><strong>الغرض</strong>: هذا العرض مسؤول عن عرض الصفحة الرئيسية لقائمة المهام. إنه يعالج طلبات <code>GET</code> العادية.</li>
<li><code>add_form = TodoItemForm()</code>: ينشئ مثيلاً فارغًا من <code>TodoItemForm</code> ليتم استخدامه في نموذج "إضافة مهمة" في القالب.</li>
<li><code>todo_items = TodoItem.objects.all()</code>: يجلب جميع كائنات <code>TodoItem</code> من قاعدة البيانات. سيتم استخدام الترتيب الافتراضي المحدد في <code>Meta.ordering</code> للنموذج.</li>
<li><code>context = {...}</code>: ينشئ قاموس سياق لتمرير البيانات إلى القالب.</li>
<li><code>return render(request, 'todo/todo_list.html', context)</code>: يعرض قالب <code>todo_list.html</code> مع السياق المقدم. هذا هو التدفق القياسي لعرض صفحة Django.</li>
</ul>
</li>
<li>
<p><strong><code>add_todo_view(request)</code></strong>:</p>
<ul>
<li><code>@require_http_methods(["POST"])</code>: مُزخرف يضمن أن هذا العرض يستجيب فقط لطلبات <code>POST</code>.</li>
<li><strong>الغرض</strong>: يعالج إرسال نموذج إضافة مهمة جديدة.</li>
<li><code>form = TodoItemForm(request.POST)</code>: ينشئ مثيلاً من <code>TodoItemForm</code> ويملأه بالبيانات المرسلة في الطلب (<code>request.POST</code>).</li>
<li><code>if form.is_valid():</code>: يتحقق مما إذا كانت البيانات المرسلة صالحة وفقًا لقواعد التحقق من الصحة في النموذج.
<ul>
<li><code>item = form.save()</code>: إذا كان النموذج صالحًا، فإنه يحفظ البيانات في قاعدة البيانات، وينشئ كائن <code>TodoItem</code> جديدًا.</li>
<li><code>if request.htmx:</code>: هنا نستخدم السمة <code>request.htmx</code> التي توفرها <code>django-htmx</code>. إذا كان الطلب قادمًا من HTMX:
<ul>
<li><code>return render(request, 'todo/partials/todo_item_display.html', {'item': item})</code>: نعرض فقط القالب الجزئي <code>todo_item_display.html</code> مع كائن المهمة الجديد. هذا هو جزء HTML الذي سيقوم HTMX بإدراجه في الصفحة.</li>
</ul>
</li>
<li><code>return redirect(reverse('todo:list'))</code>: إذا لم يكن طلب HTMX (سلوك احتياطي)، فإنه يعيد توجيه المستخدم إلى عرض قائمة المهام الكاملة.</li>
</ul>
</li>
<li><code>if request.htmx: ... return render(..., status=422)</code>: إذا لم يكن النموذج صالحًا وكان طلب HTMX، فإننا نعيد عرض نموذج الإضافة مع أخطاء التحقق من الصحة. <code>status=422</code> (Unprocessable Entity) هو رمز حالة HTTP مناسب للإشارة إلى أخطاء التحقق من الصحة. يجب أن يكون القالب الجزئي <code>add_todo_form.html</code> قادرًا على عرض هذه الأخطاء (على سبيل المثال، باستخدام <code>{{ form.title.errors }}</code>).</li>
<li><code>else: ... return render(..., status=422)</code>: إذا لم يكن النموذج صالحًا ولم يكن طلب HTMX، فإننا نعيد عرض صفحة القائمة الكاملة مع النموذج غير الصالح وأخطائه.</li>
</ul>
</li>
<li>
<p><strong><code>toggle_todo_view(request, pk)</code></strong>:</p>
<ul>
<li><code>@require_http_methods(["PUT"])</code>: يضمن أن هذا العرض يستجيب فقط لطلبات <code>PUT</code>. HTMX يرسل طلب <code>PUT</code> عند استخدام <code>hx-put</code>.</li>
<li><strong>الغرض</strong>: يعالج تبديل حالة "مكتمل" لمهمة موجودة.</li>
<li><code>item = get_object_or_404(TodoItem, pk=pk)</code>: يجلب كائن <code>TodoItem</code> المحدد بواسطة <code>pk</code> (المفتاح الأساسي) أو يثير خطأ 404 إذا لم يتم العثور عليه.</li>
<li><code>item.completed = not item.completed</code>: يبدل قيمة حقل <code>completed</code>.</li>
<li><code>item.save()</code>: يحفظ التغييرات في قاعدة البيانات.</li>
<li><code>if request.htmx:</code>: إذا كان طلب HTMX:
<ul>
<li><code>return render(request, 'todo/partials/todo_item_display.html', {'item': item})</code>: يعرض القالب الجزئي للمهمة المحدثة. HTMX سيستبدل عنصر المهمة القديم بهذا.</li>
</ul>
</li>
<li><code>return redirect(reverse('todo:list'))</code>: سلوك احتياطي لغير HTMX.</li>
</ul>
</li>
<li>
<p><strong><code>update_todo_view(request, pk)</code></strong>:</p>
<ul>
<li><code>@require_http_methods(["PUT"])</code>: يستجيب لطلبات <code>PUT</code> من نموذج التعديل المضمّن.</li>
<li><strong>الغرض</strong>: يعالج تحديث عنوان مهمة موجودة.</li>
<li><code>item = get_object_or_404(TodoItem, pk=pk)</code>: يجلب المهمة.</li>
<li><code>from django.http import QueryDict; put_data = QueryDict(request.body)</code>: طلبات <code>PUT</code> (و <code>DELETE</code>) لا تملأ <code>request.POST</code> بنفس طريقة <code>POST</code>. يتم إرسال البيانات عادةً في جسم الطلب. إذا كانت البيانات مرسلة كـ <code>application/x-www-form-urlencoded</code> (وهو ما يفعله HTMX افتراضيًا للنماذج)، فيمكننا استخدام <code>QueryDict(request.body)</code> لتحليلها.</li>
<li><code>new_title = put_data.get('title')</code>: نحصل على قيمة <code>title</code> الجديدة من البيانات المحللة.</li>
<li><code>if new_title:</code>: إذا تم توفير عنوان جديد:
<ul>
<li><code>item.title = new_title; item.save()</code>: نحدّث العنوان ونحفظ.</li>
<li><code>if request.htmx: return render(...)</code>: نعرض جزء المهمة المحدث لـ HTMX.</li>
</ul>
</li>
<li><code>else: ... status=400</code>: إذا لم يتم توفير عنوان، فهذا خطأ. نعيد عرض المهمة الأصلية مع رمز حالة 400 (Bad Request). كان من الممكن استخدام نماذج Django هنا أيضًا للتحقق من الصحة بشكل أكثر قوة.</li>
<li><code>return redirect(reverse('todo:list'))</code>: سلوك احتياطي.</li>
</ul>
</li>
<li>
<p><strong><code>delete_todo_view(request, pk)</code></strong>:</p>
<ul>
<li><code>@require_http_methods(["DELETE"])</code>: يستجيب لطلبات <code>DELETE</code>.</li>
<li><strong>الغرض</strong>: يعالج حذف مهمة.</li>
<li><code>item = get_object_or_404(TodoItem, pk=pk)</code>: يجلب المهمة.</li>
<li><code>item.delete()</code>: يحذف المهمة من قاعدة البيانات.</li>
<li><code>if request.htmx:</code>: إذا كان طلب HTMX:
<ul>
<li><code>return HttpResponse(status=200)</code>: نعيد استجابة HTTP فارغة مع رمز حالة 200 (OK) أو 204 (No Content). عندما يتلقى HTMX استجابة 200 أو 204 لطلب <code>DELETE</code> يستهدف عنصرًا ويستخدم <code>hx-swap</code> الذي يتضمن استبدالًا (مثل <code>outerHTML</code>)، فإنه سيزيل العنقلب <code>todo_item_display.html</code>، الذي يعرض مهمة واحدة.</li>
</ul>
</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code>: يستهدف عنصر <code>&lt;li&gt;</code> الذي يحتوي على هذه المهمة.</li>
<li><code>hx-swap="outerHTML"</code>: يستبدل عنصر <code>&lt;li&gt;</code> بأكمله بالاستجابة من الخادم.</li>
<li><code>@submit.prevent="editing = false; htmx.trigger('#todo-item-{{ item.pk }} form', 'submit', {})"</code>:
<ul>
<li><code>@submit.prevent</code>: يمنع الإرسال الافتراضي للنموذج.</li>
<li><code>editing = false;</code>: يعيد حالة Alpine إلى وضع العرض.</li>
<li><code>htmx.trigger(...)</code>: هذا هو الجزء الأساسي. نظرًا لأننا منعنا الإرسال الافتراضي، نحتاج إلى إخبار HTMX يدويًا بمعالجة هذا النموذج.
<ul>
<li><code>htmx.trigger('#todo-item-{{ item.pk }} form', 'submit', {})</code>: يستهدف النموذج داخل عنصر المهمة الحالي ويطلق حدث <code>submit</code> عليه برمجيًا. هذا سيجعل HTMX يعالج سمات <code>hx-*</code> الموجودة على النموذج.</li>
</ul>
</li>
</ul>
</li>
<li><code>&lt;input type="text" name="title" x-model="currentTitle" ...&gt;</code>: حقل الإدخال لعنوان المهمة.
<ul>
<li><code>x-model="currentTitle"</code>: ربط ثنائي الاتجاه مع خاصية <code>currentTitle</code> في <code>x-data</code>.</li>
<li><code>x-ref="editField"</code>: يسمح بالوصول إلى هذا العنصر من خلال <code>this.$refs.editField</code> في Alpine.</li>
<li><code>@keydown.escape.prevent="editing = false; currentTitle = '{{ item.title|escapejs }}'"</code>: عند الضغط على <code>Escape</code>، يخرج من وضع التعديل ويعيد <code>currentTitle</code> إلى القيمة الأصلية (قبل أي تعديلات غير محفوظة). <code>.prevent</code> يمنع أي سلوك افتراضي لمفتاح Escape.</li>
<li><code>@focus="$event.target.select()"</code>: عند التركيز على الحقل، يحدد النص الموجود فيه بالكامل.</li>
</ul>
</li>
<li><code>&lt;button type="submit" ...&gt;حفظ&lt;/button&gt;</code>: زر الحفظ. <code>type="submit"</code> سيؤدي إلى تشغيل حدث <code>@submit</code> على النموذج.</li>
<li><code>&lt;button type="button" @click="editing = false; currentTitle = '{{ item.title|escapejs }}'" ...&gt;إلغاء&lt;/button&gt;</code>: زر الإلغاء. يعيد <code>editing</code> إلى <code>false</code> ويعيد <code>currentTitle</code> إلى القيمة الأصلية.</li>
</ul>
</li>
<li>
<p><code>&lt;span class="htmx-indicator"&gt;🔄&lt;/span&gt;</code>: مؤشر تحميل خاص بهذا العنصر، سيظهر أثناء طلبات HTMX التي تستهدف هذا العنصر <code>&lt;li&gt;</code>.</p>
</li>
</ol>
<p>هذا القالب الجزئي هو مثال ممتاز على كيفية دمج Django (لتوفير البيانات الأولية وعناوين URL)، و HTMX (للتفاعلات مع الخادم)، و Alpine.js (لإدارة حالة واجهة المستخدم من جانب العميل) لإنشاء مكون تفاعلي غني.</p>
<p><strong>7. العروض (<code>todo/views.py</code>):</strong></p>
<p>هنا حيث يحدث منطق Django. سنقوم بإنشاء عروض للتعامل مع كل إجراء.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># todo/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> get_object_or_404
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token punctuation">,</span> HttpResponseBadRequest
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>http <span class="token keyword">import</span> require_http_methods
<span class="token keyword">from</span> django<span class="token punctuation">.</span>template<span class="token punctuation">.</span>loader <span class="token keyword">import</span> render_to_string <span class="token comment"># For rendering partials to string</span>

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> TodoItem
<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> TodoItemForm

<span class="token keyword">def</span> <span class="token function">todo_list_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    add_form <span class="token operator">=</span> TodoItemForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    todo_items <span class="token operator">=</span> TodoItem<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    context <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'todo_items'</span><span class="token punctuation">:</span> todo_items<span class="token punctuation">,</span>
        <span class="token string">'add_form'</span><span class="token punctuation">:</span> add_form<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/todo_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">add_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    form <span class="token operator">=</span> TodoItemForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># Re-render the add_todo_form with errors for HTMX</span>
        <span class="token comment"># We need to send back the form with errors.</span>
        <span class="token comment"># The hx-on::after-request on the form will not reset if the request is not successful.</span>
        <span class="token comment"># So, we return the form itself, which will replace the old form.</span>
        <span class="token comment"># Ensure your add_todo_form.html can display form errors.</span>
        <span class="token comment"># For example, add {{ form.title.errors }} or {{ form.non_field_errors }}</span>
        <span class="token comment"># For simplicity, we'll assume the form partial can handle this.</span>
        <span class="token comment"># A 422 status code is appropriate for validation errors.</span>
        response <span class="token operator">=</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/add_todo_form.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span><span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">422</span> <span class="token comment"># Unprocessable Entity</span>
        <span class="token keyword">return</span> response
    
    todo_items <span class="token operator">=</span> TodoItem<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'todo_items'</span><span class="token punctuation">:</span> todo_items<span class="token punctuation">,</span> <span class="token string">'add_form'</span><span class="token punctuation">:</span> form <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/todo_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">422</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"PUT"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">toggle_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>completed <span class="token operator">=</span> <span class="token keyword">not</span> item<span class="token punctuation">.</span>completed
    item<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"PUT"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">update_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    
    <span class="token comment"># For PUT requests with form data, Django doesn't populate request.POST.</span>
    <span class="token comment"># We need to parse request.body if it's x-www-form-urlencoded.</span>
    <span class="token comment"># HTMX sends form data this way for PUT.</span>
    <span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> QueryDict
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>content_type <span class="token operator">==</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">:</span>
        put_data <span class="token operator">=</span> QueryDict<span class="token punctuation">(</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        new_title <span class="token operator">=</span> put_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> new_title<span class="token punctuation">:</span>
            <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
                <span class="token comment"># Return the original item display, effectively canceling the edit visually</span>
                <span class="token comment"># and indicating an error through status code.</span>
                <span class="token comment"># A more robust solution would return the edit form with an error message.</span>
                response <span class="token operator">=</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
                response<span class="token punctuation">[</span><span class="token string">'HX-Retarget'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'#todo-item-</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>pk<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token comment"># Ensure Alpine state is reset by re-rendering</span>
                response<span class="token punctuation">[</span><span class="token string">'HX-Reswap'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'outerHTML'</span>
                <span class="token comment"># It's tricky to show validation errors directly in the inline form this way</span>
                <span class="token comment"># without more complex HTMX/Alpine interaction or returning the form itself.</span>
                <span class="token comment"># For now, we just revert and rely on client-side not submitting empty.</span>
                <span class="token comment"># A better server-side validation would return the form with errors.</span>
                <span class="token keyword">return</span> HttpResponseBadRequest<span class="token punctuation">(</span><span class="token string">"Title cannot be empty."</span><span class="token punctuation">)</span> <span class="token comment"># Or render form with error</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Fallback</span>

        item<span class="token punctuation">.</span>title <span class="token operator">=</span> new_title
        item<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Fallback or handle other content types if necessary</span>
    <span class="token keyword">return</span> HttpResponseBadRequest<span class="token punctuation">(</span><span class="token string">"Invalid request content type or data."</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"DELETE"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">delete_todo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># For DELETE, an empty 200 OK or 204 No Content is fine.</span>
        <span class="token comment"># HTMX will remove the element targeted by hx-target if hx-swap implies replacement.</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># This view is NOT used in the current setup where Alpine handles showing/hiding</span>
<span class="token comment"># the pre-rendered edit form within todo_item_display.html.</span>
<span class="token comment"># It's kept here as an example if one chose to fetch the edit form via hx-get.</span>
<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_edit_form_view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># This would render a dedicated partial for the edit form.</span>
        <span class="token comment"># e.g., 'todo/partials/todo_item_edit_form_content.html'</span>
        <span class="token comment"># which would contain the &lt;form&gt; and &lt;input&gt; for editing.</span>
        <span class="token comment"># For our current Alpine-driven approach, this is not directly used.</span>
        <span class="token comment"># If it were, it would look something like:</span>
        <span class="token comment"># form = TodoItemForm(instance=item) # Pre-populate form</span>
        <span class="token comment"># return render(request, 'todo/partials/just_the_edit_form.html', {'form': form, 'item': item})</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"This endpoint is not used in the current Alpine-based inline edit."</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">501</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'todo:list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p><em>شرح الكود (ملخص التغييرات والتركيز على النقاط الرئيسية):</em></p>
<ol>
<li>
<p><strong><code>add_todo_view</code> (معالجة الأخطاء لـ HTMX)</strong>:</p>
<ul>
<li>إذا لم يكن النموذج (<code>form</code>) صالحًا وكان الطلب من HTMX:
<ul>
<li><code>response = render(request, 'todo/partials/add_todo_form.html', {'form': form})</code>: نعيد عرض القالب الجزئي لنموذج الإضافة نفسه، ولكن هذه المرة مع كائن <code>form</code> الذي يحتوي على الأخطاء.</li>
<li><code>response.status_code = 422</code>: نضبط رمز الحالة على 422 (Unprocessable Entity)، وهو مناسب لأخطاء التحقق من الصحة.</li>
<li><strong>لماذا هذا النهج؟</strong> عندما يفشل التحقق من الصحة، نريد أن نظهر للمستخدم الأخطاء في سياق النموذج الذي قدمه. بإعادة نفس القالب الجزئي للنموذج، يمكن لـ HTMX استبدال النموذج القديم بالجديد الذي يتضمن رسائل الخطأ (بافتراض أن <code>add_todo_form.html</code> تم إعداده لعرض <code>form.errors</code>). هذا يمنع إعادة تحميل الصفحة بالكامل ويحافظ على تجربة المستخدم السلسة.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>update_todo_view</code> (معالجة بيانات PUT والتحقق من الصحة)</strong>:</p>
<ul>
<li><code>from django.http import QueryDict</code>: كما ذكرنا، بيانات <code>PUT</code> تحتاج إلى تحليل من <code>request.body</code>.</li>
<li><code>if request.content_type == 'application/x-www-form-urlencoded'</code>: نتحقق من نوع المحتوى. HTMX يرسل بيانات النموذج بهذه الطريقة.</li>
<li><code>put_data = QueryDict(request.body)</code>: نحلل البيانات.</li>
<li><code>new_title = put_data.get('title', '').strip()</code>: نحصل على العنوان ونزيل أي مسافات بيضاء بادئة/لاحقة.</li>
<li><code>if not new_title:</code>: إذا كان العنوان فارغًا بعد <code>strip()</code>:
<ul>
<li>بالنسبة لـ HTMX، نعيد <code>HttpResponseBadRequest("Title cannot be empty.")</code>. هذا بسيط. حل أكثر قوة قد يعيد عرض نموذج التعديل مع رسالة خطأ، ولكن هذا يتطلب مزيدًا من التنسيق بين HTMX و Alpine.js أو قالب جزئي مخصص لنموذج التعديل مع الأخطاء.</li>
<li><strong>التحدي مع التعديل المضمّن والتحقق من الصحة من جانب الخادم</strong>: عندما يكون نموذج التعديل جزءًا من عرض أكبر تتم إدارته بواسطة Alpine.js، فإن إعادة عرض <em>فقط</em> نموذج التعديل مع الأخطاء من الخادم واستبداله بشكل صحيح دون تعطيل حالة Alpine.js يمكن أن يكون معقدًا. غالبًا ما يتم الاعتماد على التحقق من الصحة من جانب العميل أولاً، ثم التحقق من الصحة من جانب الخادم كشبكة أمان.</li>
</ul>
</li>
<li>إذا كان العنوان صالحًا، يتم حفظ التغييرات وعرض جزء المهمة المحدث.</li>
</ul>
</li>
<li>
<p><strong><code>delete_todo_view</code></strong>:</p>
<ul>
<li><code>return HttpResponse(status=200)</code>: لطلبات <code>DELETE</code> الناجحة عبر HTMX، استجابة فارغة برمز 200 (أو 204) كافية. HTMX سيهتم بإزالة العنصر المستهدف من DOM بناءً على سمات <code>hx-target</code> و <code>hx-swap</code>.</li>
</ul>
</li>
<li>
<p><strong><code>get_edit_form_view</code></strong>:</p>
<ul>
<li>تم توضيح أن هذا العرض <strong>غير مستخدم حاليًا</strong> في النهج الذي نتبعه، حيث يتم تضمين نموذج التعديل مسبقًا في <code>todo_item_display.html</code> ويتم تبديل رؤيته بواسطة Alpine.js.</li>
<li>إذا اخترنا نهجًا مختلفًا حيث يتم جلب نموذج التعديل ديناميكيًا عبر <code>hx-get</code> عند النقر على "تعديل"، فسيكون هذا العرض هو الذي يعيد HTML الخاص بنموذج التعديل.</li>
</ul>
</li>
</ol>
<p><strong>الخلاصة للعروض</strong>:</p>
<ul>
<li>تستخدم العروض <code>request.htmx</code> للتمييز بين الطلبات العادية وطلبات HTMX، مما يسمح لها بإرجاع إما صفحة HTML كاملة أو جزء HTML صغير.</li>
<li>يتم استخدام مُزخرفات مثل <code>@require_http_methods</code> لضمان أن العروض تستجيب فقط لأساليب HTTP المتوقعة.</li>
<li>يتم استخدام <code>get_object_or_404</code> لجلب الكائنات بأمان.</li>
<li>بالنسبة لعمليات <code>PUT</code> و <code>DELETE</code>، يتم التعامل مع بيانات الطلب بشكل مختلف قليلاً عن <code>POST</code>.</li>
<li>تتم معالجة أخطاء التحقق من الصحة بشكل مناسب لكل من طلبات HTMX وغير HTMX.</li>
</ul>
<p><strong>8. التهجير (Migrations):</strong></p>
<p>بعد تعريف النموذج، نحتاج إلى إنشاء وتطبيق التهجيرات لإنشاء جدول قاعدة البيانات المقابل.</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># THIS_CODE_SNIPPET</span>
python manage.py makemigrations todo
python manage.py migrate
</code></pre>
<p><em>شرح الكود:</em></p>
<ol>
<li><code>python manage.py makemigrations todo</code>:
<ul>
<li>يحلل هذا الأمر التغييرات التي أجريتها على نماذجك (في هذه الحالة، إنشاء نموذج <code>TodoItem</code> جديد في تطبيق <code>todo</code>).</li>
<li>يقوم بإنشاء ملف تهجير جديد في دليل <code>todo/migrations/</code>. يحتوي هذا الملف على تعليمات Python تصف كيفية تطبيق هذه التغييرات على مخطط قاعدة البيانات.</li>
</ul>
</li>
<li><code>python manage.py migrate</code>:
<ul>
<li>يطبق هذا الأمر أي تهجيرات لم يتم تطبيقها بعد على قاعدة البيانات.</li>
<li>سيقوم بقراءة ملف التهجير الذي تم إنشاؤه في الخطوة السابقة وتنفيذ أوامر SQL اللازمة لإنشاء جدول <code>todo_todoitem</code> (أو ما يعادله بناءً على إعدادات قاعدة البيانات الخاصة بك) مع الأعمدة التي حددناها.</li>
</ul>
</li>
</ol>
<p>بعد تشغيل هذه الأوامر، سيكون لديك جدول قاعدة بيانات جاهز لتخزين عناصر قائمة المهام الخاصة بك. يمكنك أيضًا إنشاء مستخدم متميز (<code>python manage.py createsuperuser</code>) للوصول إلى لوحة تحكم Django وتجربة إضافة بعض المهام يدويًا إذا أردت.</p>
<p>بهذا، يكون الإعداد الأساسي لـ Django جاهزًا. في القسم التالي، سنقوم بتجميع كل هذه الأجزاء معًا ونرى كيف تعمل HTMX و Alpine.js لإضفاء الحيوية على قائمة المهام.</p>
<h3 id="1324-implementation-walkthrough-display-add-toggle-edit-delete" tabindex="-1"><a class="anchor" href="#1324-implementation-walkthrough-display-add-toggle-edit-delete" name="1324-implementation-walkthrough-display-add-toggle-edit-delete" tabindex="-1"><span class="octicon octicon-link"></span></a>13.2.4 Implementation Walkthrough (Display, Add, Toggle, Edit, Delete)</h3>
<p>الآن بعد أن تم إعداد مكونات Django الأساسية (النماذج، النماذج، العروض، عناوين URL، والقوالب الأولية)، دعنا نتعمق في كيفية عمل كل ميزة من ميزات قائمة المهام التفاعلية، مع التركيز على تكامل HTMX و Alpine.js.</p>
<p><strong>A. عرض قائمة المهام (Displaying To-Do Items)</strong></p>
<ol>
<li>
<p><strong>الطلب الأولي للصفحة:</strong></p>
<ul>
<li>عندما ينتقل المستخدم إلى <code>/todos/</code>، يتم استدعاء <code>todo_list_view</code> في <code>todo/views.py</code>.</li>
<li>يقوم هذا العرض بجلب جميع كائنات <code>TodoItem</code> من قاعدة البيانات وينشئ مثيلاً فارغًا من <code>TodoItemForm</code> (لنموذج الإضافة).</li>
<li>يعرض قالب <code>todo/todo_list.html</code>، ويمرر <code>todo_items</code> و <code>add_form</code> في السياق.</li>
</ul>
</li>
<li>
<p><strong>عرض القالب <code>todo_list.html</code>:</strong></p>
<ul>
<li>يرث هذا القالب من <code>base.html</code> (الذي يتضمن HTMX و Alpine.js).</li>
<li>يتضمن <code>todo/partials/add_todo_form.html</code> لعرض نموذج إضافة المهمة.</li>
<li>يتكرر عبر قائمة <code>todo_items</code>:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- In todo/todo_list.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todo-list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% for item in todo_items %}
        {% include "todo/partials/todo_item_display.html" with item=item %}
    {% empty %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>empty-message<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>لا توجد مهام حتى الآن. قم بإضافة واحدة!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    {% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<em>شرح الكود:</em>
<ol>
<li><code>{% for item in todo_items %}</code>: يبدأ حلقة عبر كل <code>item</code> في قائمة <code>todo_items</code> التي تم تمريرها من العرض.</li>
<li><code>{% include "todo/partials/todo_item_display.html" with item=item %}</code>: لكل <code>item</code>، يتم تضمين القالب الجزئي <code>todo_item_display.html</code>. هذا هو المكان الذي يتم فيه عرض كل مهمة فردية. يتم تمرير كائن <code>item</code> الحالي إلى هذا القالب الجزئي كسياق. هذا يعزز قابلية إعادة الاستخدام ويحافظ على تنظيم القوالب.</li>
<li><code>{% empty %}</code>: إذا كانت <code>todo_items</code> فارغة (لا توجد مهام)، يتم تنفيذ المحتوى داخل هذا الوسم.</li>
<li><code>&lt;li id="empty-message"&gt;...&lt;/li&gt;</code>: يتم عرض رسالة للمستخدم تشير إلى عدم وجود مهام.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>عرض القالب الجزئي <code>todo_item_display.html</code> (لكل مهمة):</strong></p>
<ul>
<li>هذا القالب (الذي ناقشناه بالتفصيل في قسم الإعداد) مسؤول عن عرض مهمة واحدة، بما في ذلك عنوانها، ومربع اختيار الإكمال، وأزرار التعديل/الحذف.</li>
<li>يحتوي على منطق <code>x-data</code> من Alpine.js لإدارة حالة <code>editing</code>.</li>
<li>يحتوي على سمات HTMX على مربع الاختيار وأزرار الحذف والتعديل (على الرغم من أن زر التعديل الفعلي يشغل Alpine.js أولاً).</li>
</ul>
</li>
</ol>
<p><strong>النتيجة:</strong> يرى المستخدم صفحة كاملة مع نموذج لإضافة المهام وقائمة بالمهام الموجودة. كل مهمة جاهزة للتفاعل.</p>
<p><strong>B. إضافة مهمة جديدة (Adding a New To-Do Item)</strong></p>
<ol>
<li>
<p><strong>تفاعل المستخدم:</strong></p>
<ul>
<li>يكتب المستخدم عنوان المهمة في حقل الإدخال داخل <code>add_todo_form.html</code> (المضمن في <code>todo_list.html</code>) وينقر على زر "إضافة مهمة".</li>
</ul>
</li>
<li>
<p><strong>عمل HTMX:</strong></p>
<ul>
<li>يحتوي النموذج في <code>add_todo_form.html</code> على السمات التالية:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- From todo/partials/add_todo_form.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>add-todo-form<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-post</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:add' %}<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-list<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>beforeend<span class="token punctuation">"</span></span>
      <span class="token attr-name"><span class="token namespace">hx-on:</span>:after-request</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>if(event.detail.successful) this.reset()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% csrf_token %}
    {{ form.title }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>إضافة مهمة<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>add-loading-spinner<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>⏳<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<em>شرح الكود (التركيز على تدفق الإضافة):</em>
<ol>
<li><code>hx-post="{% url 'todo:add' %}"</code>: عند إرسال النموذج، يرسل HTMX طلب <code>POST</code> AJAX إلى عنوان URL الذي تم إنشاؤه بواسطة <code>{% url 'todo:add' %}</code> (والذي يشير إلى <code>add_todo_view</code>).</li>
<li><code>hx-target="#todo-list"</code>: يحدد أن استجابة الخادم يجب أن تستهدف العنصر الذي يحمل المعرف <code>todo-list</code> (وهو <code>&lt;ul&gt;</code> في <code>todo_list.html</code>).</li>
<li><code>hx-swap="beforeend"</code>: يخبر HTMX بإلحاق محتوى الاستجابة كآخر ابن للعنصر الهدف.</li>
<li><code>hx-on::after-request="if(event.detail.successful) this.reset()"</code>: بعد اكتمال الطلب بنجاح، يتم استدعاء <code>this.reset()</code> على النموذج، مما يمسح حقل الإدخال.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>معالجة الخادم (<code>add_todo_view</code>):</strong></p>
<ul>
<li>يستقبل <code>add_todo_view</code> طلب <code>POST</code>.</li>
<li>يقوم بإنشاء مثيل <code>TodoItemForm</code> بالبيانات المرسلة (<code>request.POST</code>).</li>
<li>إذا كان النموذج صالحًا (<code>form.is_valid()</code>):
<ul>
<li>يحفظ النموذج (<code>item = form.save()</code>)، مما ينشئ مهمة جديدة في قاعدة البيانات.</li>
<li>نظرًا لأن هذا طلب HTMX (<code>request.htmx</code> يكون <code>True</code> بفضل <code>django-htmx</code> أو إعداد CSRF اليدوي الذي يضيف ترويسات HTMX)، فإنه يعرض القالب الجزئي <code>todo/partials/todo_item_display.html</code> مع كائن <code>item</code> الجديد كسياق.<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># In todo/views.py, inside add_todo_view</span>
<span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># If it's an HTMX request, return the partial for the new item</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># ... (fallback for non-HTMX) ...</span>
</code></pre>
</li>
</ul>
</li>
<li>إذا لم يكن النموذج صالحًا وكان طلب HTMX، فإنه يعيد عرض <code>add_todo_form.html</code> مع أخطاء النموذج ورمز الحالة 422.</li>
</ul>
</li>
<li>
<p><strong>تحديث DOM بواسطة HTMX:</strong></p>
<ul>
<li>يتلقى HTMX في المتصفح جزء HTML للمهمة الجديدة (من <code>todo_item_display.html</code>).</li>
<li>بسبب <code>hx-target="#todo-list"</code> و <code>hx-swap="beforeend"</code>، يقوم HTMX بإلحاق هذا الجزء الجديد بـ <code>&lt;ul&gt;</code> الذي يحمل المعرف <code>todo-list</code>.</li>
<li>يتم مسح حقل الإدخال في نموذج الإضافة بسبب <code>hx-on::after-request</code>.</li>
</ul>
</li>
</ol>
<p><strong>النتيجة:</strong> تظهر المهمة الجديدة في القائمة دون إعادة تحميل الصفحة. يتم مسح نموذج الإضافة، جاهزًا لإدخال مهمة أخرى. إذا كانت هناك أخطاء في التحقق من الصحة، يتم تحديث نموذج الإضافة لعرضها.</p>
<p><strong>C. تبديل حالة الإكمال (Toggling Completion Status)</strong></p>
<ol>
<li>
<p><strong>تفاعل المستخدم:</strong></p>
<ul>
<li>ينقر المستخدم على مربع الاختيار بجوار مهمة في القائمة.</li>
</ul>
</li>
<li>
<p><strong>عمل HTMX:</strong></p>
<ul>
<li>يحتوي مربع الاختيار في <code>todo_item_display.html</code> على السمات التالية:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- From todo/partials/todo_item_display.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span>
       <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-completed-toggle<span class="token punctuation">"</span></span>
       <span class="token attr-name">{%</span> <span class="token attr-name">if</span> <span class="token attr-name">item.completed</span> <span class="token attr-name">%}checked{%</span> <span class="token attr-name">endif</span> <span class="token attr-name">%}</span>
       <span class="token attr-name">hx-put</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:toggle' item.pk %}<span class="token punctuation">"</span></span>
       <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
       <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
</code></pre>
<em>شرح الكود (التركيز على تدفق التبديل):</em>
<ol>
<li><code>hx-put="{% url 'todo:toggle' item.pk %}"</code>: عند تغيير حالة مربع الاختيار (عادةً عند النقر)، يرسل HTMX طلب <code>PUT</code> AJAX إلى عنوان URL <code>todo:toggle</code> مع المفتاح الأساسي (<code>pk</code>) للمهمة.</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code>: يستهدف عنصر <code>&lt;li&gt;</code> الذي يغلف هذه المهمة المحددة.</li>
<li><code>hx-swap="outerHTML"</code>: يخبر HTMX باستبدال عنصر <code>&lt;li&gt;</code> بأكمله (بما في ذلك مربع الاختيار، العنوان، الأزرار) بالاستجابة من الخادم.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>معالجة الخادم (<code>toggle_todo_view</code>):</strong></p>
<ul>
<li>يستقبل <code>toggle_todo_view</code> طلب <code>PUT</code> مع <code>pk</code> للمهمة.</li>
<li>يجلب المهمة (<code>item = get_object_or_404(TodoItem, pk=pk)</code>).</li>
<li>يبدل حالة <code>item.completed</code> (<code>item.completed = not item.completed</code>).</li>
<li>يحفظ التغيير (<code>item.save()</code>).</li>
<li>نظرًا لأنه طلب HTMX، فإنه يعرض القالب الجزئي <code>todo/partials/todo_item_display.html</code> مع كائن <code>item</code> المحدث.<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># In todo/views.py, inside toggle_todo_view</span>
item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
item<span class="token punctuation">.</span>completed <span class="token operator">=</span> <span class="token keyword">not</span> item<span class="token punctuation">.</span>completed
item<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># ... (fallback for non-HTMX) ...</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>تحديث DOM بواسطة HTMX:</strong></p>
<ul>
<li>يتلقى HTMX جزء HTML للمهمة المحدثة.</li>
<li>بسبب <code>hx-target</code> و <code>hx-swap="outerHTML"</code>، يتم استبدال عنصر <code>&lt;li&gt;</code> القديم بالكامل بالجديد. هذا يضمن تحديث كل شيء بشكل صحيح (مثل فئة <code>completed</code> على <code>&lt;li&gt;</code>، حالة مربع الاختيار، وتصميم العنوان إذا تغير).</li>
</ul>
</li>
</ol>
<p><strong>النتيجة:</strong> يتم تحديث مظهر المهمة (على سبيل المثال، يظهر خط مشطوب على العنوان إذا اكتملت) دون إعادة تحميل الصفحة.</p>
<p><strong>D. تعديل مهمة مضمّن (Inline Editing a To-Do Item)</strong></p>
<p>هذه هي الميزة الأكثر تعقيدًا لأنها تتضمن كلاً من Alpine.js (لإدارة حالة واجهة المستخدم من جانب العميل) و HTMX (لإرسال التغييرات إلى الخادم).</p>
<p><strong>المرحلة 1: الدخول في وضع التعديل (Alpine.js)</strong></p>
<ol>
<li>
<p><strong>تفاعل المستخدم:</strong></p>
<ul>
<li>ينقر المستخدم على زر "تعديل" بجوار مهمة، أو على عنوان المهمة نفسه.</li>
</ul>
</li>
<li>
<p><strong>عمل Alpine.js:</strong></p>
<ul>
<li>
<p>يحتوي عنصر <code>&lt;li&gt;</code> في <code>todo_item_display.html</code> على <code>x-data="{ editing: false, currentTitle: '{{ item.title|escapejs }}' }"</code>.</p>
</li>
<li>
<p>زر "تعديل" وعنوان المهمة (<code>&lt;span&gt;</code>) لهما <code>@click="editing = true"</code>:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- From todo/partials/todo_item_display.html (Display View part) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-title<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = true; $nextTick(() =&gt; { $refs.editField.focus(); })<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ item.title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>edit-btn<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = true; $nextTick(() =&gt; { $refs.editField.focus(); })<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>تعديل<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><em>شرح الكود (التركيز على Alpine.js):</em></p>
<ol>
<li><code>@click="editing = true; $nextTick(() =&gt; { $refs.editField.focus(); })"</code>: عند النقر، يتم تنفيذ كود JavaScript هذا بواسطة Alpine.js.
<ul>
<li><code>editing = true</code>: يتم تغيير متغير الحالة <code>editing</code> داخل نطاق <code>x-data</code> الخاص بهذا العنصر <code>&lt;li&gt;</code> إلى <code>true</code>.</li>
<li><code>$nextTick(() =&gt; { $refs.editField.focus(); })</code>: هذا جزء مهم لتحسين تجربة المستخدم.
<ul>
<li><code>$nextTick(...)</code>: يضمن Alpine.js أن الكود الموجود بداخله يتم تنفيذه <em>بعد</em> أن يقوم DOM بتحديث نفسه بناءً على تغييرات الحالة (مثل إظهار نموذج التعديل).</li>
<li><code>$refs.editField.focus()</code>: <code>editField</code> هو الاسم الذي أعطيناه لحقل الإدخال في نموذج التعديل باستخدام <code>x-ref="editField"</code>. <code>$refs</code> هو كائن "سحري" في Alpine.js يسمح بالوصول إلى عناصر DOM المسماة بـ <code>x-ref</code>. <code>focus()</code> يضع تركيز المؤشر في حقل الإدخال، مما يسمح للمستخدم بالبدء في الكتابة فورًا.</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>بسبب تغيير <code>editing</code> إلى <code>true</code>:</p>
<ul>
<li><code>div</code> العرض (<code>&lt;div class="todo-item-display" x-show="!editing"&gt;</code>) يصبح مخفيًا.</li>
<li><code>div</code> نموذج التعديل (<code>&lt;div class="todo-item-edit-form" x-show="editing"&gt;</code>) يصبح مرئيًا.</li>
<li>يتم ربط حقل الإدخال في نموذج التعديل (<code>&lt;input type="text" x-model="currentTitle"&gt;</code>) بمتغير <code>currentTitle</code> في <code>x-data</code>. نظرًا لأن <code>currentTitle</code> تم تهيئته بعنوان المهمة، فإن حقل الإدخال يظهر مع النص الحالي للمهمة.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>النتيجة (المرحلة 1):</strong> يتم استبدال عرض المهمة بنموذج تعديل مضمّن يحتوي على عنوان المهمة الحالي، وحقل الإدخال مركز عليه. كل هذا يحدث بالكامل في المتصفح بفضل Alpine.js، دون أي طلب للخادم.</p>
<p><strong>المرحلة 2: إرسال التعديلات (HTMX)</strong></p>
<ol>
<li>
<p><strong>تفاعل المستخدم:</strong></p>
<ul>
<li>يعدل المستخدم النص في حقل الإدخال. بفضل <code>x-model="currentTitle"</code>، يتم تحديث متغير <code>currentTitle</code> في Alpine.js تلقائيًا مع كل ضغطة مفتاح.</li>
<li>ينقر المستخدم على زر "حفظ".</li>
</ul>
</li>
<li>
<p><strong>عمل HTMX (مُشغل بواسطة Alpine.js):</strong></p>
<ul>
<li>يحتوي نموذج التعديل في <code>todo_item_display.html</code> على:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- From todo/partials/todo_item_display.html (Edit Form View part) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>
      <span class="token attr-name">hx-put</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:update' item.pk %}<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span>
      <span class="token attr-name">@submit.prevent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = false; htmx.trigger(event.target, 'submit', {})<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">x-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>currentTitle<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> 
           <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>تعديل عنوان المهمة<span class="token punctuation">"</span></span> <span class="token attr-name">x-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editField<span class="token punctuation">"</span></span> 
           <span class="token attr-name">@keydown.escape.prevent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = false; currentTitle = '{{ item.title|escapejs }}'<span class="token punctuation">"</span></span>
           <span class="token attr-name">@focus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$event.target.select()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>save-btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>حفظ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- ... زر الإلغاء ... --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<em>شرح الكود (التركيز على إرسال HTMX):</em>
<ol>
<li><code>@submit.prevent="editing = false; htmx.trigger(event.target, 'submit', {})"</code>: هذا هو معالج حدث الإرسال في Alpine.js.
<ul>
<li><code>.prevent</code>: يمنع سلوك إرسال النموذج الافتراضي (الذي قد يتسبب في إعادة تحميل الصفحة).</li>
<li><code>editing = false;</code>: يعيد حالة Alpine إلى وضع العرض <em>قبل</em> إرسال طلب HTMX. هذا اختياري، ولكن يمكن أن يوفر شعورًا أسرع بالاستجابة.</li>
<li><code>htmx.trigger(event.target, 'submit', {})</code>: هذا هو الجزء الأساسي. <code>event.target</code> هنا هو النموذج نفسه. <code>htmx.trigger</code> يطلب من HTMX البحث عن سمات <code>hx-*</code> على هذا النموذج (الهدف) وتشغيل حدث <code>submit</code> عليه برمجيًا. هذا سيجعل HTMX ينفذ طلب <code>hx-put</code>.</li>
</ul>
</li>
<li><code>hx-put="{% url 'todo:update' item.pk %}"</code>: يرسل HTMX طلب <code>PUT</code> إلى <code>update_todo_view</code> مع <code>pk</code> للمهمة. سيتم إرسال بيانات النموذج (التي تتضمن <code>title</code> من حقل الإدخال المرتبط بـ <code>x-model="currentTitle"</code>) في جسم الطلب.</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code> و <code>hx-swap="outerHTML"</code>: كما في السابق، يستهدف عنصر <code>&lt;li&gt;</code> بأكمله ويستبدله بالاستجابة.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>معالجة الخادم (<code>update_todo_view</code>):</strong></p>
<ul>
<li>يستقبل <code>update_todo_view</code> طلب <code>PUT</code>.</li>
<li>يحلل <code>request.body</code> للحصول على <code>new_title</code> (كما هو موضح في قسم العروض).</li>
<li>إذا كان <code>new_title</code> صالحًا، فإنه يحدّث <code>item.title</code> ويحفظه.</li>
<li>يعرض القالب الجزئي <code>todo/partials/todo_item_display.html</code> مع كائن <code>item</code> المحدث. هذا الجزء سيعرض المهمة في وضع العرض العادي (لأن <code>editing</code> في <code>x-data</code> الجديد سيكون <code>false</code> افتراضيًا عند إعادة العرض).<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># In todo/views.py, inside update_todo_view</span>
<span class="token comment"># ... (parsing new_title) ...</span>
<span class="token keyword">if</span> new_title<span class="token punctuation">:</span>
    item<span class="token punctuation">.</span>title <span class="token operator">=</span> new_title
    item<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'todo/partials/todo_item_display.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># ... (error handling and fallback) ...</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>تحديث DOM بواسطة HTMX:</strong></p>
<ul>
<li>يتلقى HTMX جزء HTML للمهمة المحدثة (في وضع العرض).</li>
<li>يستبدل عنصر <code>&lt;li&gt;</code> القديم (الذي كان يعرض نموذج التعديل) بالجديد.</li>
</ul>
</li>
</ol>
<p><strong>النتيجة (المرحلة 2):</strong> يتم إرسال العنوان المعدل إلى الخادم، ويتم تحديث قاعدة البيانات، ويتم استبدال نموذج التعديل في واجهة المستخدم بعرض المهمة المحدث، كل ذلك دون إعادة تحميل الصفحة.</p>
<p><strong>المرحلة 3: إلغاء التعديل (Alpine.js)</strong></p>
<ol>
<li>
<p><strong>تفاعل المستخدم:</strong></p>
<ul>
<li>ينقر المستخدم على زر "إلغاء" في نموذج التعديل المضمّن.</li>
</ul>
</li>
<li>
<p><strong>عمل Alpine.js:</strong></p>
<ul>
<li>يحتوي زر "إلغاء" على:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- From todo/partials/todo_item_display.html (Edit Form View part) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>editing = false; currentTitle = '{{ item.title|escapejs }}'<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cancel-btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>إلغاء<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<em>شرح الكود (التركيز على الإلغاء):</em>
<ol>
<li><code>@click="editing = false; currentTitle = '{{ item.title|escapejs }}'"</code>:
<ul>
<li><code>editing = false</code>: يعيد متغير الحالة <code>editing</code> إلى <code>false</code>. هذا سيخفي نموذج التعديل ويظهر عرض المهمة العادي.</li>
<li><code>currentTitle = '{{ item.title|escapejs }}'</code>: <strong>مهم جدًا</strong>: يعيد متغير <code>currentTitle</code> (الذي قد يكون المستخدم قد غيره في حقل الإدخال) إلى القيمة الأصلية لعنوان المهمة. هذا يضمن أنه إذا دخل المستخدم في وضع التعديل مرة أخرى، فإنه يرى العنوان الأصلي، وليس أي تغييرات غير محفوظة.</li>
</ul>
</li>
<li><code>type="button"</code>: يمنع هذا الزر من إرسال النموذج.</li>
</ol>
</li>
</ul>
</li>
</ol>
<p><strong>النتيجة (المرحلة 3):</strong> يتم إخفاء نموذج التعديل، ويظهر عرض المهمة العادي، ويتم تجاهل أي تغييرات تم إجراؤها في حقل الإدخال. كل هذا يحدث بالكامل في المتصفح.</p>
<p><strong>E. حذف مهمة (Deleting a To-Do Item)</strong></p>
<ol>
<li>
<p><strong>تفاعل المستخدم:</strong></p>
<ul>
<li>ينقر المستخدم على زر "حذف" بجوار مهمة.</li>
</ul>
</li>
<li>
<p><strong>عمل HTMX:</strong></p>
<ul>
<li>يحتوي زر "حذف" في <code>todo_item_display.html</code> على:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- From todo/partials/todo_item_display.html (Display View part) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>delete-btn<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-delete</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'todo:delete' item.pk %}<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#todo-item-{{ item.pk }}<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-confirm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>هل أنت متأكد أنك تريد حذف هذه المهمة؟<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>حذف<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<em>شرح الكود (التركيز على الحذف):</em>
<ol>
<li><code>hx-confirm="هل أنت متأكد أنك تريد حذف هذه المهمة؟"</code>: قبل إرسال الطلب، يعرض HTMX مربع حوار تأكيد للمستخدم. إذا نقر المستخدم على "إلغاء"، لا يتم إرسال الطلب.</li>
<li><code>hx-delete="{% url 'todo:delete' item.pk %}"</code>: إذا أكد المستخدم، يرسل HTMX طلب <code>DELETE</code> AJAX إلى <code>delete_todo_view</code> مع <code>pk</code> للمهمة.</li>
<li><code>hx-target="#todo-item-{{ item.pk }}"</code>: يستهدف عنصر <code>&lt;li&gt;</code> الذي يغلف هذه المهمة.</li>
<li><code>hx-swap="outerHTML"</code>: يخبر HTMX باستبدال هذا العنصر بالاستجابة.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>معالجة الخادم (<code>delete_todo_view</code>):</strong></p>
<ul>
<li>يستقبل <code>delete_todo_view</code> طلب <code>DELETE</code>.</li>
<li>يجلب المهمة ويحذفها (<code>item.delete()</code>).</li>
<li>نظرًا لأنه طلب HTMX، فإنه يعيد استجابة HTTP فارغة برمز حالة 200 (أو 204 No Content).<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># In todo/views.py, inside delete_todo_view</span>
item <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>TodoItem<span class="token punctuation">,</span> pk<span class="token operator">=</span>pk<span class="token punctuation">)</span>
item<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span> 
<span class="token comment"># ... (fallback for non-HTMX) ...</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>تحديث DOM بواسطة HTMX:</strong></p>
<ul>
<li>يتلقى HTMX استجابة 200 OK (أو 204).</li>
<li>نظرًا لأن <code>hx-swap="outerHTML"</code> يشير إلى استبدال، وعندما تكون الاستجابة فارغة أو 204، فإن HTMX يزيل العنصر المستهدف (<code>#todo-item-{{ item.pk }}</code>) من DOM.</li>
</ul>
</li>
</ol>
<p><strong>النتيجة:</strong> تختفي المهمة من القائمة دون إعادة تحميل الصفحة.</p>
<p><strong>ملخص التدفق التفاعلي:</strong>
لقد رأينا كيف يمكن لـ Django و HTMX و Alpine.js العمل معًا:</p>
<ul>
<li><strong>Django</strong> يوفر الواجهة الخلفية، ومنطق الأعمال، وعرض HTML الأولي والأجزاء.</li>
<li><strong>HTMX</strong> يعالج الاتصال غير المتزامن مع الخادم، ويجلب أجزاء HTML، ويحدّث DOM بذكاء.</li>
<li><strong>Alpine.js</strong> يدير حالات واجهة المستخدم من جانب العميل (مثل وضع التعديل) والتفاعلات التي لا تتطلب بالضرورة رحلة ذهابًا وإيابًا إلى الخادم، مما يجعل الواجهة الأمامية أكثر استجابة.</li>
</ul>
<p>هذا المشروع يضع الأساس لفهم الأنماط الأكثر تقدمًا التي سنستكشفها لاحقًا. إنه يوضح قوة هذا المزيج في بناء تطبيقات ويب حديثة وتفاعلية مع الحفاظ على بساطة تطوير Django التقليدية.</p>
<h2 id="133-project-2-live-search-and-filterable-product-catalog" tabindex="-1"><a class="anchor" href="#133-project-2-live-search-and-filterable-product-catalog" name="133-project-2-live-search-and-filterable-product-catalog" tabindex="-1"><span class="octicon octicon-link"></span></a>13.3 Project 2: Live Search and Filterable Product Catalog</h2>
<p>In this project, we'll build a common and highly practical feature for many web applications: a product catalog page that allows users to search, filter, and paginate through a list of products dynamically. The key is that all these interactions will happen without full page reloads, providing a smooth and responsive user experience, powered by Django on the backend, HTMX for server interactions, and a touch of Alpine.js for client-side state management of our filter controls.</p>
<p>This project will solidify your understanding of how these technologies can be harmoniously integrated to create modern, reactive user interfaces while keeping the backend logic clean and manageable within Django.</p>
<h3 id="1331-concept--goals-live-search-dynamic-filtering-htmx-pagination" tabindex="-1"><a class="anchor" href="#1331-concept--goals-live-search-dynamic-filtering-htmx-pagination" name="1331-concept--goals-live-search-dynamic-filtering-htmx-pagination" tabindex="-1"><span class="octicon octicon-link"></span></a>13.3.1 Concept &amp; Goals (Live Search, Dynamic Filtering, HTMX Pagination)</h3>
<p><strong>Concept:</strong>
Imagine an e-commerce site or any catalog-style listing. Users expect to find what they're looking for quickly. Our project will be a single page displaying a list of products. This page will feature:</p>
<ol>
<li>A search bar.</li>
<li>A set of filters (e.g., by product category).</li>
<li>A paginated list of products.</li>
</ol>
<p>The core idea is that interacting with any of these elements (typing in the search bar, checking a filter category, clicking a pagination link) will update the product list <em>in place</em>, fetching only the necessary HTML fragment from the server.</p>
<p><strong>Goals:</strong>
Our primary objectives for this project are:</p>
<ol>
<li><strong>Live Search:</strong> As the user types into the search input field, the product list should automatically update to reflect the search query. This update should be debounced to avoid excessive requests (e.g., only send a request after the user pauses typing for a short period).</li>
<li><strong>Dynamic Filtering:</strong> Users will be able to select filter options (e.g., product categories via checkboxes). Applying or removing a filter should instantly update the product list. Multiple filters should work in conjunction with each other and with the search query.</li>
<li><strong>HTMX-driven Pagination:</strong> When the product list spans multiple pages, users should be able to navigate to different pages without a full page refresh. Pagination links will fetch and display the relevant slice of products.</li>
<li><strong>URL Updates for Sharability and History:</strong> Critically, as the user searches, filters, and paginates, the browser's URL must update to reflect the current state of the product list (e.g., <code>.../products/?search=widget&amp;category=electronics&amp;page=2</code>). This ensures that users can bookmark their current view, share the URL with others, and use the browser's back/forward buttons effectively.</li>
<li><strong>Clear Indication of Activity:</strong> Visual feedback (e.g., a loading indicator) should be provided while data is being fetched from the server.</li>
<li><strong>Maintainable Code Structure:</strong> We aim for a clean separation of concerns, with Django handling data processing and HTML generation (both full pages and partials), HTMX managing the AJAX requests and DOM updates, and Alpine.js optionally enhancing client-side form state.</li>
</ol>
<p>By achieving these goals, we'll demonstrate a powerful pattern for building interactive data displays that feel fast and modern.</p>
<h3 id="1332-key-technologies-demonstrated-django-querysets-htmx-gethx-triggerhx-push-url-alpine-state-for-filters" tabindex="-1"><a class="anchor" href="#1332-key-technologies-demonstrated-django-querysets-htmx-gethx-triggerhx-push-url-alpine-state-for-filters" name="1332-key-technologies-demonstrated-django-querysets-htmx-gethx-triggerhx-push-url-alpine-state-for-filters" tabindex="-1"><span class="octicon octicon-link"></span></a>13.3.2 Key Technologies Demonstrated (Django QuerySets, HTMX GET/<code>hx-trigger</code>/<code>hx-push-url</code>, Alpine State for Filters)</h3>
<p>To bring our live search and filterable product catalog to life, we'll leverage the strengths of several key technologies:</p>
<ol>
<li>
<p><strong>Django QuerySets:</strong></p>
<ul>
<li><strong>Why:</strong> Django's Object-Relational Mapper (ORM) provides a powerful and Pythonic way to interact with the database. QuerySets are lazy, meaning they don't hit the database until evaluated, allowing us to build complex queries step-by-step.</li>
<li><strong>How:</strong> We'll use QuerySet methods like <code>filter()</code> (with field lookups like <code>__icontains</code> for case-insensitive search, <code>__in</code> for multiple category selections), <code>order_by()</code>, and slicing for pagination. Django's <code>Paginator</code> class will be used for managing paged results.</li>
<li><strong>Foundation:</strong> This relies on well-defined Django models for <code>Product</code> and <code>Category</code>.</li>
</ul>
</li>
<li>
<p><strong>HTMX for Server Communication and DOM Manipulation:</strong></p>
<ul>
<li><strong><code>hx-get</code>:</strong>
<ul>
<li><strong>Why:</strong> To fetch updated product lists from the server using HTTP GET requests. GET is appropriate here as these operations are idempotent (safe to repeat) and primarily for retrieving data.</li>
<li><strong>How:</strong> Applied to search inputs, filter checkboxes, and pagination links. The value will be the URL of our Django view that serves the product list.</li>
</ul>
</li>
<li><strong><code>hx-trigger</code>:</strong>
<ul>
<li><strong>Why:</strong> To control <em>when</em> HTMX requests are made. This allows for "live" updates without explicit submit buttons.</li>
<li><strong>How:</strong>
<ul>
<li>For the search input: <code>keyup changed delay:500ms</code> (triggers on key release, but only if the value changed, and after a 500ms pause).</li>
<li>For filter checkboxes: <code>change</code> (triggers when a checkbox is checked or unchecked).</li>
<li>For pagination links: Default behavior (click).</li>
<li>We might also use a trigger on a wrapping form like <code>submit, change from:input[type='checkbox'], keyup changed delay:500ms from:input[name='search']</code> to consolidate event handling.</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>hx-target</code>:</strong>
<ul>
<li><strong>Why:</strong> To specify which part of the DOM should be updated with the HTML response from the server.</li>
<li><strong>How:</strong> This will point to a <code>div</code> element that wraps our product list and pagination controls.</li>
</ul>
</li>
<li><strong><code>hx-swap</code>:</strong>
<ul>
<li><strong>Why:</strong> To define <em>how</em> the target element's content is replaced.</li>
<li><strong>How:</strong> Typically <code>innerHTML</code> to replace the content of the product list container. We could also use <code>outerHTML</code> if the container itself needs to be replaced with attributes that might change.</li>
</ul>
</li>
<li><strong><code>hx-push-url="true"</code>:</strong>
<ul>
<li><strong>Why:</strong> This is crucial for user experience and web fundamentals. It updates the browser's URL in the address bar to match the GET request made by HTMX, without a full page reload. This enables bookmarking, sharing, and proper back/forward button functionality (HTMX listens for <code>popstate</code> events and re-requests the content for that URL).</li>
<li><strong>How:</strong> Added to the elements that trigger HTMX GET requests.</li>
</ul>
</li>
<li><strong><code>hx-indicator</code>:</strong>
<ul>
<li><strong>Why:</strong> To provide visual feedback to the user that a request is in progress.</li>
<li><strong>How:</strong> Points to an element (e.g., a spinner) that HTMX will show/hide during the request lifecycle.</li>
</ul>
</li>
<li><strong><code>hx-include</code> (or form serialization):</strong>
<ul>
<li><strong>Why:</strong> When an HTMX request is triggered by one input (e.g., search), we need to ensure that the values of other active filters (e.g., selected categories) are also sent in the request.</li>
<li><strong>How:</strong> We can use <code>hx-include</code> to specify other elements whose values should be included. A common and often cleaner approach is to wrap all filter controls in a <code>&lt;form&gt;</code> tag. HTMX attributes on the form itself (or on a submit trigger) will automatically serialize all input values within that form. If individual inputs trigger requests, <code>hx-include</code> can point to <code>closest form</code> or specific selectors for other inputs.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Alpine.js for Client-Side State (Optional Enhancement):</strong></p>
<ul>
<li><strong><code>x-data</code>:</strong>
<ul>
<li><strong>Why:</strong> To declare a new Alpine component scope and define its reactive data properties. This is useful for managing the state of filter inputs (e.g., the current search query, an array of selected category IDs) directly in the HTML.</li>
<li><strong>How:</strong> Applied to a container element wrapping the filter controls.</li>
</ul>
</li>
<li><strong><code>x-model</code>:</strong>
<ul>
<li><strong>Why:</strong> For two-way data binding between Alpine state properties and form input values. This simplifies keeping the JavaScript state and the visual input synchronized.</li>
<li><strong>How:</strong> Used on search inputs (<code>&lt;input type="text" x-model="searchQuery"&gt;</code>) and filter checkboxes (<code>&lt;input type="checkbox" x-model="selectedCategories" value="categoryId"&gt;</code>).</li>
</ul>
</li>
<li><strong><code>x-init</code>:</strong>
<ul>
<li><strong>Why:</strong> To run JavaScript code when an Alpine component is initialized. Useful for setting initial filter states from Django-rendered values (e.g., query parameters from the URL).</li>
</ul>
</li>
<li><strong>Event Handling (<code>@change</code>, <code>@input</code>, etc.):</strong>
<ul>
<li><strong>Why:</strong> While HTMX handles the server requests, Alpine can manage purely client-side interactions or prepare data before an HTMX request.</li>
<li><strong>How:</strong> In our chosen approach, Alpine's <code>x-model</code> will update the input values, and HTMX (listening on the form or inputs) will pick up these fresh values when it makes a request. This is a clean separation: Alpine for input state, HTMX for server comms.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Synergy:</strong>
Django serves as the robust backend, managing data persistence and business logic. It renders the initial page and also serves HTML partials in response to HTMX requests. HTMX acts as the bridge, making AJAX calls, handling server responses, and updating the DOM without writing verbose JavaScript. Alpine.js sprinkles in client-side reactivity, particularly for managing the state of the filter controls in a declarative way, ensuring that the data HTMX sends to the server is always current with the user's interactions. This combination allows for a highly interactive experience with minimal custom JavaScript.</p>
<h3 id="1333-core-django-setup" tabindex="-1"><a class="anchor" href="#1333-core-django-setup" name="1333-core-django-setup" tabindex="-1"><span class="octicon octicon-link"></span></a>13.3.3 Core Django Setup</h3>
<p>Before we dive into the HTMX and Alpine.js magic, let's lay the foundation with our Django models, views, templates, and URL configuration.</p>
<p><strong>1. Models (<code>models.py</code>)</strong></p>
<p>We'll need at least two models: <code>Category</code> and <code>Product</code>.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># products/models.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token keyword">class</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    slug <span class="token operator">=</span> models<span class="token punctuation">.</span>SlugField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> help_text<span class="token operator">=</span><span class="token string">"URL-friendly version of the name"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        verbose_name_plural <span class="token operator">=</span> <span class="token string">"Categories"</span>
        ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    description <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> models<span class="token punctuation">.</span>DecimalField<span class="token punctuation">(</span>max_digits<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> decimal_places<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    category <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Category<span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>SET_NULL<span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'product_images/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># Optional</span>
    available <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    updated_at <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>name

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'-created_at'</span><span class="token punctuation">]</span>
</code></pre>
<p>Let's examine this code in detail:</p>
<ol>
<li>
<p><strong><code>Category</code> Model:</strong></p>
<ul>
<li><code>name</code>: A <code>CharField</code> to store the category name (e.g., "Electronics", "Books"). It's marked <code>unique=True</code> to prevent duplicate category names.</li>
<li><code>slug</code>: A <code>SlugField</code> for creating SEO-friendly URLs. It's also <code>unique=True</code>. We'd typically auto-populate this from the name in a <code>save()</code> method or using a signal, or rely on <code>prepopulated_fields</code> in the admin.</li>
<li><code>__str__</code>: Returns the category name for a human-readable representation.</li>
<li><code>Meta.verbose_name_plural</code>: Sets the plural name in the Django admin.</li>
<li><code>Meta.ordering</code>: Default ordering for categories.</li>
</ul>
</li>
<li>
<p><strong><code>Product</code> Model:</strong></p>
<ul>
<li><code>name</code>, <code>description</code>, <code>price</code>: Standard fields for product information.</li>
<li><code>category</code>: A <code>ForeignKey</code> to the <code>Category</code> model, establishing a one-to-many relationship (one category can have many products).
<ul>
<li><code>related_name='products'</code>: Allows us to access products from a category instance (e.g., <code>category.products.all()</code>).</li>
<li><code>on_delete=models.SET_NULL</code>: If a category is deleted, products in that category will have their <code>category</code> field set to <code>NULL</code> (requires <code>null=True</code>). This prevents accidental deletion of products if a category is removed.</li>
<li><code>null=True, blank=True</code>: Allows products to not have a category.</li>
</ul>
</li>
<li><code>image</code>: An optional <code>ImageField</code> for product images. Requires Pillow to be installed and <code>MEDIA_ROOT</code> / <code>MEDIA_URL</code> configured.</li>
<li><code>available</code>: A <code>BooleanField</code> to mark if the product is currently available for sale.</li>
<li><code>created_at</code>, <code>updated_at</code>: Timestamps for when the record was created and last updated.</li>
<li><code>__str__</code>: Returns the product name.</li>
<li><code>Meta.ordering</code>: Default ordering for products (newest first).</li>
</ul>
</li>
</ol>
<p><strong>Important:</strong> After defining or changing models, remember to create and run migrations:
<code>python manage.py makemigrations products</code>
<code>python manage.py migrate</code></p>
<p><strong>2. Views (<code>views.py</code>)</strong></p>
<p>We'll create a single view to handle both the initial page load and subsequent HTMX requests for filtering and pagination.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># products/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>paginator <span class="token keyword">import</span> Paginator<span class="token punctuation">,</span> EmptyPage<span class="token punctuation">,</span> PageNotAnInteger
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Product<span class="token punctuation">,</span> Category
<span class="token keyword">import</span> json <span class="token comment"># For passing JSON to Alpine.js</span>

<span class="token keyword">def</span> <span class="token function">product_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    products_qs <span class="token operator">=</span> Product<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>available<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    all_categories <span class="token operator">=</span> Category<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Search</span>
    search_query <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> search_query<span class="token punctuation">:</span>
        products_qs <span class="token operator">=</span> products_qs<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name__icontains<span class="token operator">=</span>search_query<span class="token punctuation">)</span>

    <span class="token comment"># Category filtering</span>
    category_ids <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'category'</span><span class="token punctuation">)</span> <span class="token comment"># Gets list of category IDs</span>
    <span class="token comment"># Convert to integers for safety, though Django ORM often handles string IDs for __in lookups</span>
    valid_category_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> category_ids<span class="token punctuation">:</span>
        <span class="token keyword">for</span> cat_id <span class="token keyword">in</span> category_ids<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                valid_category_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>cat_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
                <span class="token keyword">pass</span> <span class="token comment"># Ignore invalid category IDs</span>
        <span class="token keyword">if</span> valid_category_ids<span class="token punctuation">:</span>
            products_qs <span class="token operator">=</span> products_qs<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>category__id__in<span class="token operator">=</span>valid_category_ids<span class="token punctuation">)</span>

    <span class="token comment"># Pagination</span>
    paginator <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>products_qs<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment"># Show 9 products per page</span>
    page_number <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        products_page <span class="token operator">=</span> paginator<span class="token punctuation">.</span>page<span class="token punctuation">(</span>page_number<span class="token punctuation">)</span>
    <span class="token keyword">except</span> PageNotAnInteger<span class="token punctuation">:</span>
        <span class="token comment"># If page is not an integer, deliver first page.</span>
        products_page <span class="token operator">=</span> paginator<span class="token punctuation">.</span>page<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> EmptyPage<span class="token punctuation">:</span>
        <span class="token comment"># If page is out of range (e.g. 9999), deliver last page of results.</span>
        products_page <span class="token operator">=</span> paginator<span class="token punctuation">.</span>page<span class="token punctuation">(</span>paginator<span class="token punctuation">.</span>num_pages<span class="token punctuation">)</span>

    <span class="token comment"># For Alpine.js initial state: convert selected category IDs to JSON</span>
    <span class="token comment"># This helps initialize x-model for checkboxes correctly.</span>
    current_category_ids_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>valid_category_ids<span class="token punctuation">)</span>
    
    <span class="token comment"># For Alpine.js to know all category names (e.g., for displaying filter summary)</span>
    all_categories_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>all_categories<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


    context <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'products'</span><span class="token punctuation">:</span> products_page<span class="token punctuation">,</span>
        <span class="token string">'all_categories'</span><span class="token punctuation">:</span> all_categories<span class="token punctuation">,</span>
        <span class="token string">'current_category_ids'</span><span class="token punctuation">:</span> valid_category_ids<span class="token punctuation">,</span> <span class="token comment"># For Django template conditional checks</span>
        <span class="token string">'current_category_ids_json'</span><span class="token punctuation">:</span> current_category_ids_json<span class="token punctuation">,</span> <span class="token comment"># For Alpine</span>
        <span class="token string">'all_categories_json'</span><span class="token punctuation">:</span> all_categories_json<span class="token punctuation">,</span> <span class="token comment"># For Alpine</span>
        <span class="token string">'search_query'</span><span class="token punctuation">:</span> search_query<span class="token punctuation">,</span> <span class="token comment"># To pre-fill search input</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># If it's an HTMX request, render only the partial template</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'products/_product_list_partial.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    
    <span class="token comment"># Otherwise, render the full page</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'products/product_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>

</code></pre>
<p>Let's break down this view:</p>
<ol>
<li><strong>Imports:</strong> Standard Django <code>render</code>, pagination utilities, and our models. <code>json</code> is imported for serializing data for Alpine.js.</li>
<li><strong>Initial QuerySet:</strong> <code>products_qs = Product.objects.filter(available=True)</code> starts by fetching all available products. We build upon this QuerySet.</li>
<li><strong>Fetch All Categories:</strong> <code>all_categories = Category.objects.all()</code> gets all categories for display in the filter sidebar.</li>
<li><strong>Search Logic:</strong>
<ul>
<li><code>search_query = request.GET.get('search', '')</code>: Retrieves the search term from the URL query parameters.</li>
<li><code>if search_query: products_qs = products_qs.filter(name__icontains=search_query)</code>: If a search term exists, it filters the <code>products_qs</code> by name (case-insensitive containment).</li>
</ul>
</li>
<li><strong>Category Filtering Logic:</strong>
<ul>
<li><code>category_ids = request.GET.getlist('category')</code>: Retrieves a list of selected category IDs. <code>getlist</code> is used because checkboxes with the same <code>name</code> attribute submit multiple values.</li>
<li><code>valid_category_ids</code>: We create a list to store integer versions of these IDs for safety, though the ORM is often flexible.</li>
<li><code>if valid_category_ids: products_qs = products_qs.filter(category__id__in=valid_category_ids)</code>: Filters products belonging to any of the selected categories.</li>
</ul>
</li>
<li><strong>Pagination Logic:</strong>
<ul>
<li><code>paginator = Paginator(products_qs, 9)</code>: Creates a <code>Paginator</code> object for the filtered QuerySet, with 9 items per page.</li>
<li><code>page_number = request.GET.get('page')</code>: Gets the requested page number.</li>
<li>The <code>try-except</code> block handles cases where the page number is invalid or out of range, defaulting to the first or last page respectively.</li>
</ul>
</li>
<li><strong>Data for Alpine.js:</strong>
<ul>
<li><code>current_category_ids_json = json.dumps(valid_category_ids)</code>: Converts the list of currently selected category IDs into a JSON string. This is useful for initializing Alpine's <code>x-data</code> if you're using <code>x-model</code> on checkboxes.</li>
<li><code>all_categories_json = json.dumps(list(all_categories.values('id', 'name')))</code>: Provides a JSON array of all categories (ID and name) for Alpine to use, perhaps for displaying a summary of selected filters.</li>
</ul>
</li>
<li><strong>Context Preparation:</strong> All necessary data (products for the current page, all categories, current filter values) is assembled into a <code>context</code> dictionary.</li>
<li><strong>HTMX Request Handling:</strong>
<ul>
<li><code>if request.htmx:</code>: This is a key part. <code>request.htmx</code> is a boolean attribute added by the <code>django-htmx</code> library (or you can check for the <code>HTTP_HX_REQUEST</code> header manually). It's <code>True</code> if the request was made by HTMX.</li>
<li><code>return render(request, 'products/_product_list_partial.html', context)</code>: If it's an HTMX request, we render <em>only</em> the partial template (<code>_product_list_partial.html</code>), which contains just the product list and pagination. This is efficient as we only send the updated fragment.</li>
</ul>
</li>
<li><strong>Full Page Render:</strong>
<ul>
<li><code>return render(request, 'products/product_list.html', context)</code>: If it's a normal browser request (not HTMX), we render the full <code>product_list.html</code> template.</li>
</ul>
</li>
</ol>
<p><strong>3. Templates</strong></p>
<p>We need two main templates: one for the full page (<code>product_list.html</code>) and one for the partial updates (<code>_product_list_partial.html</code>).</p>
<p><strong><code>products/templates/products/product_list.html</code> (Main Page Template):</strong></p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
{% load static %}
{% load product_tags %} <span class="token comment">&lt;!-- We'll create this for query string manipulation --&gt;</span>

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Our Products<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% static 'css/styles.css' %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- Your project's CSS --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/htmx.org@1.9.10<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
        <span class="token comment">/* Basic styling for layout and indicators */</span>
        <span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #f4f4f4<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.container</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">gap</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">max-width</span><span class="token punctuation">:</span> 1200px<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.filters</span> <span class="token punctuation">{</span> <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span> <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 10px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token property">min-width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span> <span class="token property">align-self</span><span class="token punctuation">:</span> flex-start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.filters h4</span> <span class="token punctuation">{</span> <span class="token property">margin-top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.filters label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.products-area</span> <span class="token punctuation">{</span> <span class="token property">flex-grow</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">#product-list-container .product-grid</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> grid<span class="token punctuation">;</span> <span class="token property">grid-template-columns</span><span class="token punctuation">:</span> <span class="token function">repeat</span><span class="token punctuation">(</span>auto-fill<span class="token punctuation">,</span> <span class="token function">minmax</span><span class="token punctuation">(</span>250px<span class="token punctuation">,</span> 1fr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token property">gap</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.product-card</span> <span class="token punctuation">{</span> <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ddd<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.05<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.product-card img</span> <span class="token punctuation">{</span> <span class="token property">max-width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 150px<span class="token punctuation">;</span> <span class="token property">object-fit</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token comment">/* Shown by HTMX during request */</span> <span class="token punctuation">}</span>
        <span class="token selector">.htmx-request .htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span> <span class="token comment">/* Or block, depending on spinner type */</span> <span class="token punctuation">}</span>
        <span class="token selector">.htmx-request.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* For indicators that are the element itself */</span>
        <span class="token selector">#loading-spinner</span> <span class="token punctuation">{</span> <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> dodgerblue<span class="token punctuation">;</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.pagination</span> <span class="token punctuation">{</span> <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.pagination a, .pagination span</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 5px 10px<span class="token punctuation">;</span> <span class="token property">text-decoration</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ddd<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.pagination .current</span> <span class="token punctuation">{</span> <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> dodgerblue<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span> <span class="token property">border-color</span><span class="token punctuation">:</span> dodgerblue<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Our Awesome Products<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span> <span class="token attr-name">x-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{
        searchQuery: '{{ search_query|escapejs }}',
        selectedCategories: {{ current_category_ids_json|safe }}
    }<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>aside</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>filters<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>filter-form<span class="token punctuation">"</span></span>
                  <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'product_list' %}<span class="token punctuation">"</span></span>
                  <span class="token attr-name">hx-trigger</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit, change from:input[type='checkbox'], keyup changed delay:500ms from:input[name='search']<span class="token punctuation">"</span></span>
                  <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#product-list-container<span class="token punctuation">"</span></span>
                  <span class="token attr-name">hx-indicator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#loading-spinner<span class="token punctuation">"</span></span>
                  <span class="token attr-name">hx-push-url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>Search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Search products...<span class="token punctuation">"</span></span>
                       <span class="token attr-name">x-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>searchQuery<span class="token punctuation">"</span></span>
                       <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control mb-2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>Categories<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
                {% for category in all_categories %}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>category<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{{ category.id }}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">x-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectedCategories<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        {{ category.name }}
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                {% endfor %}
                <span class="token comment">&lt;!-- A hidden submit button is not strictly necessary if triggers are on inputs/form events --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>aside</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>products-area<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>loading-spinner<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Loading...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>product-list-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                {% include "products/_product_list_partial.html" %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token comment">// Ensure HTMX handles Django's CSRF token</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'htmx:configRequest'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-CSRFToken'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'{{ csrf_token }}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Explanation of <code>product_list.html</code>:</p>
<ol>
<li><strong>Load Statics &amp; Custom Tags:</strong> <code>{% load static %}</code> for CSS/JS files, and <code>{% load product_tags %}</code> for a custom template tag we'll create later for pagination URLs.</li>
<li><strong>HTMX and Alpine.js:</strong> Included via CDN for simplicity. In a production setup, you'd manage these as static files.</li>
<li><strong>Basic Styling:</strong> Inline <code>&lt;style&gt;</code> block for a quick visual structure. In a real project, this would be in a separate CSS file.</li>
<li><strong>Alpine.js <code>x-data</code>:</strong>
<ul>
<li>The main container <code>div.container</code> is initialized with <code>x-data</code>.</li>
<li><code>searchQuery: '{{ search_query|escapejs }}'</code>: Initializes Alpine's <code>searchQuery</code> state with the current search query from the Django context (passed by the view). <code>escapejs</code> is important for safety.</li>
<li><code>selectedCategories: {{ current_category_ids_json|safe }}</code>: Initializes Alpine's <code>selectedCategories</code> array with the JSON string of selected category IDs from the Django context. <code>safe</code> is used because <code>json.dumps</code> already produces safe JSON.</li>
</ul>
</li>
<li><strong>Filter Form (<code>&lt;form id="filter-form"&gt;</code>):</strong>
<ul>
<li>This form groups all our filter controls.</li>
<li><strong><code>hx-get="{% url 'product_list' %}"</code></strong>: Specifies the URL to send GET requests to.</li>
<li><strong><code>hx-trigger="submit, change from:input[type='checkbox'], keyup changed delay:500ms from:input[name='search']"</code></strong>: This is a powerful multi-trigger setup:
<ul>
<li><code>submit</code>: Standard form submission (though we might not have an explicit submit button).</li>
<li><code>change from:input[type='checkbox']</code>: Triggers when any checkbox inside the form changes state.</li>
<li><code>keyup changed delay:500ms from:input[name='search']</code>: Triggers when the user types in the search input (debounced).</li>
<li>The <code>from:</code> modifier scopes the event listener to specific children within the element having the <code>hx-trigger</code> attribute (the form, in this case).</li>
</ul>
</li>
<li><strong><code>hx-target="#product-list-container"</code></strong>: The HTML response will replace the content of the <code>div</code> with ID <code>product-list-container</code>.</li>
<li><strong><code>hx-indicator="#loading-spinner"</code></strong>: Shows the element with ID <code>loading-spinner</code> during the request.</li>
<li><strong><code>hx-push-url="true"</code></strong>: Updates the browser URL after the request.</li>
</ul>
</li>
<li><strong>Search Input:</strong>
<ul>
<li><code>name="search"</code>: So its value is included in form serialization.</li>
<li><code>x-model="searchQuery"</code>: Two-way binding with Alpine's <code>searchQuery</code> state.</li>
</ul>
</li>
<li><strong>Category Checkboxes:</strong>
<ul>
<li>Looped from <code>all_categories</code> passed by the view.</li>
<li><code>name="category"</code> and <code>value="{{ category.id }}"</code>: Standard for checkbox groups.</li>
<li><code>x-model="selectedCategories"</code>: Binds the checked state of these checkboxes to Alpine's <code>selectedCategories</code> array. Alpine handles adding/removing the <code>value</code> from the array based on checked status.</li>
</ul>
</li>
<li><strong>Loading Indicator:</strong> <code>&lt;span id="loading-spinner" class="htmx-indicator"&gt;Loading...&lt;/span&gt;</code>. HTMX will manage its visibility based on the <code>htmx-request</code> class being added to the requesting element or via the <code>hx-indicator</code> attribute.</li>
<li><strong>Product List Container:</strong> <code>&lt;div id="product-list-container"&gt;</code>. This is the crucial <code>hx-target</code>.
<ul>
<li><code>{% include "products/_product_list_partial.html" %}</code>: On initial page load, this includes the partial template, which renders the initial set of products and pagination.</li>
</ul>
</li>
<li><strong>CSRF Token for HTMX:</strong> The script at the bottom ensures that HTMX POST/PUT/DELETE requests (though we primarily use GET here) include Django's CSRF token. This is good practice.</li>
</ol>
<p><strong><code>products/templates/products/_product_list_partial.html</code> (Partial Template):</strong></p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
{% load product_tags %} <span class="token comment">&lt;!-- For the query string helper --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>product-grid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% for product in products %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>product-card<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% if product.image %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{{ product.image.url }}<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{{ product.name }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% else %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://via.placeholder.com/250x150.png?text=No+Image<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>No image available<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% endif %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>{{ product.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Category: {{ product.category.name|default:"N/A" }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Price: ${{ product.price }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    {% empty %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>No products found matching your criteria.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    {% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

{% if products.has_other_pages %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pagination<span class="token punctuation">"</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Product navigation<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">list-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
        {% if products.has_previous %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=products.previous_page_number %}<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=products.previous_page_number %}<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#product-list-container<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-push-url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-indicator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#loading-spinner<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token entity named-entity" title="«">&amp;laquo;</span> Previous
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        {% else %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>disabled<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="«">&amp;laquo;</span> Previous<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        {% endif %}

        {% for i in products.paginator.page_range %}
            {% if products.number == i %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>current<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ i }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            {% else %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=i %}<span class="token punctuation">"</span></span>
                   <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=i %}<span class="token punctuation">"</span></span>
                   <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#product-list-container<span class="token punctuation">"</span></span>
                   <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span>
                   <span class="token attr-name">hx-push-url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
                   <span class="token attr-name">hx-indicator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#loading-spinner<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    {{ i }}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            {% endif %}
        {% endfor %}

        {% if products.has_next %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=products.next_page_number %}<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=products.next_page_number %}<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#product-list-container<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-push-url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
               <span class="token attr-name">hx-indicator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#loading-spinner<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                Next <span class="token entity named-entity" title="»">&amp;raquo;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        {% else %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 0 5px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>disabled<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Next <span class="token entity named-entity" title="»">&amp;raquo;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        {% endif %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
{% endif %}
</code></pre>
<p>Explanation of <code>_product_list_partial.html</code>:</p>
<ol>
<li><strong>Product Grid:</strong> Iterates through the <code>products</code> (which is a <code>Page</code> object from the paginator) and displays each product's details in a card. Includes a placeholder if no image is available.</li>
<li><strong>Empty State:</strong> If no products match the criteria, a "No products found" message is shown.</li>
<li><strong>Pagination Controls:</strong>
<ul>
<li>Displayed only if <code>products.has_other_pages</code> is true.</li>
<li>Uses Django's pagination object (<code>products</code>) attributes like <code>has_previous</code>, <code>previous_page_number</code>, <code>page_range</code>, <code>number</code> (current page), <code>has_next</code>, <code>next_page_number</code>.</li>
<li><strong>Crucially, each pagination link (<code>&lt;a&gt;</code> tag):</strong>
<ul>
<li><code>href="?{% query_string page=... %}"</code>: The <code>href</code> is constructed using a custom template tag <code>query_string</code> (we'll define this next). This tag ensures that existing filter parameters (like search query and category selections) are preserved when navigating pages.</li>
<li><code>hx-get</code>, <code>hx-target</code>, <code>hx-swap</code>, <code>hx-push-url</code>, <code>hx-indicator</code>: These HTMX attributes make the pagination links behave like other dynamic elements, fetching content and updating the <code>#product-list-container</code> without a full reload. The URL for <code>hx-get</code> is also built with <code>query_string</code>.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>4. Custom Template Tag (<code>templatetags/product_tags.py</code>)</strong></p>
<p>This tag is essential for building correct pagination URLs that preserve existing filters.</p>
<p>Create <code>products/templatetags/</code> directory (if it doesn't exist) and add <code>__init__.py</code> (empty file) to make it a Python package. Then create <code>product_tags.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># products/templatetags/product_tags.py</span>
<span class="token keyword">from</span> django <span class="token keyword">import</span> template

register <span class="token operator">=</span> template<span class="token punctuation">.</span>Library<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>simple_tag</span><span class="token punctuation">(</span>takes_context<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">query_string</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Updates or adds query parameters to the current URL's query string.
    Preserves existing query parameters unless explicitly overridden by kwargs.
    Example: {% query_string page=products.next_page_number search_term=None %}
    If current URL is /search/?type=book and you pass author='tolkien',
    it returns 'type=book&amp;author=tolkien'.
    If you pass type='movie', it returns 'type=movie'.
    If you pass type=None, it returns ''.
    """</span>
    query_params <span class="token operator">=</span> context<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>GET<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Get a mutable copy of current GET params</span>
    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span> <span class="token comment"># If value is None or empty string, remove key</span>
            query_params<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            query_params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment"># Set or update key with new value</span>
    <span class="token keyword">return</span> query_params<span class="token punctuation">.</span>urlencode<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Explanation of <code>query_string</code> templatetag:</p>
<ol>
<li><strong><code>register = template.Library()</code></strong>: Standard boilerplate for custom template tags.</li>
<li><strong><code>@register.simple_tag(takes_context=True)</code></strong>: Decorator to register the function as a simple tag. <code>takes_context=True</code> allows the tag to access the current request object from the template context.</li>
<li><strong><code>def query_string(context, **kwargs):</code></strong>:
<ul>
<li><code>context</code>: The template context, containing <code>request</code>.</li>
<li><code>**kwargs</code>: Accepts keyword arguments, which will be the query parameters to add or modify (e.g., <code>page=3</code>).</li>
</ul>
</li>
<li><strong><code>query_params = context['request'].GET.copy()</code></strong>: Gets a mutable copy of the current request's GET parameters. This is vital for preserving existing filters.</li>
<li><strong>Loop through <code>kwargs</code>:</strong>
<ul>
<li>If a <code>value</code> passed in <code>kwargs</code> is <code>None</code> or an empty string, the corresponding <code>key</code> is removed from <code>query_params</code>. This allows clearing a parameter (e.g., <code>{% query_string search=None %}</code>).</li>
<li>Otherwise, the <code>key</code> in <code>query_params</code> is set or updated with the new <code>value</code>.</li>
</ul>
</li>
<li><strong><code>return query_params.urlencode()</code></strong>: Returns the modified query parameters as a URL-encoded string (e.g., <code>search=widget&amp;category=1&amp;page=2</code>).</li>
</ol>
<p>Remember to restart your Django development server after adding new template tags so Django can discover them.</p>
<p><strong>5. URLs (<code>urls.py</code>)</strong></p>
<p>Define a URL pattern for the <code>product_list</code> view.</p>
<p><strong><code>products/urls.py</code> (app-level):</strong></p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># products/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

app_name <span class="token operator">=</span> <span class="token string">'products'</span>

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>product_list<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'product_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre>
<p><strong>Project-level <code>urls.py</code>:</strong></p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># project/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings <span class="token comment"># For media files</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls<span class="token punctuation">.</span>static <span class="token keyword">import</span> static <span class="token comment"># For media files</span>

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'products/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'products.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># ... other app urls</span>
<span class="token punctuation">]</span>

<span class="token comment"># Serve media files during development</span>
<span class="token keyword">if</span> settings<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>
    urlpatterns <span class="token operator">+=</span> static<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>MEDIA_URL<span class="token punctuation">,</span> document_root<span class="token operator">=</span>settings<span class="token punctuation">.</span>MEDIA_ROOT<span class="token punctuation">)</span>
</code></pre>
<p>Make sure you have <code>MEDIA_URL</code> and <code>MEDIA_ROOT</code> configured in your <code>settings.py</code> if you're using <code>ImageField</code>. For example:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># settings.py</span>
MEDIA_URL <span class="token operator">=</span> <span class="token string">'/media/'</span>
MEDIA_ROOT <span class="token operator">=</span> BASE_DIR <span class="token operator">/</span> <span class="token string">'media'</span>
</code></pre>
<p>With this core Django setup, we have a functional (though not yet "live") product catalog with search, filtering, and pagination. The next step is to implement and verify the HTMX and Alpine.js interactions.</p>
<h3 id="1334-implementation-walkthrough-search-input-filter-sidebar-updating-list-url-updates-pagination" tabindex="-1"><a class="anchor" href="#1334-implementation-walkthrough-search-input-filter-sidebar-updating-list-url-updates-pagination" name="1334-implementation-walkthrough-search-input-filter-sidebar-updating-list-url-updates-pagination" tabindex="-1"><span class="octicon octicon-link"></span></a>13.3.4 Implementation Walkthrough (Search Input, Filter Sidebar, Updating List, URL Updates, Pagination)</h3>
<p>Now, let's walk through the implementation details, focusing on how HTMX and Alpine.js bring the dynamic aspects to life. We've already laid most of the groundwork in the templates and views. This section will reinforce the interactions and explain the "why" behind specific HTMX attributes and Alpine.js usage.</p>
<p><strong>A. Initial Page Load and Product Display</strong></p>
<ol>
<li><strong>Request:</strong> User navigates to <code>/products/</code>.</li>
<li><strong>Django View (<code>product_list</code>):</strong>
<ul>
<li>Executes the logic described in section 13.3.3.</li>
<li><code>request.htmx</code> is <code>False</code> (or <code>None</code>).</li>
<li>Gathers all products (or an initial unfiltered set), categories, and prepares pagination for the first page.</li>
<li>Initial <code>search_query</code> is empty, <code>current_category_ids_json</code> is <code>'[]'</code>.</li>
<li>Renders <code>products/product_list.html</code> with the full context.</li>
</ul>
</li>
<li><strong>Browser Renders <code>product_list.html</code>:</strong>
<ul>
<li>The Alpine component <code>div.container</code> initializes its <code>searchQuery</code> to <code>''</code> and <code>selectedCategories</code> to <code>[]</code>.</li>
<li>The <code>&lt;form id="filter-form"&gt;</code> is rendered with its HTMX attributes.</li>
<li>The search input's value is empty (due to <code>x-model="searchQuery"</code>).</li>
<li>Category checkboxes are unchecked (due to <code>x-model="selectedCategories"</code>).</li>
<li>The <code>{% include "products/_product_list_partial.html" %}</code> tag within <code>#product-list-container</code> renders the initial list of products (page 1) and pagination controls.</li>
</ul>
</li>
</ol>
<p>At this point, the user sees the full page with the initial product listing.</p>
<p><strong>B. Implementing Live Search</strong></p>
<ol>
<li><strong>User Interaction:</strong> The user types "laptop" into the search input: <code>&lt;input type="text" name="search" ... x-model="searchQuery"&gt;</code>.</li>
<li><strong>Alpine.js <code>x-model</code>:</strong> As the user types, <code>x-model="searchQuery"</code> updates the <code>searchQuery</code> property in Alpine's <code>x-data</code> in real-time.</li>
<li><strong>HTMX Trigger:</strong> The <code>&lt;form&gt;</code> has <code>hx-trigger="... keyup changed delay:500ms from:input[name='search']"</code>.
<ul>
<li>When the user stops typing for 500ms and the input's value has changed, HTMX triggers a GET request.</li>
</ul>
</li>
<li><strong>HTMX Request:</strong>
<ul>
<li><strong>URL:</strong> <code>{% url 'product_list' %}</code> (i.e., <code>/products/</code>).</li>
<li><strong>Parameters:</strong> HTMX serializes the <code>&lt;form id="filter-form"&gt;</code>. Since <code>searchQuery</code> in Alpine is bound to the input via <code>x-model</code>, the input's current value ("laptop") is sent as <code>search=laptop</code>. If any categories were checked, their values would also be included (e.g., <code>&amp;category=1</code>).</li>
<li><strong>Headers:</strong> <code>HX-Request: true</code> is added by HTMX.</li>
<li><strong>Indicator:</strong> <code>#loading-spinner</code> becomes visible because of <code>hx-indicator="#loading-spinner"</code> on the form.</li>
</ul>
</li>
<li><strong>Django View (<code>product_list</code>):</strong>
<ul>
<li><code>request.htmx</code> is <code>True</code>.</li>
<li><code>request.GET.get('search')</code> returns "laptop".</li>
<li>The <code>products_qs</code> is filtered: <code>products_qs.filter(name__icontains="laptop")</code>.</li>
<li>Pagination is applied to this filtered QuerySet.</li>
<li>The view renders <code>products/_product_list_partial.html</code> with the new <code>products</code> page object and updated context (e.g., <code>search_query</code> is now "laptop").</li>
</ul>
</li>
<li><strong>HTMX Response Handling:</strong>
<ul>
<li>HTMX receives the HTML fragment from <code>_product_list_partial.html</code>.</li>
<li><strong><code>hx-target="#product-list-container"</code></strong>: The content of <code>&lt;div id="product-list-container"&gt;</code> is replaced with the new HTML fragment.</li>
<li><strong><code>hx-swap="innerHTML"</code></strong> (default, or explicitly set): This is how the replacement happens.</li>
<li><strong><code>hx-push-url="true"</code></strong>: The browser's URL is updated to <code>/products/?search=laptop</code> (and any other active filter parameters).</li>
<li>The loading indicator <code>#loading-spinner</code> is hidden.</li>
</ul>
</li>
</ol>
<p>The user now sees the product list updated to show only laptops, and the URL reflects this state.</p>
<p><strong>C. Adding Category Filters</strong></p>
<ol>
<li><strong>User Interaction:</strong> The user checks the "Electronics" category checkbox. Let's assume its <code>value</code> is "1".
<ul>
<li><code>&lt;input type="checkbox" name="category" value="1" x-model="selectedCategories"&gt;</code></li>
</ul>
</li>
<li><strong>Alpine.js <code>x-model</code>:</strong> <code>x-model="selectedCategories"</code> updates the <code>selectedCategories</code> array in Alpine's <code>x-data</code>. It now becomes <code>['1']</code> (assuming it was empty).</li>
<li><strong>HTMX Trigger:</strong> The <code>&lt;form&gt;</code> has <code>hx-trigger="... change from:input[type='checkbox']"</code>.
<ul>
<li>When the checkbox state changes, HTMX triggers a GET request.</li>
</ul>
</li>
<li><strong>HTMX Request:</strong>
<ul>
<li><strong>URL:</strong> <code>/products/</code>.</li>
<li><strong>Parameters:</strong> The form is serialized.
<ul>
<li><code>search=laptop</code> (from the previous state, maintained by <code>x-model</code> on the search input).</li>
<li><code>category=1</code> (from the newly checked checkbox, value also maintained by <code>x-model</code>).</li>
</ul>
</li>
</ul>
</li>
<li><strong>Django View (<code>product_list</code>):</strong>
<ul>
<li><code>request.htmx</code> is <code>True</code>.</li>
<li><code>request.GET.get('search')</code> is "laptop".</li>
<li><code>request.GET.getlist('category')</code> is <code>['1']</code>.</li>
<li><code>products_qs</code> is filtered by both name and category: <code>products_qs.filter(name__icontains="laptop").filter(category__id__in=[1])</code>.</li>
<li>Pagination is applied.</li>
<li>Renders <code>products/_product_list_partial.html</code>.</li>
</ul>
</li>
<li><strong>HTMX Response Handling:</strong>
<ul>
<li>Similar to the search, <code>#product-list-container</code> is updated.</li>
<li>The URL becomes <code>/products/?search=laptop&amp;category=1</code>.</li>
</ul>
</li>
</ol>
<p>The user sees products that are "laptops" AND in the "Electronics" category. If they uncheck the box, <code>selectedCategories</code> becomes empty, <code>category=1</code> is no longer sent, and the list updates accordingly.</p>
<p><strong>Why the <code>&lt;form&gt;</code> with HTMX attributes?</strong>
Using HTMX attributes on the parent <code>&lt;form&gt;</code> is a clean way to manage multiple filter inputs.</p>
<ul>
<li><strong>Centralized Configuration:</strong> <code>hx-get</code>, <code>hx-target</code>, <code>hx-indicator</code>, <code>hx-push-url</code> are defined once.</li>
<li><strong>Automatic Serialization:</strong> When any of the specified <code>hx-trigger</code> events occur on the designated child inputs (or the form itself is submitted), HTMX automatically gathers values from <em>all named inputs</em> within that form. This ensures that when the search term changes, any active category filters are still included in the request, and vice-versa. This is simpler than adding <code>hx-include</code> to every single input to manually specify all other inputs.</li>
<li><strong>Alpine.js Synergy:</strong> <code>x-model</code> on the inputs keeps Alpine's state synchronized. HTMX then reads these <code>x-model</code>-updated values from the DOM when serializing the form.</li>
</ul>
<p><strong>D. Dynamic List Updates &amp; Partials (Reinforced)</strong></p>
<p>The core of the dynamic updates lies in the interplay between the full page template and the partial template:</p>
<ul>
<li><code>product_list.html</code> provides the overall page structure, including the filter controls and the <code>#product-list-container</code> div.</li>
<li><code>_product_list_partial.html</code> contains <em>only</em> the HTML for the product grid and its pagination controls.
When an HTMX request is made:</li>
</ul>
<ol>
<li>Django view detects <code>request.htmx</code>.</li>
<li>It processes filters and pagination.</li>
<li>It renders <em>only</em> <code>_product_list_partial.html</code> with the updated data.</li>
<li>HTMX takes this smaller HTML fragment and swaps it into <code>#product-list-container</code>.</li>
</ol>
<p>This is significantly more efficient than re-rendering and transferring the entire page, leading to a faster, smoother experience.</p>
<p><strong>E. URL State Management with <code>hx-push-url="true"</code></strong></p>
<p>This attribute is a cornerstone of building usable, modern web applications with HTMX.</p>
<ul>
<li><strong>Functionality:</strong> When an HTMX request completes successfully (for GET requests by default, configurable for others), if <code>hx-push-url="true"</code> is set on the element that triggered the request (or its parent form), HTMX will use the <code>History.pushState()</code> browser API to update the URL in the address bar to match the URL of the request that was just made.</li>
<li><strong>Benefits:</strong>
<ul>
<li><strong>Bookmarkability:</strong> Users can bookmark <code>http://localhost:8000/products/?search=tablet&amp;category=2</code>. When they return to this bookmark, the Django view will receive these GET parameters, filter accordingly, and render the correct initial state.</li>
<li><strong>Sharability:</strong> Users can copy and share this URL, and others will see the same filtered view.</li>
<li><strong>Back/Forward Buttons:</strong> HTMX automatically listens for <code>popstate</code> events (triggered by browser back/forward buttons). When such an event occurs, HTMX will re-request the content for the URL in the history state, effectively making the back and forward buttons work as expected, loading the correct filtered/paginated views dynamically.</li>
</ul>
</li>
<li><strong>Consideration:</strong> The URL pushed is the one used for the <code>hx-get</code> request. Our <code>filter-form</code> has <code>hx-get="{% url 'product_list' %}"</code>. HTMX appends the serialized form parameters to this base URL to form the actual request URL (e.g., <code>/products/?search=...&amp;category=...</code>), and it's this complete URL that gets pushed to the history.</li>
</ul>
<p><strong>F. HTMX-driven Pagination</strong></p>
<ol>
<li><strong>User Interaction:</strong> User clicks a pagination link, e.g., "Next" or page "2".
<ul>
<li>Example link from <code>_product_list_partial.html</code>:<pre class="language-html" tabindex="0"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=products.next_page_number %}<span class="token punctuation">"</span></span>
   <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?{% query_string page=products.next_page_number %}<span class="token punctuation">"</span></span>
   <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#product-list-container<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>Next <span class="token entity named-entity" title="»">&amp;raquo;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
</ul>
</li>
<li><strong><code>query_string</code> Template Tag:</strong> This custom tag is vital. It takes the current request's GET parameters (e.g., <code>search=laptop&amp;category=1</code>) and adds/updates the <code>page</code> parameter (e.g., <code>page=2</code>). So, the <code>href</code> and <code>hx-get</code> URL becomes something like <code>/products/?search=laptop&amp;category=1&amp;page=2</code>.</li>
<li><strong>HTMX Request:</strong>
<ul>
<li>Triggered by the click on the <code>&lt;a&gt;</code> tag.</li>
<li>Uses the URL generated by <code>query_string</code>.</li>
<li>Sends <code>HX-Request: true</code>.</li>
</ul>
</li>
<li><strong>Django View (<code>product_list</code>):</strong>
<ul>
<li><code>request.htmx</code> is <code>True</code>.</li>
<li>Retrieves <code>search</code>, <code>category</code>, and now <code>page=2</code>.</li>
<li>Filters the QuerySet based on search/category.</li>
<li>The <code>Paginator</code> provides page 2 of the filtered results.</li>
<li>Renders <code>_product_list_partial.html</code> with the products for page 2 and updated pagination links.</li>
</ul>
</li>
<li><strong>HTMX Response Handling:</strong>
<ul>
<li><code>#product-list-container</code> is updated with the new product list (page 2) and new pagination controls.</li>
<li><code>hx-push-url="true"</code> updates the browser URL to include <code>&amp;page=2</code>.</li>
</ul>
</li>
</ol>
<p>The user sees the next page of products, all filters are maintained, and the URL is correct.</p>
<p><strong>G. Loading Indicators</strong></p>
<p>The <code>hx-indicator="#loading-spinner"</code> attribute on the <code>&lt;form&gt;</code> (and potentially on pagination links if they are outside a form that provides a global indicator) tells HTMX to manage the visibility of the <code>&lt;span id="loading-spinner"&gt;...&lt;/span&gt;</code> element.</p>
<ul>
<li><strong>How it works:</strong> When an HTMX request starts from an element with <code>hx-indicator</code>, HTMX finds the indicator element.
<ul>
<li>It adds the <code>htmx-request</code> class to the element <em>making</em> the request (the form in our case).</li>
<li>It also makes the indicator element itself visible (typically by removing an inline <code>style="display:none;"</code> or by relying on CSS rules like <code>.htmx-indicator { display: none; }</code> and <code>.htmx-request .htmx-indicator { display: block; }</code> if the indicator is a child, or if the indicator <em>is</em> the element with <code>htmx-indicator</code> class, it will toggle its visibility).</li>
</ul>
</li>
<li>Our CSS:<pre class="language-css" tabindex="0"><code class="language-css"><span class="token selector">.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">/* Default: hidden */</span>
<span class="token comment">/* When an element that *is* an indicator is part of an active request */</span>
<span class="token selector">.htmx-request.htmx-indicator</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">/* Or, if the indicator is a child of the requesting element: */</span>
<span class="token comment">/* .htmx-request .my-spinner-child { display: inline; } */</span>
</code></pre>
The simplest is often to have a dedicated spinner element like <code>&lt;span id="loading-spinner" class="htmx-indicator"&gt;Loading...&lt;/span&gt;</code>. HTMX will toggle its <code>display</code> style or add/remove a class that your CSS uses to show/hide it. The <code>htmx-request</code> class on the <em>triggering</em> element is also useful for styling the trigger itself (e.g., dimming a button).</li>
</ul>
<p><strong>H. Enhancing with Alpine.js: The Synergy</strong></p>
<p>In our setup:</p>
<ul>
<li><code>x-data="{ searchQuery: '{{ search_query|escapejs }}', selectedCategories: {{ current_category_ids_json|safe }} }"</code> initializes Alpine's state from Django context on page load. This ensures that if the page is loaded with existing filters (e.g., from a bookmarked URL), the Alpine state and thus the input fields are correctly pre-filled/checked.</li>
<li><code>x-model="searchQuery"</code> on the search input and <code>x-model="selectedCategories"</code> on the category checkboxes create a two-way binding.
<ul>
<li>When the user types or checks/unchecks a box, Alpine's state updates.</li>
<li>Because <code>x-model</code> also updates the input's <code>value</code> (for text inputs) or <code>checked</code> property (for checkboxes), HTMX automatically picks up these current values when it serializes the form.</li>
</ul>
</li>
</ul>
<p><strong>Why use Alpine.js here if HTMX can read form values directly?</strong></p>
<ol>
<li><strong>Clearer State Management:</strong> For more complex filter UIs (e.g., multi-select dropdowns, range sliders, or filters that depend on each other), Alpine provides a more robust and declarative way to manage client-side state than manipulating DOM properties directly with vanilla JavaScript.</li>
<li><strong>Initial State from Server:</strong> Alpine's <code>x-data</code> combined with Django template variables makes it easy to initialize the client-side state from server-rendered values (e.g., <code>{{ search_query|escapejs }}</code>), ensuring consistency when loading a page with pre-existing filters from the URL.</li>
<li><strong>Reactive UI Elements (Beyond Form Submission):</strong> Alpine could be used to display a summary of active filters, enable/disable a "Clear Filters" button based on whether any filters are active, or perform client-side validations/transformations before HTMX even makes a request. For example, a "Clear Filters" button could use Alpine to reset <code>searchQuery</code> and <code>selectedCategories</code>, which would then trigger an HTMX update via the form's <code>hx-trigger</code>.<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- Inside the x-data scope --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>searchQuery=''; selectedCategories=[]; $nextTick(() =&gt; document.getElementById('filter-form').dispatchEvent(new Event('submit')))<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    Clear Filters
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre>
This button, when clicked:
<ol>
<li>Clears Alpine's <code>searchQuery</code> and <code>selectedCategories</code>.</li>
<li><code>x-model</code> updates the actual input fields.</li>
<li><code>$nextTick</code> ensures DOM updates from <code>x-model</code> have occurred.</li>
<li>It then programmatically triggers a <code>submit</code> event on the form. The form's <code>hx-trigger</code> includes <code>submit</code>, so HTMX takes over and sends the request with the now-cleared filter values.</li>
</ol>
</li>
</ol>
<p>This walkthrough demonstrates a robust pattern for creating dynamic, filterable lists. Django handles the data and backend logic, HTMX manages server communication and partial page updates, and Alpine.js elegantly handles the client-side state of the filter inputs, all working together seamlessly.</p>
<h2 id="134-project-3-simple-real-time-notification-feed" tabindex="-1"><a class="anchor" href="#134-project-3-simple-real-time-notification-feed" name="134-project-3-simple-real-time-notification-feed" tabindex="-1"><span class="octicon octicon-link"></span></a>13.4 Project 3: Simple Real-Time Notification Feed</h2>
<p>In modern web applications, providing users with timely updates without requiring manual page refreshes is crucial for an engaging experience. This project focuses on building a simple real-time notification feed, a common feature in applications ranging from social media platforms to internal dashboards. We'll explore how Django, HTMX, and Alpine.js can work in concert to deliver these updates efficiently.</p>
<h3 id="1341-concept--goals-server-pushed-updates-via-ssepolling" tabindex="-1"><a class="anchor" href="#1341-concept--goals-server-pushed-updates-via-ssepolling" name="1341-concept--goals-server-pushed-updates-via-ssepolling" tabindex="-1"><span class="octicon octicon-link"></span></a>13.4.1 Concept &amp; Goals (Server-Pushed Updates via SSE/Polling)</h3>
<p><strong>Concept:</strong>
A real-time notification feed displays messages or alerts to the user as they happen. Imagine receiving a new message alert, a "like" on your post, or a status update on a background task – these are all examples of notifications that benefit from real-time delivery. The core idea is to push information from the server to the client, or have the client intelligently fetch it, the moment it becomes available.</p>
<p><strong>Why is this important?</strong></p>
<ul>
<li><strong>Improved User Experience:</strong> Users receive immediate feedback and stay informed without interrupting their workflow by manually refreshing.</li>
<li><strong>Increased Engagement:</strong> Timely notifications can prompt users to interact with new content or take necessary actions.</li>
<li><strong>Sense of Liveness:</strong> The application feels more dynamic and responsive.</li>
</ul>
<p><strong>Goals for this Project:</strong></p>
<ol>
<li><strong>Display Notifications:</strong> Users will see a list of their notifications.</li>
<li><strong>Real-Time Updates:</strong> New notifications will appear in the list automatically, without a full page reload.</li>
<li><strong>Notification Badge:</strong> A badge (e.g., in the navigation bar) will show the count of unread notifications and update in real-time.</li>
<li><strong>Explore Two Update Mechanisms:</strong>
<ul>
<li><strong>Server-Sent Events (SSE):</strong> We will primarily implement SSE. SSE is a standard web technology that allows a server to push data to a client over a single, long-lived HTTP connection. It's a one-way communication channel (server-to-client), making it simpler than WebSockets for use cases like notification streams where bidirectional communication isn't strictly necessary. Its key advantage is its simplicity and reliance on standard HTTP.</li>
<li><strong>Polling (as an alternative concept):</strong> We will also discuss and briefly illustrate polling. Polling involves the client periodically sending requests to the server to check for new data. While simpler to implement on the server-side initially, it can be less efficient, introducing latency (updates are not instant but depend on the polling interval) and potentially increasing server load due to frequent requests. We'll show how HTMX makes polling trivial to set up.</li>
</ul>
</li>
<li><strong>Graceful UI Updates:</strong> Leverage HTMX for seamless DOM updates and Alpine.js for minor client-side UI enhancements.</li>
</ol>
<p>This project will demonstrate how to build a core component of many modern applications, emphasizing the synergy between Django's backend capabilities and the reactive frontend enhancements provided by HTMX and Alpine.js.</p>
<h3 id="1342-key-technologies-demonstrated-django-modelschannelsauth-htmx-hx-ssepolling-alpine-ui-enhancements" tabindex="-1"><a class="anchor" href="#1342-key-technologies-demonstrated-django-modelschannelsauth-htmx-hx-ssepolling-alpine-ui-enhancements" name="1342-key-technologies-demonstrated-django-modelschannelsauth-htmx-hx-ssepolling-alpine-ui-enhancements" tabindex="-1"><span class="octicon octicon-link"></span></a>13.4.2 Key Technologies Demonstrated (Django Models/Channels/Auth, HTMX <code>hx-sse</code>/Polling, Alpine UI Enhancements)</h3>
<p>To achieve our real-time notification feed, we'll employ a specific set of tools from our Django/HTMX/Alpine.js stack:</p>
<ol>
<li>
<p><strong>Django Models:</strong></p>
<ul>
<li><strong>Purpose:</strong> To persistently store notification data.</li>
<li><strong>Implementation:</strong> We'll define a <code>Notification</code> model with fields like <code>user</code> (to associate the notification with a specific user), <code>message</code> (the content of the notification), <code>timestamp</code> (when it was created), and <code>is_read</code> (to track its status).</li>
<li><strong>Why:</strong> Models provide a structured, Pythonic way to interact with the database, abstracting away raw SQL.</li>
</ul>
</li>
<li>
<p><strong>Django Channels (Basics):</strong></p>
<ul>
<li><strong>Purpose:</strong> To handle asynchronous communication protocols beyond standard HTTP, specifically for implementing Server-Sent Events (SSE).</li>
<li><strong>Implementation:</strong> We'll configure our Django project to support ASGI (Asynchronous Server Gateway Interface), which Channels builds upon. We'll create a Channels "consumer" – a piece of code that handles the SSE connection, listens for new notification events, and streams them to the client.</li>
<li><strong>Why:</strong> Traditional Django is built around a synchronous request-response cycle. Channels extends Django to handle long-lived connections and protocols like WebSockets and SSE, essential for real-time features.</li>
</ul>
</li>
<li>
<p><strong>Django Authentication (<code>django.contrib.auth</code>):</strong></p>
<ul>
<li><strong>Purpose:</strong> To ensure that notifications are user-specific and secure.</li>
<li><strong>Implementation:</strong> We'll associate notifications with Django's built-in <code>User</code> model and ensure that users only receive their own notifications.</li>
<li><strong>Why:</strong> Security and data privacy are paramount. Django's auth system provides a robust foundation for managing users and permissions.</li>
</ul>
</li>
<li>
<p><strong>HTMX:</strong></p>
<ul>
<li><strong>Purpose:</strong> To manage the client-server communication for fetching and displaying notifications without writing custom JavaScript.</li>
<li><strong>Key Attributes:</strong>
<ul>
<li><code>hx-sse="connect:/url"</code>: To establish an SSE connection with a specific server endpoint.</li>
<li><code>hx-sse="swap:message"</code>: To listen for messages on the SSE connection and swap the content into the DOM.</li>
<li><code>hx-trigger="every Xs"</code> (for polling): To periodically send GET requests to an endpoint.</li>
<li><code>hx-target</code>: To specify where the incoming HTML fragment should be placed.</li>
<li><code>hx-swap</code>: To define how the new content replaces or augments existing content (e.g., <code>afterbegin</code> to prepend new notifications).</li>
<li><code>hx-swap-oob="true"</code>: For Out-of-Band swaps, allowing a single server response to update multiple, independent parts of the page (e.g., the notification list and a separate badge counter).</li>
</ul>
</li>
<li><strong>Why:</strong> HTMX allows us to achieve dynamic, real-time updates by extending HTML with simple attributes, keeping our frontend logic declarative and minimizing JavaScript.</li>
</ul>
</li>
<li>
<p><strong>Alpine.js:</strong></p>
<ul>
<li><strong>Purpose:</strong> For lightweight, client-side UI enhancements that complement HTMX's server-driven updates.</li>
<li><strong>Key Directives:</strong>
<ul>
<li><code>x-data</code>: To define a component's reactive state.</li>
<li><code>x-show</code>: To conditionally display elements (e.g., an "empty state" message if there are no notifications).</li>
<li><code>x-text</code>: To display reactive data (e.g., an unread notification count).</li>
<li><code>x-transition</code>: To add simple animations when notifications appear or disappear.</li>
</ul>
</li>
<li><strong>Why:</strong> Alpine.js provides a minimal footprint for adding interactivity directly within our HTML, perfect for managing UI states that don't require server interaction or that enhance the user experience of HTMX-driven content.</li>
</ul>
</li>
</ol>
<p>By combining these technologies, we aim to build a robust and interactive notification system that feels modern and responsive, while adhering to the principles of progressive enhancement and leveraging the strengths of each tool.</p>
<h3 id="1343-core-django-setup-channels-basics" tabindex="-1"><a class="anchor" href="#1343-core-django-setup-channels-basics" name="1343-core-django-setup-channels-basics" tabindex="-1"><span class="octicon octicon-link"></span></a>13.4.3 Core Django Setup (Channels Basics)</h3>
<p>Before we can implement the real-time notification logic, we need to configure our Django project to support Django Channels, which is essential for handling protocols like Server-Sent Events (SSE). This involves setting up the ASGI application entry point and installing Channels.</p>
<p><strong>1. Install Channels and Add to <code>INSTALLED_APPS</code>:</strong></p>
<p>First, ensure you have <code>channels</code> installed in your project's environment:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># THIS_CODE_SNIPPET</span>
pip <span class="token function">install</span> channels
</code></pre>
<p>This command installs the <code>channels</code> library.</p>
<p>Next, add <code>channels</code> to your <code>INSTALLED_APPS</code> in your project's <code>settings.py</code> file. It's typically placed at the top, though its exact position among other apps isn't strictly critical unless specific middleware ordering from Channels is needed early.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># project/settings.py</span>

INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'channels'</span><span class="token punctuation">,</span>  <span class="token comment"># Add channels</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'notifications_app'</span><span class="token punctuation">,</span> <span class="token comment"># Assuming our app is named 'notifications_app'</span>
    <span class="token comment"># ... other apps</span>
<span class="token punctuation">]</span>
</code></pre>
<p>Let's examine this code:</p>
<ol>
<li>We add <code>'channels'</code> to the <code>INSTALLED_APPS</code> list.
<ul>
<li>This makes Django aware of the Channels framework, allowing it to discover Channels-specific configurations like routing and consumers.</li>
<li>It also ensures that any management commands or template tags provided by Channels are available.</li>
</ul>
</li>
<li>We also assume an app named <code>notifications_app</code> will house our notification-specific logic (models, views, consumers).</li>
</ol>
<p><strong>2. Define <code>ASGI_APPLICATION</code>:</strong></p>
<p>Still in <code>settings.py</code>, you need to tell Django where your root ASGI application object is located. This is analogous to <code>WSGI_APPLICATION</code> for traditional synchronous Django.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># project/settings.py</span>

<span class="token comment"># ... other settings ...</span>

ASGI_APPLICATION <span class="token operator">=</span> <span class="token string">'your_project_name.asgi.application'</span> <span class="token comment"># Replace 'your_project_name'</span>
</code></pre>
<p>Let's examine this code:</p>
<ol>
<li><code>ASGI_APPLICATION</code> is set to a string that points to the <code>application</code> object within your project's <code>asgi.py</code> file.
<ul>
<li>This setting directs ASGI servers (like Daphne or Uvicorn) to use this entry point for handling incoming connections, including HTTP, WebSockets, and SSE.</li>
<li>The path <code>your_project_name.asgi.application</code> follows Python's module import syntax. Ensure <code>your_project_name</code> matches the actual name of your Django project directory (the one containing <code>settings.py</code>).</li>
</ul>
</li>
</ol>
<p><strong>3. Create the <code>Notification</code> Model:</strong></p>
<p>Let's define a simple model in <code>notifications_app/models.py</code> to store our notifications.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/models.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings

<span class="token keyword">class</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>
        settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span>
        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span>
        related_name<span class="token operator">=</span><span class="token string">'notifications'</span>
    <span class="token punctuation">)</span>
    message <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    is_read <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    timestamp <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'-timestamp'</span><span class="token punctuation">]</span> <span class="token comment"># Display newest notifications first</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Notification for </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>message<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">30]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span>
</code></pre>
<p>Let's examine this code in detail:</p>
<ol>
<li><code>user = models.ForeignKey(settings.AUTH_USER_MODEL, ...)</code>:
<ul>
<li>This establishes a many-to-one relationship with Django's User model. Each notification belongs to one user, and a user can have many notifications.</li>
<li><code>settings.AUTH_USER_MODEL</code> is used to refer to the User model dynamically, which is best practice in case you have a custom user model.</li>
<li><code>on_delete=models.CASCADE</code> means if a user is deleted, all their notifications will also be deleted.</li>
<li><code>related_name='notifications'</code> allows us to access a user's notifications via <code>user_instance.notifications.all()</code>.</li>
</ul>
</li>
<li><code>message = models.TextField()</code>:
<ul>
<li>A field to store the actual content of the notification. <code>TextField</code> is suitable for longer messages.</li>
</ul>
</li>
<li><code>is_read = models.BooleanField(default=False)</code>:
<ul>
<li>A boolean flag to track whether the user has seen/interacted with the notification. It defaults to <code>False</code> (unread).</li>
</ul>
</li>
<li><code>timestamp = models.DateTimeField(auto_now_add=True)</code>:
<ul>
<li>Automatically records the date and time when the notification object is first created.</li>
</ul>
</li>
<li><code>class Meta: ordering = ['-timestamp']</code>:
<ul>
<li>This inner class provides metadata for the model.</li>
<li><code>ordering = ['-timestamp']</code> specifies that by default, when you query for notifications, they should be ordered by the <code>timestamp</code> field in descending order (newest first). This is a common requirement for notification feeds.</li>
</ul>
</li>
<li><code>def __str__(self):</code>:
<ul>
<li>This method defines the string representation of a <code>Notification</code> object, which is useful in the Django admin and for debugging.</li>
</ul>
</li>
</ol>
<p>After defining the model, create and run migrations:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># THIS_CODE_SNIPPET</span>
python manage.py makemigrations notifications_app
python manage.py migrate
</code></pre>
<p>These commands generate the necessary SQL to create the <code>notifications_notification</code> table in your database and then apply those changes.</p>
<p><strong>4. Create the Project-Level <code>asgi.py</code> File:</strong></p>
<p>If it doesn't exist, create an <code>asgi.py</code> file in your project directory (alongside <code>wsgi.py</code> and <code>settings.py</code>). This file is the main entry point for ASGI servers.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># your_project_name/asgi.py</span>

<span class="token keyword">import</span> os
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>asgi <span class="token keyword">import</span> get_asgi_application
<span class="token keyword">from</span> channels<span class="token punctuation">.</span>routing <span class="token keyword">import</span> ProtocolTypeRouter<span class="token punctuation">,</span> URLRouter
<span class="token keyword">from</span> channels<span class="token punctuation">.</span>auth <span class="token keyword">import</span> AuthMiddlewareStack
<span class="token keyword">import</span> notifications_app<span class="token punctuation">.</span>routing <span class="token comment"># Assuming your app routing is here</span>

os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'DJANGO_SETTINGS_MODULE'</span><span class="token punctuation">,</span> <span class="token string">'your_project_name.settings'</span><span class="token punctuation">)</span>

<span class="token comment"># Get the default Django ASGI application to handle HTTP requests</span>
django_asgi_app <span class="token operator">=</span> get_asgi_application<span class="token punctuation">(</span><span class="token punctuation">)</span>

application <span class="token operator">=</span> ProtocolTypeRouter<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"http"</span><span class="token punctuation">:</span> URLRouter<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            <span class="token comment"># Django's default HTTP handling for most requests</span>
            <span class="token comment"># This must come after specific websocket/SSE paths if they share URL prefixes</span>
            <span class="token comment"># or be careful with how you structure your app's URLRouter</span>
        <span class="token punctuation">]</span> <span class="token operator">+</span> notifications_app<span class="token punctuation">.</span>routing<span class="token punctuation">.</span>http_urlpatterns <span class="token comment"># Add http patterns from app</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"websocket"</span><span class="token punctuation">:</span> AuthMiddlewareStack<span class="token punctuation">(</span>
        URLRouter<span class="token punctuation">(</span>
            notifications_app<span class="token punctuation">.</span>routing<span class="token punctuation">.</span>websocket_urlpatterns <span class="token comment"># Add websocket patterns from app</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># We will primarily use HTTP for SSE in this example,</span>
    <span class="token comment"># but if you were using WebSockets for SSE-like behavior, it would go here.</span>
    <span class="token comment"># For true SSE, it's often handled as a streaming HTTP response.</span>
    <span class="token comment"># If using Channels consumers for SSE, they might be routed under 'http' or a custom protocol.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># A more common setup for Channels 3+ where Django's HTTP handling is primary:</span>
application <span class="token operator">=</span> ProtocolTypeRouter<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"http"</span><span class="token punctuation">:</span> django_asgi_app<span class="token punctuation">,</span> <span class="token comment"># Standard HTTP requests handled by Django</span>
    <span class="token string">"websocket"</span><span class="token punctuation">:</span> AuthMiddlewareStack<span class="token punctuation">(</span>
        URLRouter<span class="token punctuation">(</span>
            notifications_app<span class="token punctuation">.</span>routing<span class="token punctuation">.</span>websocket_urlpatterns
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># For SSE using a streaming HTTP response from a Django async view,</span>
<span class="token comment"># the default django_asgi_app under "http" is sufficient.</span>
<span class="token comment"># If using a Channels consumer for SSE (e.g. an AsyncHttpConsumer),</span>
<span class="token comment"># it would be part of the http URLRouter.</span>

<span class="token comment"># Let's refine for clarity for this project:</span>
<span class="token comment"># We'll use an AsyncHttpConsumer for SSE, so it will be part of the HTTP routing.</span>
<span class="token comment"># The django_asgi_app will handle regular HTTP, and we'll add specific routes</span>
<span class="token comment"># for Channels consumers to its URL router.</span>

<span class="token comment"># Corrected asgi.py for Channels 3+ and integrating app-level routing:</span>
<span class="token comment"># (Assuming notifications_app.routing will define websocket_urlpatterns and potentially http_urlpatterns for consumers)</span>

os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'DJANGO_SETTINGS_MODULE'</span><span class="token punctuation">,</span> <span class="token string">'your_project_name.settings'</span><span class="token punctuation">)</span>
django_asgi_app <span class="token operator">=</span> get_asgi_application<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Initialize Django ASGI app early</span>

<span class="token keyword">import</span> notifications_app<span class="token punctuation">.</span>routing <span class="token comment"># Import after DJANGO_SETTINGS_MODULE is set</span>

application <span class="token operator">=</span> ProtocolTypeRouter<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"http"</span><span class="token punctuation">:</span> URLRouter<span class="token punctuation">(</span>
        <span class="token comment"># Add your app's HTTP consumer routes here</span>
        <span class="token comment"># For example, if your SSE endpoint is /sse/notifications/</span>
        <span class="token comment"># and handled by a consumer.</span>
        <span class="token comment"># This needs to be structured carefully with Django's own URL handling.</span>
        <span class="token comment"># A common pattern is to let Django handle most HTTP and delegate specific paths</span>
        <span class="token comment"># to Channels consumers.</span>
        notifications_app<span class="token punctuation">.</span>routing<span class="token punctuation">.</span>http_urlpatterns <span class="token operator">+</span>  <span class="token comment"># For HTTP consumers like SSE</span>
        <span class="token punctuation">[</span>
            <span class="token comment"># Fallback to Django's default HTTP handling for everything else</span>
            <span class="token comment"># This path needs to be correctly configured.</span>
            <span class="token comment"># For Channels 4+, django_asgi_app handles all HTTP by default unless</span>
            <span class="token comment"># other http routes are specified first in a URLRouter.</span>
            <span class="token comment"># A simpler way for Channels 3/4:</span>
            <span class="token comment"># path("", django_asgi_app), # if you want Django to handle unmatched http</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"websocket"</span><span class="token punctuation">:</span> AuthMiddlewareStack<span class="token punctuation">(</span>
        URLRouter<span class="token punctuation">(</span>
            notifications_app<span class="token punctuation">.</span>routing<span class="token punctuation">.</span>websocket_urlpatterns
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># Simplest ASGI for this project if SSE is an async Django view:</span>
<span class="token comment"># os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'your_project_name.settings')</span>
<span class="token comment"># application = get_asgi_application()</span>
<span class="token comment"># And then in notifications_app/routing.py, we'd only have websocket_urlpatterns.</span>
<span class="token comment"># The SSE endpoint would be a regular Django async view in views.py.</span>

<span class="token comment"># Let's assume we want to use a Channels Consumer for SSE for pedagogical reasons,</span>
<span class="token comment"># as implied by "Channels Basics" and Chapter 10.</span>
<span class="token comment"># The `application` will route based on protocol. HTTP requests can go to Django's</span>
<span class="token comment"># default handler or to specific Channels HTTP consumers.</span>

<span class="token comment"># Final `asgi.py` structure for this project:</span>
<span class="token comment"># We will have Django handle most HTTP. Specific paths for SSE will be routed</span>
<span class="token comment"># to a Channels consumer via the app's `routing.py`.</span>
<span class="token comment"># `django_asgi_app` itself is a URLRouter. We can prepend our Channels HTTP routes to it.</span>

application <span class="token operator">=</span> ProtocolTypeRouter<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"http"</span><span class="token punctuation">:</span> AuthMiddlewareStack<span class="token punctuation">(</span> <span class="token comment"># AuthMiddlewareStack can be useful for HTTP consumers too</span>
        URLRouter<span class="token punctuation">(</span>
            <span class="token comment"># Prepend Channels-specific HTTP routes</span>
            notifications_app<span class="token punctuation">.</span>routing<span class="token punctuation">.</span>http_urlpatterns <span class="token operator">+</span>
            <span class="token comment"># Fallback to Django's default views for other HTTP requests</span>
            <span class="token comment"># This requires careful construction if django_asgi_app is not used directly.</span>
            <span class="token comment"># A common pattern for Channels 3/4:</span>
            <span class="token comment"># Let django_asgi_app handle all http, and then in your app's urls.py,</span>
            <span class="token comment"># you can point specific paths to consumers.as_view().</span>
            <span class="token comment"># For this example, we'll use a dedicated URLRouter for http consumers.</span>
            <span class="token punctuation">[</span>
                <span class="token comment"># If you have other top-level HTTP consumers, add them here.</span>
                <span class="token comment"># For standard Django views, they are handled by django_asgi_app.</span>
                <span class="token comment"># To integrate cleanly, we often let django_asgi_app handle all HTTP</span>
                <span class="token comment"># and then map specific Django URL patterns to consumer .as_view() calls.</span>
                <span class="token comment"># Let's simplify:</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># If you also had WebSockets:</span>
    <span class="token comment"># "websocket": AuthMiddlewareStack(</span>
    <span class="token comment">#     URLRouter(</span>
    <span class="token comment">#         notifications_app.routing.websocket_urlpatterns</span>
    <span class="token comment">#     )</span>
    <span class="token comment"># ),</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># This is getting complex. The simplest way for Channels 3+ is:</span>
<span class="token comment"># django_asgi_app = get_asgi_application()</span>
<span class="token comment"># application = ProtocolTypeRouter({</span>
<span class="token comment">#     "http": django_asgi_app, # Django handles all HTTP requests</span>
<span class="token comment">#     "websocket": AuthMiddlewareStack(URLRouter(notifications_app.routing.websocket_urlpatterns)),</span>
<span class="token comment"># })</span>
<span class="token comment"># Then, in your main `urls.py` (for HTTP), you'd route a path to your SSE consumer's `.as_view()` method.</span>
<span class="token comment"># This is the most straightforward for integrating Channels HTTP consumers.</span>

<span class="token comment"># Let's stick to the recommended Channels 3/4 pattern for clarity:</span>
<span class="token comment"># Django handles HTTP, and specific paths in urls.py can point to consumers.</span>
<span class="token comment"># The asgi.py then becomes simpler.</span>

<span class="token comment"># your_project_name/asgi.py</span>
<span class="token keyword">import</span> os
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>asgi <span class="token keyword">import</span> get_asgi_application
<span class="token keyword">from</span> channels<span class="token punctuation">.</span>routing <span class="token keyword">import</span> ProtocolTypeRouter<span class="token punctuation">,</span> URLRouter
<span class="token keyword">from</span> channels<span class="token punctuation">.</span>auth <span class="token keyword">import</span> AuthMiddlewareStack <span class="token comment"># If using auth with WebSockets</span>

os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'DJANGO_SETTINGS_MODULE'</span><span class="token punctuation">,</span> <span class="token string">'your_project_name.settings'</span><span class="token punctuation">)</span>

<span class="token comment"># Initialize Django ASGI application to handle traditional HTTP requests</span>
<span class="token comment"># and also to allow routing to Channels HTTP consumers via Django's URLconf.</span>
django_asgi_app <span class="token operator">=</span> get_asgi_application<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Import your app's routing configuration AFTER django.setup() has been called</span>
<span class="token comment"># by get_asgi_application() or by explicitly calling django.setup().</span>
<span class="token keyword">import</span> notifications_app<span class="token punctuation">.</span>routing <span class="token comment"># Ensure this file exists</span>

application <span class="token operator">=</span> ProtocolTypeRouter<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment"># Django's ASGI application to handle all HTTP requests.</span>
    <span class="token comment"># SSE will be an HTTP endpoint defined in Django's URL patterns,</span>
    <span class="token comment"># pointing to an async view or an AsyncHttpConsumer.as_view().</span>
    <span class="token string">"http"</span><span class="token punctuation">:</span> django_asgi_app<span class="token punctuation">,</span>

    <span class="token comment"># WebSocket handlers (if you were using them for other purposes)</span>
    <span class="token comment"># For this project, we are focusing on SSE via HTTP.</span>
    <span class="token comment"># If you had WebSockets:</span>
    <span class="token comment"># "websocket": AuthMiddlewareStack(</span>
    <span class="token comment">#     URLRouter(</span>
    <span class="token comment">#         notifications_app.routing.websocket_urlpatterns</span>
    <span class="token comment">#     )</span>
    <span class="token comment"># ),</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
<p>Let's examine this <code>asgi.py</code> structure:</p>
<ol>
<li><code>os.environ.setdefault(...)</code>: Standard Django setup to ensure settings are loaded.</li>
<li><code>django_asgi_app = get_asgi_application()</code>: This initializes Django's core ASGI application. It's responsible for handling standard HTTP requests through Django's URL routing, views, and middleware. Crucially, this also allows us to route specific HTTP paths (like our SSE endpoint) to Channels consumers if they are exposed as ASGI-compatible views (e.g., using <code>MyConsumer.as_view()</code>).</li>
<li><code>import notifications_app.routing</code>: We will create this file in our <code>notifications_app</code> to define routing for non-HTTP protocols if needed (like WebSockets). For SSE implemented as a streaming HTTP response via an <code>AsyncHttpConsumer</code> or an <code>async</code> Django view, the routing will primarily happen in Django's standard <code>urls.py</code>.</li>
<li><code>ProtocolTypeRouter({...})</code>: This is the heart of Channels routing. It inspects the type of incoming connection (e.g., "http", "websocket") and dispatches it to the appropriate handler.
<ul>
<li><code>"http": django_asgi_app</code>: All HTTP traffic (including our SSE stream, which is fundamentally HTTP) will be initially handled by Django's ASGI application. We will define a URL pattern in Django's <code>urls.py</code> that maps to our SSE handler (which could be an <code>async</code> view or an <code>AsyncHttpConsumer</code>).</li>
<li><code>"websocket": ...</code>: This part is commented out as we are focusing on SSE for this project. If you were using WebSockets, you would define their routing here, typically wrapping them in <code>AuthMiddlewareStack</code> to make Django's authentication information available to your consumers.</li>
</ul>
</li>
</ol>
<p>This setup ensures that Django can serve both regular HTTP requests and handle the long-lived connection required for SSE.</p>
<p><strong>5. Create App-Level <code>routing.py</code> (for potential WebSocket routes):</strong></p>
<p>Even if we primarily use HTTP for SSE, it's good practice to have an app-level <code>routing.py</code> if you anticipate using other Channels features like WebSockets. For now, it can be minimal if we don't have WebSockets.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/routing.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> re_path
<span class="token comment"># from . import consumers # We will create consumers.py next</span>

<span class="token comment"># For this project, we are focusing on SSE via an HTTP endpoint (async view or AsyncHttpConsumer).</span>
<span class="token comment"># If we were using WebSockets, the patterns would go here:</span>
websocket_urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># re_path(r'ws/notifications/$', consumers.NotificationConsumer.as_asgi()),</span>
<span class="token punctuation">]</span>

<span class="token comment"># If using Channels HTTP consumers directly in ASGI routing (less common for simple SSE):</span>
http_urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># re_path(r'sse/notifications-stream/$', consumers.NotificationSSEConsumer.as_asgi()),</span>
<span class="token punctuation">]</span>
<span class="token comment"># However, for SSE, it's often cleaner to use a Django async view or an AsyncHttpConsumer</span>
<span class="token comment"># mapped in the standard Django urls.py. We will adopt this approach.</span>
<span class="token comment"># So, http_urlpatterns here might be empty or not used if SSE is via Django views.</span>
<span class="token comment"># For this example, let's assume http_urlpatterns will be used if we opt for an AsyncHttpConsumer</span>
<span class="token comment"># routed via ASGI layer directly, but we will prefer Django URL routing for the consumer.</span>
<span class="token comment"># So, this file might only contain websocket_urlpatterns if any.</span>
<span class="token comment"># For now, let's keep it simple:</span>
http_urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># No direct ASGI HTTP routes, SSE will be via Django urls.py</span>
</code></pre>
<p>Let's examine this code:</p>
<ol>
<li><code>websocket_urlpatterns</code>: This list would contain <code>path</code> or <code>re_path</code> entries mapping URL patterns to WebSocket consumers if our application used WebSockets. Since we are focusing on SSE (which is HTTP-based), this might remain empty or be omitted if no WebSockets are used.</li>
<li><code>http_urlpatterns</code>: This list is for routing HTTP requests to Channels consumers <em>at the ASGI level</em>, before Django's main URL dispatcher. While possible for SSE, it's often more straightforward to define SSE endpoints as regular Django async views or <code>AsyncHttpConsumer.as_view()</code> entries within your app's <code>urls.py</code> and let <code>django_asgi_app</code> handle the routing. We will follow the latter approach, so this list will likely be empty for the SSE part.</li>
</ol>
<p>With this core setup, our Django project is now capable of handling ASGI requests, paving the way for implementing the SSE notification stream. The next step will be to create the actual SSE consumer/view and integrate it with HTMX.</p>
<h3 id="1344-implementation-walkthrough-ssepolling-setup-handling-updates-oob-swaps-for-badge" tabindex="-1"><a class="anchor" href="#1344-implementation-walkthrough-ssepolling-setup-handling-updates-oob-swaps-for-badge" name="1344-implementation-walkthrough-ssepolling-setup-handling-updates-oob-swaps-for-badge" tabindex="-1"><span class="octicon octicon-link"></span></a>13.4.4 Implementation Walkthrough (SSE/Polling Setup, Handling Updates, OOB Swaps for Badge)</h3>
<p>Now that the foundational ASGI and Channels setup is in place, let's walk through the implementation of the real-time notification feed.</p>
<p><strong>1. The <code>Notification</code> Model and Admin Integration</strong></p>
<p>We've already defined the <code>Notification</code> model in <code>notifications_app/models.py</code>. To easily create and manage notifications for testing, let's register it with the Django admin.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/admin.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Notification

<span class="token decorator annotation punctuation">@admin<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span>Notification<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">NotificationAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    list_display <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span> <span class="token string">'is_read'</span><span class="token punctuation">)</span>
    list_filter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'is_read'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>
    search_fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token string">'user__username'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Optimize query to prefetch user details</span>
        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_queryset<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span>select_related<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
</code></pre>
<p>Let's examine this code:</p>
<ol>
<li><code>@admin.register(Notification)</code>: This decorator registers the <code>Notification</code> model with the Django admin site.</li>
<li><code>NotificationAdmin(admin.ModelAdmin)</code>: We define a custom admin class to control how notifications are displayed and managed.
<ul>
<li><code>list_display</code>: Specifies the fields to show in the admin list view.</li>
<li><code>list_filter</code>: Adds filters to the sidebar for <code>is_read</code>, <code>timestamp</code>, and <code>user</code>.</li>
<li><code>search_fields</code>: Enables searching by notification <code>message</code> and the associated <code>user</code>'s username.</li>
<li><code>get_queryset</code>: Overridden to use <code>select_related('user')</code>, which optimizes database queries by fetching related user objects in a single query, preventing N+1 problems in the admin list view.</li>
</ul>
</li>
</ol>
<p>Now, you can create a superuser (<code>python manage.py createsuperuser</code>) and add notifications via the Django admin interface (<code>/admin/notifications_app/notification/</code>).</p>
<p><strong>2. Django View for the Notification Page and SSE Endpoint</strong></p>
<p>We need a Django view to render the initial page that will display notifications and connect to the SSE stream. We'll also define an <code>async</code> view to handle the SSE stream itself.</p>
<p>First, let's create the view that renders the page containing the notification list.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/views.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> login_required
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Notification

<span class="token decorator annotation punctuation">@login_required</span>
<span class="token keyword">def</span> <span class="token function">notification_page</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    notifications <span class="token operator">=</span> Notification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-timestamp'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token comment"># Get latest 10</span>
    unread_count <span class="token operator">=</span> Notification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> is_read<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'notifications'</span><span class="token punctuation">:</span> notifications<span class="token punctuation">,</span>
        <span class="token string">'unread_count'</span><span class="token punctuation">:</span> unread_count<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'notifications_app/notification_page.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre>
<p>Let's examine this <code>notification_page</code> view:</p>
<ol>
<li><code>@login_required</code>: Ensures that only authenticated users can access this page.</li>
<li><code>Notification.objects.filter(user=request.user)...</code>: Fetches the 10 most recent notifications for the currently logged-in user.</li>
<li><code>unread_count = ...</code>: Calculates the number of unread notifications for the user.</li>
<li><code>context</code>: Passes the notifications and unread count to the template.</li>
<li><code>render(...)</code>: Renders the <code>notification_page.html</code> template.</li>
</ol>
<p>Next, the SSE stream view. This view will be an <code>async</code> Django view that streams notification data. For simplicity in demonstrating the core SSE mechanism, we'll use a global list or a simple queue in this example to simulate new notifications. In a real application, this would integrate with Django Signals or a message queue (like Redis Pub/Sub via Channels groups) to pick up new notifications as they are created.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/views.py (continued)</span>

<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time <span class="token comment"># For demonstration</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> StreamingHttpResponse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>template<span class="token punctuation">.</span>loader <span class="token keyword">import</span> render_to_string
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone

<span class="token comment"># A very simple in-memory store for new notification events for demonstration.</span>
<span class="token comment"># In a real app, use Django Signals and Channels Groups or a message queue.</span>
<span class="token comment"># This list would be populated by some other part of your application when a notification is created.</span>
<span class="token comment"># For this example, we'll manually add to it or simulate.</span>
_notification_events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment"># user_id: [event_data_str]</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">sse_notifications_stream</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
        <span class="token keyword">return</span> StreamingHttpResponse<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">401</span><span class="token punctuation">)</span> <span class="token comment"># Unauthorized</span>

    user_id <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token builtin">id</span>
    <span class="token keyword">if</span> user_id <span class="token keyword">not</span> <span class="token keyword">in</span> _notification_events<span class="token punctuation">:</span>
        _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">event_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        last_event_id <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HTTP_LAST_EVENT_ID'</span><span class="token punctuation">)</span>
        <span class="token comment"># Implement logic for resending missed events if last_event_id is present (more advanced)</span>

        <span class="token comment"># Send a comment to keep the connection alive if needed by proxies</span>
        <span class="token keyword">yield</span> <span class="token string">"event: PING\ndata: {}\n\n"</span>

        <span class="token comment"># Simulate checking for new notifications</span>
        <span class="token comment"># In a real app, this would be event-driven (e.g., using asyncio.Queue populated by signals)</span>
        last_check_time <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment"># Check for new notifications for this user (simulated)</span>
            <span class="token comment"># This is a simplified polling mechanism within the SSE stream for demo purposes.</span>
            <span class="token comment"># A better approach uses Django signals -&gt; Channels group -&gt; Consumer.</span>
            <span class="token comment"># Or, if using a shared queue like _notification_events:</span>
            current_user_events <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> user_id <span class="token keyword">in</span> _notification_events <span class="token keyword">and</span> _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">:</span>
                current_user_events <span class="token operator">=</span> _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment"># Copy</span>
                _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># Clear for this user</span>

            <span class="token keyword">for</span> event_data_str <span class="token keyword">in</span> current_user_events<span class="token punctuation">:</span>
                <span class="token keyword">yield</span> event_data_str <span class="token comment"># event_data_str is already formatted SSE message</span>

            <span class="token comment"># More robust: Query DB for notifications newer than last_check_time</span>
            <span class="token comment"># new_notifications = Notification.objects.filter(</span>
            <span class="token comment">#     user=request.user,</span>
            <span class="token comment">#     timestamp__gt=last_check_time</span>
            <span class="token comment"># ).order_by('timestamp') # Process in order</span>

            <span class="token comment"># for notification in new_notifications:</span>
            <span class="token comment">#     # Render the partial template for the notification</span>
            <span class="token comment">#     html_content = render_to_string(</span>
            <span class="token comment">#         'notifications_app/partials/notification_item.html',</span>
            <span class="token comment">#         {'notification': notification}</span>
            <span class="token comment">#     ).replace('\n', '') # SSE data should not have newlines unless part of multi-line data</span>

            <span class="token comment">#     # Render the partial for the badge</span>
            <span class="token comment">#     unread_count = Notification.objects.filter(user=request.user, is_read=False).count()</span>
            <span class="token comment">#     badge_html = render_to_string(</span>
            <span class="token comment">#         'notifications_app/partials/notification_badge.html',</span>
            <span class="token comment">#         {'unread_count': unread_count}</span>
            <span class="token comment">#     ).replace('\n', '')</span>

            <span class="token comment">#     # SSE format: data: &lt;message&gt;\n\n</span>
            <span class="token comment">#     # For OOB, HTMX expects multiple "event: message" blocks or specific event names</span>
            <span class="token comment">#     # if hx-sse="swap:&lt;event_name&gt;" is used.</span>
            <span class="token comment">#     # For OOB with default "message" event:</span>
            <span class="token comment">#     # Send notification item</span>
            <span class="token comment">#     yield f"event: message\ndata: {html_content}\n\n"</span>
            <span class="token comment">#     # Send badge update (OOB)</span>
            <span class="token comment">#     yield f"event: message\ndata: {badge_html}\n\n" # HTMX will process based on hx-swap-oob</span>

            <span class="token comment">#     last_check_time = notification.timestamp</span>
            
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># Check every 2 seconds (adjust as needed)</span>
            <span class="token comment"># A real implementation would await an event from a queue/signal.</span>

    response <span class="token operator">=</span> StreamingHttpResponse<span class="token punctuation">(</span>event_stream<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content_type<span class="token operator">=</span><span class="token string">"text/event-stream"</span><span class="token punctuation">)</span>
    response<span class="token punctuation">[</span><span class="token string">'Cache-Control'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'no-cache'</span>
    <span class="token keyword">return</span> response

<span class="token comment"># Helper to simulate adding a notification (call this from another view, signal, or management command)</span>
<span class="token keyword">def</span> <span class="token function">add_mock_notification_event</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> message_content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Create and save the actual notification</span>
    notification <span class="token operator">=</span> Notification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">,</span> message<span class="token operator">=</span>message_content<span class="token punctuation">)</span>

    <span class="token comment"># 2. Prepare the HTML partials for SSE</span>
    html_content <span class="token operator">=</span> render_to_string<span class="token punctuation">(</span>
        <span class="token string">'notifications_app/partials/notification_item.html'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">'notification'</span><span class="token punctuation">:</span> notification<span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

    unread_count <span class="token operator">=</span> Notification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">,</span> is_read<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    badge_html <span class="token operator">=</span> render_to_string<span class="token punctuation">(</span>
        <span class="token string">'notifications_app/partials/notification_badge.html'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">'unread_count'</span><span class="token punctuation">:</span> unread_count<span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment"># 3. Format as SSE messages</span>
    <span class="token comment"># For OOB, HTMX expects separate data payloads if they target different things via hx-swap-oob</span>
    <span class="token comment"># The default event name is 'message'. HTMX processes based on hx-target and hx-swap-oob.</span>
    <span class="token comment"># We send two distinct data payloads. HTMX will apply them based on their content.</span>
    <span class="token comment"># One is the notification item, the other is the badge with hx-swap-oob="true".</span>
    
    <span class="token comment"># This assumes the notification_item.html does NOT have hx-swap-oob,</span>
    <span class="token comment"># and notification_badge.html DOES have hx-swap-oob="true" on its root element.</span>
    
    <span class="token comment"># SSE message for the new notification item</span>
    sse_message_item <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"event: new_notification\nid: </span><span class="token interpolation"><span class="token punctuation">{</span>notification<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">\ndata: </span><span class="token interpolation"><span class="token punctuation">{</span>html_content<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
    <span class="token comment"># SSE message for the badge update (which itself contains hx-swap-oob)</span>
    sse_message_badge <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"event: badge_update\nid: badge_</span><span class="token interpolation"><span class="token punctuation">{</span>notification<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">\ndata: </span><span class="token interpolation"><span class="token punctuation">{</span>badge_html<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>


    user_id <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token builtin">id</span>
    <span class="token keyword">if</span> user_id <span class="token keyword">not</span> <span class="token keyword">in</span> _notification_events<span class="token punctuation">:</span>
        _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token comment"># Add both messages to the queue for the user</span>
    _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>sse_message_item<span class="token punctuation">)</span>
    _notification_events<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>sse_message_badge<span class="token punctuation">)</span>

    <span class="token comment"># In a more robust system using Channels groups:</span>
    <span class="token comment"># from channels.layers import get_channel_layer</span>
    <span class="token comment"># from asgiref.sync import async_to_sync</span>
    <span class="token comment"># channel_layer = get_channel_layer()</span>
    <span class="token comment"># async_to_sync(channel_layer.group_send)(</span>
    <span class="token comment">#     f"notifications_{user.id}",</span>
    <span class="token comment">#     {</span>
    <span class="token comment">#         "type": "send_notification", # Corresponds to a method in the consumer</span>
    <span class="token comment">#         "message_item_html": html_content,</span>
    <span class="token comment">#         "badge_html": badge_html,</span>
    <span class="token comment">#         "notification_id": notification.id</span>
    <span class="token comment">#     }</span>
    <span class="token comment"># )</span>
</code></pre>
<p>Let's break down <code>sse_notifications_stream</code>:</p>
<ol>
<li><code>@login_required</code> (implicitly, as it checks <code>request.user.is_authenticated</code>): Ensures only logged-in users can connect.</li>
<li><code>event_stream()</code>: This is an asynchronous generator. Django's <code>StreamingHttpResponse</code> can consume such generators to stream data.
<ul>
<li><code>yield "event: PING\ndata: {}\n\n"</code>: Sends an initial SSE comment. This can help keep the connection alive through proxies and also signals to the client that the connection is established.</li>
<li><code>while True:</code>: The loop keeps the connection open.</li>
<li><strong>Notification Logic (Simplified for Demo):</strong>
<ul>
<li><code>_notification_events</code>: A global dictionary used here to simulate an event queue. In a real application, this is where you'd integrate with a more robust system:
<ul>
<li><strong>Django Signals:</strong> A <code>post_save</code> signal on the <code>Notification</code> model could trigger an event.</li>
<li><strong>Channels Groups &amp; Layers:</strong> The signal handler would send a message to a user-specific Channels group. The SSE consumer (if using one) or this <code>async</code> view (if adapted) would listen to this group.</li>
</ul>
</li>
<li>The current code simulates checking this queue.</li>
</ul>
</li>
<li><code>yield f"event: &lt;event_name&gt;\nid: &lt;unique_id&gt;\ndata: {html_payload}\n\n"</code>: This is the standard SSE message format.
<ul>
<li><code>event: &lt;event_name&gt;</code>: Specifies the event type. HTMX can listen for specific event names using <code>hx-sse="swap:&lt;event_name&gt;"</code>. If omitted, it defaults to <code>message</code>.</li>
<li><code>id: &lt;unique_id&gt;</code>: An optional unique ID for the event. If the connection drops, the browser can send this ID back in the <code>Last-Event-ID</code> header, allowing the server to resend missed events.</li>
<li><code>data: {html_payload}</code>: The actual data payload. For HTMX, this is typically an HTML fragment. <strong>Important:</strong> If <code>html_payload</code> contains newlines, they must be handled correctly (e.g., by replacing them or using multi-line <code>data: field\ndata: field2</code>).</li>
</ul>
</li>
<li><code>await asyncio.sleep(2)</code>: Pauses for 2 seconds before checking again. In a truly event-driven system, this would be <code>await queue.get()</code> or similar, blocking until a new event arrives.</li>
</ul>
</li>
<li><code>StreamingHttpResponse(event_stream(), content_type="text/event-stream")</code>: Creates the streaming response.
<ul>
<li><code>content_type="text/event-stream"</code>: Essential for SSE.</li>
<li><code>response['Cache-Control'] = 'no-cache'</code>: Prevents caching of the stream.</li>
</ul>
</li>
</ol>
<p>The <code>add_mock_notification_event</code> function is a helper to demonstrate how new notification events (HTML partials) would be generated and added to our simple queue. It renders two partials: one for the notification item itself and one for the badge.</p>
<p><strong>3. URL Configuration</strong></p>
<p>Add URL patterns for these views in <code>notifications_app/urls.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/urls.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

app_name <span class="token operator">=</span> <span class="token string">'notifications_app'</span>

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'notifications/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>notification_page<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'notification_page'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'notifications/stream/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>sse_notifications_stream<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sse_notifications_stream'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># Example URL to trigger a mock notification for the logged-in user</span>
    <span class="token comment"># path('notifications/add-mock/', views.trigger_mock_notification_view, name='add_mock_notification'),</span>
<span class="token punctuation">]</span>
</code></pre>
<p>And include these app URLs in your project's <code>urls.py</code>:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># project/urls.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'accounts/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'django.contrib.auth.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># For login/logout</span>
    path<span class="token punctuation">(</span><span class="token string">'app/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'notifications_app.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># ... other project urls</span>
<span class="token punctuation">]</span>
</code></pre>
<p><strong>4. Template Setup for SSE with HTMX</strong></p>
<p>Now, let's create the templates.
Base template (e.g., <code>base.html</code>):</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- templates/base.html (simplified) --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Real-Time Notifications<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/htmx.org@1.9.10<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//unpkg.com/alpinejs<span class="token punctuation">"</span></span> <span class="token attr-name">defer</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
        <span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.notifications-container</span> <span class="token punctuation">{</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">margin-top</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token property">min-height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span> <span class="token property">background-color</span><span class="token punctuation">:</span> #f9f9f9<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.notification-item</span> <span class="token punctuation">{</span> <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #eee<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 8px 0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.notification-item:last-child</span> <span class="token punctuation">{</span> <span class="token property">border-bottom</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.notification-badge</span> <span class="token punctuation">{</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 2px 6px<span class="token punctuation">;</span>
            <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">.htmx-indicator</span><span class="token punctuation">{</span> <span class="token property">opacity</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span> <span class="token property">transition</span><span class="token punctuation">:</span> opacity 200ms ease-in<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token selector">.htmx-request .htmx-indicator</span><span class="token punctuation">{</span> <span class="token property">opacity</span><span class="token punctuation">:</span>1 <span class="token punctuation">}</span>
        <span class="token selector">.htmx-request.htmx-indicator</span><span class="token punctuation">{</span> <span class="token property">opacity</span><span class="token punctuation">:</span>1 <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> |
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'notifications_app:notification_page' %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            Notifications
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-badge-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                {% include 'notifications_app/partials/notification_badge.html' with unread_count=unread_count|default:0 %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        {% if user.is_authenticated %}
            | <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>Welcome, {{ user.username }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            | <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'logout' %}?next={{ request.path }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Logout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Add a button to simulate creating a notification --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'notifications_app:add_mock_notification' %}<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
                {% csrf_token %}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Create Mock Notification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
        {% else %}
            | <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'login' %}?next={{ request.path }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        {% endif %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>

    {% block content %}
    {% endblock %}

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>This base template includes HTMX, Alpine.js, basic styling, and a navigation bar. The key part is <code>&lt;span id="notification-badge-container"&gt;</code> which will hold our badge, initially rendered with the count from the main view.</p>
<p>Notification page template:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- notifications_app/templates/notifications_app/notification_page.html --&gt;</span>
{% extends "base.html" %}

{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Your Notifications<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">hx-ext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sse<span class="token punctuation">"</span></span> <span class="token attr-name">sse-connect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'notifications_app:sse_notifications_stream' %}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notifications-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">sse-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>new_notification<span class="token punctuation">"</span></span> <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#notification-list<span class="token punctuation">"</span></span> <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>afterbegin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- This div listens for 'new_notification' SSE events.
             When an event is received, its data (HTML) will be swapped into #notification-list.
             The hx-target and hx-swap on this element specify where the content from THIS event goes.
        --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">sse-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>badge_update<span class="token punctuation">"</span></span> <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#notification-badge-container<span class="token punctuation">"</span></span> <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- This div listens for 'badge_update' SSE events.
             Its data (HTML for the badge) will be swapped into #notification-badge-container.
        --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% if notifications %}
            {% for notification in notifications %}
                {% include 'notifications_app/partials/notification_item.html' %}
            {% endfor %}
        {% else %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-notifications-message<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>No notifications yet.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        {% endif %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Connecting to stream...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Let's examine this template:</p>
<ol>
<li><code>{% extends "base.html" %}</code>: Inherits from our base template.</li>
<li><code>&lt;div hx-ext="sse" sse-connect="{% url 'notifications_app:sse_notifications_stream' %}" ...&gt;</code>: This is the main HTMX setup for SSE.
<ul>
<li><code>hx-ext="sse"</code>: Enables the Server-Sent Events extension for HTMX.</li>
<li><code>sse-connect="{% url 'notifications_app:sse_notifications_stream' %}"</code>: Tells HTMX to establish an SSE connection to the specified URL.</li>
</ul>
</li>
<li><code>&lt;div sse-swap="new_notification" hx-target="#notification-list" hx-swap="afterbegin"&gt;</code>:
<ul>
<li><code>sse-swap="new_notification"</code>: This tells HTMX to listen for SSE events specifically named <code>new_notification</code>.</li>
<li><code>hx-target="#notification-list"</code>: The content of these events (expected to be HTML for a new notification item) will be placed inside the element with <code>id="notification-list"</code>.</li>
<li><code>hx-swap="afterbegin"</code>: The new HTML will be prepended as the first child of the target element, effectively adding new notifications to the top of the list.</li>
</ul>
</li>
<li><code>&lt;div sse-swap="badge_update" hx-target="#notification-badge-container" hx-swap="innerHTML"&gt;</code>:
<ul>
<li><code>sse-swap="badge_update"</code>: Listens for SSE events named <code>badge_update</code>.</li>
<li><code>hx-target="#notification-badge-container"</code>: The content of these events (HTML for the updated badge) will replace the content of the element with <code>id="notification-badge-container"</code>.</li>
<li><code>hx-swap="innerHTML"</code>: The entire inner HTML of the target is replaced.</li>
</ul>
</li>
<li><code>&lt;div id="notification-list"&gt;</code>: This is where the initial list of notifications is rendered and where new notifications will be prepended.</li>
<li><code>{% include 'notifications_app/partials/notification_item.html' %}</code>: Each existing notification is rendered using a partial template.</li>
<li><code>&lt;p class="htmx-indicator"&gt;Connecting to stream...&lt;/p&gt;</code>: A loading indicator shown while HTMX is establishing the SSE connection or during requests.</li>
</ol>
<p>Partial template for a single notification item:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- notifications_app/templates/notifications_app/partials/notification_item.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-item<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-{{ notification.id }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>{{ notification.user.username }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> ({{ notification.timestamp|timesince }} ago)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ notification.message }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    {% if not notification.is_read %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">&gt;</span></span>(Unread)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Add a button to mark as read via HTMX POST if desired --&gt;</span>
    {% endif %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>This partial defines how each notification looks. The <code>id="notification-{{ notification.id }}"</code> can be useful for targeting specific items later if needed.</p>
<p>Partial template for the notification badge:</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- notifications_app/templates/notifications_app/partials/notification_badge.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-badge<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-badge-actual<span class="token punctuation">"</span></span><span class="token attr-name">{%</span> <span class="token attr-name">if</span> <span class="token attr-name">unread_count</span> <span class="token punctuation">&gt;</span></span> 0 %} hx-swap-oob="true"{% endif %}&gt;
    {% if unread_count &gt; 0 %}
        {{ unread_count }}
    {% endif %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Let's examine this badge partial:</p>
<ol>
<li><code>id="notification-badge-actual"</code>: A specific ID for the badge itself.</li>
<li><code>{% if unread_count &gt; 0 %} hx-swap-oob="true"{% endif %}</code>: This is crucial for Out-of-Band swaps.
<ul>
<li><code>hx-swap-oob="true"</code>: When this HTML fragment is part of a larger HTMX response (or an SSE message that HTMX processes), this attribute tells HTMX to find an element with the same <code>id</code> (<code>notification-badge-actual</code>) elsewhere on the page and swap this content into it. This allows the SSE stream to update both the main notification list and this badge simultaneously, even though the badge is outside the primary <code>hx-target</code> of the SSE event listener.</li>
<li>We only add <code>hx-swap-oob="true"</code> if there are unread notifications. If the count is zero, we might not want it to be an OOB target, or we might want it to render an empty span. The server sending the <code>badge_update</code> event will send this whole partial.</li>
<li><strong>Correction/Clarification for OOB with SSE:</strong> The <code>hx-swap-oob</code> attribute should be on the HTML <em>sent by the server</em> in the SSE <code>data</code> payload. The <code>sse-swap</code> directive on the client side defines which event to listen to. The server then sends HTML that includes elements with <code>id</code>s and <code>hx-swap-oob="true"</code>.</li>
<li>The <code>sse-swap="badge_update"</code> listener in <code>notification_page.html</code> will receive the rendered <code>notification_badge.html</code> partial. HTMX will then see the <code>hx-swap-oob="true"</code> on the root <code>&lt;span&gt;</code> of this partial and perform the OOB swap into the element with <code>id="notification-badge-actual"</code> (which is inside <code>#notification-badge-container</code>).</li>
</ul>
</li>
</ol>
<p>To make the "Create Mock Notification" button work, we need a simple view:</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/views.py (add this view)</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> redirect
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse

<span class="token decorator annotation punctuation">@login_required</span>
<span class="token keyword">def</span> <span class="token function">trigger_mock_notification_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token comment"># In a real app, you might have a form to customize the message</span>
        message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"This is a mock notification triggered at </span><span class="token interpolation"><span class="token punctuation">{</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        add_mock_notification_event<span class="token punctuation">(</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token comment"># Use our helper</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HTTP_REFERER'</span><span class="token punctuation">,</span> reverse<span class="token punctuation">(</span><span class="token string">'notifications_app:notification_page'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'notifications_app:notification_page'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># And add to notifications_app/urls.py:</span>
<span class="token comment"># path('notifications/add-mock/', views.trigger_mock_notification_view, name='add_mock_notification'),</span>
</code></pre>
<p>This view, when POSTed to, calls <code>add_mock_notification_event</code> for the current user, which in turn populates our demo <code>_notification_events</code> queue. The SSE stream view will then pick this up and send it to the client.</p>
<p><strong>How it all works together (SSE Flow):</strong></p>
<ol>
<li>User loads <code>notification_page.html</code>.</li>
<li>HTMX sees <code>sse-connect</code> and establishes an SSE connection to <code>/app/notifications/stream/</code>.</li>
<li>The <code>sse_notifications_stream</code> view on the server keeps this connection open.</li>
<li>When <code>add_mock_notification_event</code> is called (e.g., by the button or some other system event):
<ul>
<li>A <code>Notification</code> object is created.</li>
<li>HTML partials for the new item (<code>notification_item.html</code>) and the updated badge (<code>notification_badge.html</code>) are rendered.</li>
<li>These HTML strings are formatted as SSE messages (e.g., <code>event: new_notification\ndata: ...</code> and <code>event: badge_update\ndata: ...</code>) and added to <code>_notification_events[user_id]</code>.</li>
</ul>
</li>
<li>The <code>event_stream</code> generator in <code>sse_notifications_stream</code> periodically checks <code>_notification_events</code>. When it finds new messages:
<ul>
<li>It <code>yield</code>s them over the SSE connection.</li>
</ul>
</li>
<li>On the client (<code>notification_page.html</code>):
<ul>
<li>The <code>&lt;div sse-swap="new_notification" ...&gt;</code> listens for <code>new_notification</code> events. When one arrives, its HTML data is prepended to <code>#notification-list</code>.</li>
<li>The <code>&lt;div sse-swap="badge_update" ...&gt;</code> listens for <code>badge_update</code> events. When one arrives, its HTML data (which is the rendered <code>notification_badge.html</code> partial containing <code>hx-swap-oob="true"</code>) is processed. HTMX sees <code>hx-swap-oob="true"</code> on the root element of this data and swaps it into the element with <code>id="notification-badge-actual"</code> (which is inside <code>#notification-badge-container</code>).</li>
</ul>
</li>
</ol>
<p><strong>5. (Alternative) Polling with HTMX</strong></p>
<p>If SSE is not suitable or overly complex for a situation, HTMX makes polling very easy as an alternative.
To implement polling:</p>
<ol>
<li>
<p><strong>Create a Django view that returns only new notifications as HTML partials.</strong> This view might take a timestamp parameter to fetch notifications newer than that, or simply return the latest N notifications.</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># THIS_CODE_SNIPPET</span>
<span class="token comment"># notifications_app/views.py (example polling view)</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>template<span class="token punctuation">.</span>loader <span class="token keyword">import</span> render_to_string
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Notification
<span class="token keyword">import</span> datetime

<span class="token decorator annotation punctuation">@login_required</span>
<span class="token keyword">def</span> <span class="token function">poll_new_notifications</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Get the timestamp of the latest notification the client knows about</span>
    <span class="token comment"># This could be passed as a query parameter, e.g., ?since=&lt;timestamp&gt;</span>
    <span class="token comment"># For simplicity, let's just fetch the very latest unread ones not yet displayed.</span>
    <span class="token comment"># A more robust polling would need client to send last received ID or timestamp.</span>

    <span class="token comment"># This example just sends all unread notifications as a bundle.</span>
    <span class="token comment"># In a real scenario, you'd only send what's new since the last poll.</span>
    new_notifications <span class="token operator">=</span> Notification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> is_read<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-timestamp'</span><span class="token punctuation">)</span> <span class="token comment">#[:5]</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> new_notifications<span class="token punctuation">:</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">204</span><span class="token punctuation">)</span> <span class="token comment"># No Content</span>

    <span class="token comment"># For polling, you might want to send multiple items and the badge update together.</span>
    <span class="token comment"># One way is to render a container that includes all new items and the OOB badge.</span>
    
    <span class="token comment"># Let's assume we send one notification at a time for simplicity of swapping,</span>
    <span class="token comment"># or a block of new notifications.</span>
    <span class="token comment"># For this example, we'll just render the latest one if it's new.</span>
    <span class="token comment"># A more complex polling view would handle sending multiple items and the badge.</span>

    <span class="token comment"># Simplified: just send the latest 5 notifications and the badge.</span>
    <span class="token comment"># The client would replace its list.</span>
    
    html_parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> notification <span class="token keyword">in</span> new_notifications<span class="token punctuation">:</span>
        html_parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>render_to_string<span class="token punctuation">(</span>
            <span class="token string">'notifications_app/partials/notification_item.html'</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">'notification'</span><span class="token punctuation">:</span> notification<span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    unread_count <span class="token operator">=</span> new_notifications<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Or re-query for accuracy</span>
    badge_html <span class="token operator">=</span> render_to_string<span class="token punctuation">(</span>
        <span class="token string">'notifications_app/partials/notification_badge.html'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">'unread_count'</span><span class="token punctuation">:</span> unread_count<span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># Add the badge HTML with OOB swap attribute to the response</span>
    <span class="token comment"># The badge partial itself has hx-swap-oob="true"</span>
    
    <span class="token comment"># Combine all parts. HTMX will process them.</span>
    <span class="token comment"># The main content (notification items) will go to the target.</span>
    <span class="token comment"># The badge_html, because it contains hx-swap-oob, will go to its designated OOB target.</span>
    full_response_html <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>html_parts<span class="token punctuation">)</span> <span class="token operator">+</span> badge_html
    
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>full_response_html<span class="token punctuation">)</span>
</code></pre>
<p>This polling view is simplified. A robust version would need to track what the client has already seen to avoid sending duplicates and to manage the "newness" correctly. It now sends a combined HTML string containing new notification items and the badge HTML (which has <code>hx-swap-oob</code>).</p>
</li>
<li>
<p><strong>Modify the template to use HTMX polling attributes instead of SSE:</strong></p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- notifications_app/templates/notifications_app/notification_page_polling.html (example) --&gt;</span>
{% extends "base.html" %}

{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Your Notifications (Polling Example)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-list-wrapper<span class="token punctuation">"</span></span>
     <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'notifications_app:poll_new_notifications' %}<span class="token punctuation">"</span></span>
     <span class="token attr-name">hx-trigger</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>every 5s<span class="token punctuation">"</span></span>
     <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span> <span class="token attr-name">&lt;!--</span> <span class="token attr-name">Or</span> <span class="token attr-name">a</span> <span class="token attr-name">more</span> <span class="token attr-name">specific</span> <span class="token attr-name">swap</span> <span class="token attr-name">like</span> <span class="token attr-name">afterbegin</span> <span class="token attr-name">if</span> <span class="token attr-name">view</span> <span class="token attr-name">returns</span> <span class="token attr-name">only</span> <span class="token attr-name">new</span> <span class="token attr-name">items</span> <span class="token attr-name">--</span><span class="token punctuation">&gt;</span></span>
     hx-target="#notification-list"&gt; <span class="token comment">&lt;!-- Target for the main notification items --&gt;</span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% if notifications %}
            {% for notification in notifications %}
                {% include 'notifications_app/partials/notification_item.html' %}
            {% endfor %}
        {% else %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-notifications-message<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>No notifications yet.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        {% endif %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Checking for new notifications...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>In this polling setup:</p>
<ul>
<li><code>hx-get</code>: Specifies the URL to poll.</li>
<li><code>hx-trigger="every 5s"</code>: Tells HTMX to send a GET request to this URL every 5 seconds.</li>
<li><code>hx-swap="innerHTML"</code> (if replacing the whole list) or <code>afterbegin</code> (if appending). The server response from <code>poll_new_notifications</code> would contain the HTML for new items AND the OOB badge. HTMX processes the response: primary content goes to <code>hx-target</code>, OOB content goes to its OOB target.</li>
<li>The <code>poll_new_notifications</code> view needs to be designed to return HTML that includes both the new notification items for the main target and the badge HTML (which itself contains <code>hx-swap-oob="true"</code>) for the out-of-band update.</li>
</ul>
</li>
</ol>
<p><strong>Polling vs. SSE Trade-offs:</strong></p>
<ul>
<li><strong>SSE:</strong> More real-time, less latency. Can be more complex on the server to manage many persistent connections (though Channels helps). Efficient if updates are frequent or immediate delivery is critical.</li>
<li><strong>Polling:</strong> Simpler server-side logic for the endpoint itself. Introduces latency (updates are delayed by the polling interval). Can cause higher server load if the interval is too short or many clients are polling. Good for less critical updates or as a fallback.</li>
</ul>
<p><strong>6. Alpine.js for UI Polish</strong></p>
<p>Alpine.js can add small enhancements. For example, smoothly showing/hiding the "No notifications yet" message.</p>
<p>Modify <code>notification_page.html</code> (SSE version):</p>
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- THIS_CODE_SNIPPET --&gt;</span>
<span class="token comment">&lt;!-- notifications_app/templates/notifications_app/notification_page.html (with Alpine.js) --&gt;</span>
{% extends "base.html" %}

{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Your Notifications<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">hx-ext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sse<span class="token punctuation">"</span></span> <span class="token attr-name">sse-connect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'notifications_app:sse_notifications_stream' %}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notifications-container<span class="token punctuation">"</span></span>
     <span class="token attr-name">x-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ hasNotifications: {{ notifications|length &gt; 0 }} }<span class="token punctuation">"</span></span>
     <span class="token attr-name"><span class="token namespace">@htmx:</span>after-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>if ($event.target.id === 'notification-list' &amp;&amp; $event.target.children.length &gt; 0 &amp;&amp; $event.target.querySelector('.notification-item')) { hasNotifications = true; document.getElementById('no-notifications-message')?.remove(); } else if ($event.target.id === 'notification-list' &amp;&amp; $event.target.children.length === 0) { hasNotifications = false; }<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">sse-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>new_notification<span class="token punctuation">"</span></span> <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#notification-list<span class="token punctuation">"</span></span> <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>afterbegin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">sse-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>badge_update<span class="token punctuation">"</span></span> <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#notification-badge-container<span class="token punctuation">"</span></span> <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notification-list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% if notifications %}
            {% for notification in notifications %}
                {% include 'notifications_app/partials/notification_item.html' %}
            {% endfor %}
        {% else %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">x-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!hasNotifications<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-notifications-message<span class="token punctuation">"</span></span> <span class="token attr-name">x-transition</span><span class="token punctuation">&gt;</span></span>No notifications yet.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        {% endif %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmx-indicator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Connecting to stream...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Alpine.js enhancements:</p>
<ol>
<li><code>x-data="{ hasNotifications: {{ notifications|length &gt; 0 }} }"</code>: Initializes an Alpine component on the main container. <code>hasNotifications</code> is true if there are initial notifications.</li>
<li><code>@htmx:after-swap="..."</code>: Listens for HTMX's <code>afterSwap</code> event.
<ul>
<li>When content is swapped into <code>#notification-list</code>:
<ul>
<li>If <code>#notification-list</code> now contains <code>.notification-item</code> elements, it sets <code>hasNotifications = true</code> and attempts to remove the "No notifications" message if it was dynamically added.</li>
<li>If <code>#notification-list</code> becomes empty, it sets <code>hasNotifications = false</code>.</li>
</ul>
</li>
</ul>
</li>
<li><code>&lt;p x-show="!hasNotifications" id="no-notifications-message" x-transition&gt;</code>: The "No notifications yet" message is now controlled by Alpine's <code>x-show</code> based on the <code>hasNotifications</code> state and will use a default transition.
<ul>
<li><strong>Note:</strong> If new notifications are prepended, the initial "No notifications" message (if present from server render) needs to be handled. The <code>@htmx:after-swap</code> logic tries to remove it. A cleaner way might be to ensure the server never sends this message if <code>notifications</code> is empty initially, and Alpine solely manages its appearance based on the list content. Or, the SSE event for <code>new_notification</code> could also carry an OOB swap to remove this message.</li>
</ul>
</li>
</ol>
<p>This project demonstrates a powerful pattern for real-time updates in Django using SSE and HTMX, with Alpine.js providing subtle client-side enhancements. The key is the clear separation of concerns: Django handles data and business logic, the SSE stream provides the real-time data pipe, HTMX declaratively handles DOM updates from this stream, and Alpine.js manages fine-grained local UI state.</p>
<h2 id="135-cross-project-best-practices-and-reflections" tabindex="-1"><a class="anchor" href="#135-cross-project-best-practices-and-reflections" name="135-cross-project-best-practices-and-reflections" tabindex="-1"><span class="octicon octicon-link"></span></a>13.5 Cross-Project Best Practices and Reflections</h2>
<p>Having journeyed through the implementation of several distinct applications—the Interactive To-Do List, the Live Search and Filterable Product Catalog, and the Simple Real-Time Notification Feed—we've seen the powerful synergy of Django, HTMX, and Alpine.js in action. These projects, while diverse in their specific goals, illuminate a set of common principles and practices that are crucial for building robust, maintainable, and reactive web applications. This section distills those experiences into actionable best practices and reflections, focusing on code organization, testing strategies, error handling, and the philosophy of progressive enhancement. Adopting these practices will not only improve the quality of your current projects but also provide a solid foundation for future development endeavors within this stack.</p>
<h3 id="1351-code-organization-views-templates-partials" tabindex="-1"><a class="anchor" href="#1351-code-organization-views-templates-partials" name="1351-code-organization-views-templates-partials" tabindex="-1"><span class="octicon octicon-link"></span></a>13.5.1 Code Organization (Views, Templates, Partials)</h3>
<p>Effective organization of your codebase is paramount, especially as applications grow in complexity. With the introduction of HTMX and its emphasis on partial page updates, thoughtful structuring of views, templates, and partials becomes even more critical. The goal is to maintain clarity, reduce redundancy, and ensure that components are easy to locate, understand, and modify.</p>
<p><strong>Organizing Django Views for Full and Partial Responses</strong></p>
<p>When integrating HTMX, Django views often need to serve both full HTML documents (for initial page loads) and HTML fragments (for HTMX-triggered updates). There are several strategies to manage this:</p>
<ol>
<li>
<p><strong>Conditional Logic within a Single View:</strong> A common approach is to use a single view that inspects the <code>request.htmx</code> attribute (provided by <code>django-htmx</code> or by checking for the <code>HX-Request</code> header manually) to determine whether to render a full template or a partial.</p>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># myapp/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Item

<span class="token keyword">def</span> <span class="token function">item_list_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    items <span class="token operator">=</span> Item<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'items'</span><span class="token punctuation">:</span> items<span class="token punctuation">}</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token comment"># For HTMX requests, return only the item list partial</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_item_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token comment"># For regular requests, return the full page</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/item_list_page.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre>
<p>Let's examine this code in detail:</p>
<ol>
<li>First, we define a standard Django view <code>item_list_view</code> that takes a <code>request</code> object.
<ul>
<li>This view is responsible for displaying a list of <code>Item</code> objects.</li>
</ul>
</li>
<li>Next, we retrieve all <code>Item</code> objects and prepare a <code>context</code> dictionary.
<ul>
<li>This data is needed for both full page renders and partial updates.</li>
</ul>
</li>
<li>The conditional logic <code>if request.htmx:</code> checks if the incoming request is an HTMX request.
<ul>
<li>The <code>request.htmx</code> attribute is a convenient way to detect this, typically added by middleware like <code>django-htmx</code>. If you're not using such middleware, you would check <code>request.headers.get('HX-Request') == 'true'</code>.</li>
<li>If true (it's an HTMX request), we render and return <code>myapp/partials/_item_list.html</code>. This template is designed to contain <em>only</em> the HTML fragment for the item list itself.
<ul>
<li>This approach ensures that HTMX receives a minimal, targeted HTML snippet, which is efficient for swapping.</li>
</ul>
</li>
<li>If false (it's a standard browser request), we render and return <code>myapp/item_list_page.html</code>. This template would typically extend a base template and include the item list partial within a larger page structure.
<ul>
<li>This ensures the page is fully functional on initial load or if JavaScript/HTMX is unavailable.</li>
</ul>
</li>
</ul>
</li>
<li>This pattern centralizes the logic for a given resource (the item list) in one view, while still catering to different rendering needs.
<ul>
<li>The "why" behind this choice is often to keep related logic co-located. However, for very complex views, this can lead to clutter.</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>Separate Views for Partials:</strong> For more complex scenarios or to enforce a stricter separation of concerns, you can create distinct views for serving partials.</p>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># myapp/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Item

<span class="token keyword">def</span> <span class="token function">item_list_page_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># This view always serves the full page</span>
    items <span class="token operator">=</span> Item<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'items'</span><span class="token punctuation">:</span> items<span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/item_list_page.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">item_list_partial_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># This view is dedicated to serving the HTMX partial</span>
    <span class="token comment"># It might include additional logic specific to partial updates,</span>
    <span class="token comment"># e.g., different filtering or pagination parameters.</span>
    items <span class="token operator">=</span> Item<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Or apply specific filters for HTMX</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'items'</span><span class="token punctuation">:</span> items<span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_item_list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># myapp/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'items/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>item_list_page_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'item_list_page'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'htmx/items/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>item_list_partial_view<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'item_list_partial'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre>
<p>Let's break down this alternative approach:</p>
<ol>
<li><code>item_list_page_view</code>:
<ul>
<li>This view is solely responsible for rendering the full HTML page. It fetches the necessary data and passes it to a full page template.</li>
<li>Its purpose is to handle the initial, non-HTMX request for the resource.</li>
</ul>
</li>
<li><code>item_list_partial_view</code>:
<ul>
<li>This view is dedicated to generating and returning the HTML fragment for HTMX requests.</li>
<li>It might perform slightly different data fetching or processing logic tailored to partial updates (e.g., optimized queries, different pagination handling).</li>
<li>The "why" for this separation is improved clarity and modularity, especially when the logic for full page loads and partial updates diverges significantly. It adheres more strictly to the Single Responsibility Principle for each view.</li>
</ul>
</li>
<li><code>urls.py</code>:
<ul>
<li>We define two distinct URL patterns, one for the full page and one specifically for the HTMX partial.</li>
<li>This makes the routing explicit and allows HTMX attributes in templates to target the partial-specific URL directly (e.g., <code>hx-get="{% url 'item_list_partial' %}"</code>).</li>
</ul>
</li>
<li>This pattern promotes a cleaner separation, making each view simpler and more focused. It can be particularly beneficial in larger applications where the logic for full pages and partials becomes complex.</li>
</ol>
</li>
</ol>
<p><strong>Structuring Templates and Partials</strong></p>
<p>A well-organized template structure is key to leveraging HTMX effectively. The core idea is to create reusable HTML fragments (partials) that can be independently rendered and swapped.</p>
<ol>
<li>
<p><strong>Directory Structure:</strong></p>
<ul>
<li>Consider a dedicated subdirectory within your app's <code>templates</code> directory for partials, e.g., <code>templates/myapp/partials/</code>.</li>
<li>This keeps them separate from full-page templates and makes their purpose clear.</li>
</ul>
<pre><code>myapp/
├── templates/
│   └── myapp/
│       ├── base.html
│       ├── item_list_page.html
│       └── partials/
│           ├── _item_list.html
│           ├── _item_form.html
│           └── _filter_options.html
└── views.py
</code></pre>
<ul>
<li>The leading underscore (e.g., <code>_item_list.html</code>) is a common convention to denote partials, though not a strict requirement. It visually distinguishes them from full page templates.</li>
</ul>
</li>
<li>
<p><strong>Designing Partials:</strong></p>
<ul>
<li><strong>Self-Contained:</strong> Partials should ideally be self-contained units of HTML. They receive context from the view and render themselves without relying on the parent template's structure beyond what's necessary for the swap.</li>
<li><strong>Targetable:</strong> Ensure the root element of a partial has an <code>id</code> if it's intended to be targeted directly by an <code>hx-target</code> that uses an ID selector.</li>
<li><strong>Reusable:</strong> Design partials for reusability. The same <code>_item_list.html</code> partial might be included in the initial page load and also returned by an HTMX request after a filter is applied.</li>
</ul>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- myapp/templates/myapp/item_list_page.html --&gt;</span>
{% extends "myapp/base.html" %}

{% block content %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>My Items<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-list-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% include "myapp/partials/_item_list.html" with items=items %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Other page content --&gt;</span>
{% endblock %}
</code></pre>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- myapp/templates/myapp/partials/_item_list.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>items<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- Optional: ID for targeting the whole list for replacement --&gt;</span>
    {% for item in items %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-{{ item.id }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ item.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- HTMX actions for this item, e.g., edit, delete --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'item_edit_form' item.id %}<span class="token punctuation">"</span></span>
                    <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#item-{{ item.id }}<span class="token punctuation">"</span></span>
                    <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                Edit
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    {% empty %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>No items found.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    {% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Let's analyze these template snippets:</p>
<ol>
<li>
<p><code>item_list_page.html</code>:</p>
<ul>
<li>This is a full-page template that extends a <code>base.html</code>.</li>
<li><code>{% block content %}</code>: Defines the main content area.</li>
<li><code>&lt;div id="item-list-container"&gt;</code>: This container is important. HTMX requests that update the list might target this ID to replace its entire content.</li>
<li><code>{% include "myapp/partials/_item_list.html" with items=items %}</code>: This is crucial. On initial page load, the item list is rendered by including the partial.
<ul>
<li>The <code>with items=items</code> ensures the partial receives the necessary context.</li>
<li>This demonstrates the DRY (Don't Repeat Yourself) principle: the logic for rendering the item list exists in one place (<code>_item_list.html</code>) and is used for both initial render and subsequent HTMX updates.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>_item_list.html</code>:</p>
<ul>
<li>This is the partial template. It focuses solely on rendering the list of items.</li>
<li><code>&lt;div id="items"&gt;</code>: The root element of the partial. If an HTMX request is designed to replace the entire list, <code>hx-target="#items"</code> (or <code>#item-list-container</code> from the parent) could be used.</li>
<li><code>{% for item in items %}</code>: Iterates through the items passed in the context.</li>
<li><code>&lt;div class="item" id="item-{{ item.id }}"&gt;</code>: Each item has a unique ID. This is vital for HTMX operations that target individual items, such as inline editing (<code>hx-target="#item-{{ item.id }}"</code>) or deleting an item and having it removed from the DOM.</li>
<li>The "Edit" button demonstrates an HTMX GET request. When clicked, it will fetch the edit form for that specific item and replace the entire <code>div</code> for that item (<code>hx-swap="outerHTML"</code>) with the form.</li>
<li><code>{% empty %}</code>: Handles the case where there are no items.</li>
</ul>
</li>
</ol>
<p>This organization ensures that the presentation logic for a piece of UI (like the item list) is encapsulated. When an HTMX request needs to update just that list, the Django view can render <code>_item_list.html</code> with the updated <code>items</code> context, and HTMX will swap it into the correct place in the DOM. This is far more efficient than re-rendering the entire page.</p>
</li>
</ol>
<p><strong>Alpine.js Component Scope</strong></p>
<p>When using Alpine.js, its directives (<code>x-data</code>, <code>x-show</code>, etc.) are typically embedded directly within your Django templates or partials.</p>
<ul>
<li><strong>Co-location:</strong> Alpine.js encourages co-locating your JavaScript logic with the HTML it controls. This means Alpine directives will naturally live within your Django templates, including partials.</li>
<li><strong>Initialization in Partials:</strong> If an HTMX-loaded partial contains Alpine.js components (<code>x-data</code>), Alpine.js will automatically initialize these new components when they are swapped into the DOM. This is a key strength of Alpine.js – it seamlessly works with dynamically added content.</li>
<li><strong>State Management:</strong> For state that needs to persist across HTMX swaps or be shared, consider Alpine.js global stores (<code>Alpine.store(...)</code>) or ensure the <code>x-data</code> scope is on an element that is <em>not</em> replaced by an HTMX swap if you want to preserve local component state.</li>
</ul>
<p>By thoughtfully organizing views to handle both full and partial requests, and by structuring templates into reusable, targetable partials, you create a maintainable and scalable architecture for your Django, HTMX, and Alpine.js applications. This modularity is the bedrock of building reactive interfaces efficiently.</p>
<h3 id="1352-testing-strategies-django-test-client-e2e" tabindex="-1"><a class="anchor" href="#1352-testing-strategies-django-test-client-e2e" name="1352-testing-strategies-django-test-client-e2e" tabindex="-1"><span class="octicon octicon-link"></span></a>13.5.2 Testing Strategies (Django Test Client, E2E)</h3>
<p>A reactive application built with Django, HTMX, and Alpine.js involves interactions across the server and client. A comprehensive testing strategy should cover both the server-side logic (Django views, partial rendering) and the end-to-end user experience.</p>
<p><strong>Testing HTMX Endpoints with Django's Test Client</strong></p>
<p>Django's built-in test client is invaluable for testing the server-side aspects of your HTMX integration. The key is to simulate HTMX requests by including the appropriate headers.</p>
<ol>
<li>
<p><strong>Simulating HTMX Requests:</strong></p>
<ul>
<li>HTMX identifies its requests by adding an <code>HX-Request: true</code> header. Your tests need to replicate this.</li>
<li>If you're using <code>django-htmx</code>, it also sets <code>request.htmx</code> to <code>True</code>. Testing the header directly is a robust approach.</li>
</ul>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># myapp/tests.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> TestCase<span class="token punctuation">,</span> Client
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Item

<span class="token keyword">class</span> <span class="token class-name">ItemListViewTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>item1 <span class="token operator">=</span> Item<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Test Item 1"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>list_url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'item_list_page'</span><span class="token punctuation">)</span> <span class="token comment"># Assuming 'item_list_page' can handle HTMX</span>
        <span class="token comment"># Or, if you have a dedicated partial URL:</span>
        <span class="token comment"># self.partial_url = reverse('item_list_partial')</span>

    <span class="token keyword">def</span> <span class="token function">test_item_list_renders_full_page_for_normal_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>list_url<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTemplateUsed<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'myapp/item_list_page.html'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> self<span class="token punctuation">.</span>item1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"&lt;!DOCTYPE html&gt;"</span><span class="token punctuation">)</span> <span class="token comment"># Check for full HTML structure</span>

    <span class="token keyword">def</span> <span class="token function">test_item_list_renders_partial_for_htmx_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Simulate an HTMX request by adding the HX-Request header</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>list_url<span class="token punctuation">,</span>
            HTTP_HX_REQUEST<span class="token operator">=</span><span class="token string">'true'</span> <span class="token comment"># Key for simulating HTMX</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token comment"># Assuming your view logic switches to a partial template</span>
        self<span class="token punctuation">.</span>assertTemplateUsed<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_item_list.html'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> self<span class="token punctuation">.</span>item1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token comment"># Check that it's a fragment, not a full page</span>
        self<span class="token punctuation">.</span>assertNotContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"&lt;!DOCTYPE html&gt;"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertNotContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"&lt;head&gt;"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertNotContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"&lt;body&gt;"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_htmx_post_creates_item_and_returns_partial</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Example for a form submission via HTMX</span>
        form_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'New Item via HTMX'</span><span class="token punctuation">}</span>
        <span class="token comment"># Assuming you have a URL for creating items that responds to HTMX POST</span>
        create_url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'item_create'</span><span class="token punctuation">)</span> <span class="token comment"># Fictional URL for this example</span>
        
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
            create_url<span class="token punctuation">,</span>
            data<span class="token operator">=</span>form_data<span class="token punctuation">,</span>
            HTTP_HX_REQUEST<span class="token operator">=</span><span class="token string">'true'</span><span class="token punctuation">,</span>
            HTTP_HX_TARGET<span class="token operator">=</span><span class="token string">'item-list-container'</span><span class="token punctuation">,</span> <span class="token comment"># Optional: simulate other HTMX headers</span>
            HTTP_HX_TRIGGER<span class="token operator">=</span><span class="token string">'submit'</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token comment"># Or 201 if you prefer for creation</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>Item<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'New Item via HTMX'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># Assert that the response is the updated partial (e.g., the new item or the whole list)</span>
        self<span class="token punctuation">.</span>assertTemplateUsed<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_item_list.html'</span><span class="token punctuation">)</span> <span class="token comment"># Or a specific item partial</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'New Item via HTMX'</span><span class="token punctuation">)</span>
</code></pre>
<p>Let's dissect these test methods:</p>
<ol>
<li><code>setUp</code>:
<ul>
<li>Initializes a Django <code>Client</code> instance for making requests.</li>
<li>Creates a sample <code>Item</code> for testing list views.</li>
<li>Defines <code>self.list_url</code> using <code>reverse()</code> for maintainability.</li>
</ul>
</li>
<li><code>test_item_list_renders_full_page_for_normal_request</code>:
<ul>
<li>This is a standard Django view test. It makes a GET request <em>without</em> HTMX headers.</li>
<li>It asserts that the status code is 200, the correct full-page template is used, the item's name is present, and that the response contains typical full HTML document markers like <code>&lt;!DOCTYPE html&gt;</code>.</li>
<li>This verifies the baseline functionality of the view for non-JavaScript/non-HTMX clients.</li>
</ul>
</li>
<li><code>test_item_list_renders_partial_for_htmx_request</code>:
<ul>
<li>This is the key test for HTMX integration.</li>
<li><code>response = self.client.get(self.list_url, HTTP_HX_REQUEST='true')</code>: The crucial part is <code>HTTP_HX_REQUEST='true'</code>. This adds the <code>HX-Request: true</code> header to the GET request, signaling to the Django view that it's an HTMX request.</li>
<li>It asserts that the status code is 200.</li>
<li><code>self.assertTemplateUsed(response, 'myapp/partials/_item_list.html')</code>: Verifies that the view correctly switched to rendering the partial template.</li>
<li><code>self.assertContains(response, self.item1.name)</code>: Ensures the data is still correctly rendered in the partial.</li>
<li><code>self.assertNotContains(response, "&lt;!DOCTYPE html&gt;")</code>, etc.: These assertions confirm that the response is indeed an HTML fragment and not a full HTML document. This is vital for HTMX, which expects partials.</li>
</ul>
</li>
<li><code>test_htmx_post_creates_item_and_returns_partial</code>:
<ul>
<li>This demonstrates testing an HTMX POST request, such as submitting a form.</li>
<li><code>form_data</code> simulates the data sent by the form.</li>
<li>The <code>self.client.post(...)</code> call includes <code>HTTP_HX_REQUEST='true'</code>.</li>
<li><code>HTTP_HX_TARGET</code> and <code>HTTP_HX_TRIGGER</code> are also included to more closely simulate a real HTMX request, though they might not always be necessary for the view logic itself unless the view specifically acts upon them.</li>
<li>It asserts the status code, verifies that the item was created in the database (<code>Item.objects.filter(...).exists()</code>).</li>
<li>Crucially, it asserts that the response is the appropriate partial HTML, which HTMX would then use to update the page (e.g., adding the new item to a list).</li>
</ul>
</li>
</ol>
<p><strong>Why this approach is important:</strong></p>
<ul>
<li><strong>Isolation:</strong> It tests the server-side logic (view, model interaction, template rendering) in isolation from the browser and actual JavaScript execution. This makes tests faster and less flaky.</li>
<li><strong>Correctness of Partials:</strong> It ensures your views generate the correct HTML fragments that HTMX expects.</li>
<li><strong>Business Logic:</strong> It verifies that the underlying business logic (e.g., creating an item, filtering data) works correctly even when triggered via an HTMX request.</li>
</ul>
</li>
</ol>
<p><strong>End-to-End (E2E) Testing</strong></p>
<p>While Django's test client is excellent for server-side logic, it doesn't execute JavaScript or simulate real browser interactions. For verifying the complete Django + HTMX + Alpine.js stack, End-to-End (E2E) tests are necessary.</p>
<ol>
<li>
<p><strong>Tools:</strong> Popular E2E testing frameworks include Selenium, Playwright, and Cypress. These tools automate a real browser, allowing you to script user interactions like clicks, form submissions, and then assert changes in the DOM.</p>
</li>
<li>
<p><strong>What to Test with E2E:</strong></p>
<ul>
<li><strong>HTMX Swaps:</strong> Verify that clicking an HTMX-enabled button correctly fetches content and swaps it into the specified target element.</li>
<li><strong>Alpine.js Interactivity:</strong> Test Alpine.js-driven UI changes, such as <code>x-show</code> toggles, <code>x-model</code> data binding, and <code>x-on</code> event handlers.</li>
<li><strong>Combined Flows:</strong> Test scenarios where HTMX and Alpine.js interact, e.g., an HTMX request updates content, and an Alpine.js component within that new content initializes and functions correctly.</li>
<li><strong>User Journeys:</strong> Test critical user paths through the application that rely on these reactive features.</li>
</ul>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># Example using Playwright (conceptual - requires Playwright setup)</span>
<span class="token comment"># tests/e2e/test_todo_app.py </span>
<span class="token comment"># (This is Python, but Playwright also has JS/TS bindings)</span>

<span class="token comment"># from playwright.sync_api import Page, expect</span>
<span class="token comment"># import pytest</span>

<span class="token comment"># @pytest.mark.e2e</span>
<span class="token comment"># def test_add_todo_item_htmx_alpine(page: Page, live_server_url):</span>
<span class="token comment">#     page.goto(f"{live_server_url}/todos/") # Assuming live_server_url points to Django dev server</span>
    
<span class="token comment">#     # Initial state: check if an Alpine.js controlled element is hidden</span>
<span class="token comment">#     add_form_details = page.locator("#add-form-details")</span>
<span class="token comment">#     expect(add_form_details).to_be_hidden()</span>

<span class="token comment">#     # Alpine.js interaction: click a button to show a form section</span>
<span class="token comment">#     page.click("button[x-on\\:click='showDetails = !showDetails']") # Simplified selector</span>
<span class="token comment">#     expect(add_form_details).to_be_visible()</span>

<span class="token comment">#     # HTMX interaction: fill and submit the form</span>
<span class="token comment">#     page.fill("input[name='title']", "New E2E Todo")</span>
<span class="token comment">#     page.click("button[hx-post]") # Button that triggers HTMX POST</span>

<span class="token comment">#     # Assertion: check if the new item appears in the list (swapped by HTMX)</span>
<span class="token comment">#     new_todo_item = page.locator(".todo-item", has_text="New E2E Todo")</span>
<span class="token comment">#     expect(new_todo_item).to_be_visible()</span>
    
<span class="token comment">#     # Further Alpine.js check: maybe the form details hide again after submission</span>
<span class="token comment">#     expect(add_form_details).to_be_hidden() # If form resets Alpine state</span>
</code></pre>
<p>This is a conceptual E2E test snippet using Playwright's Python API:</p>
<ol>
<li><code>test_add_todo_item_htmx_alpine(page: Page, live_server_url)</code>:
<ul>
<li>This test function would use a <code>page</code> object provided by Playwright to interact with a browser.</li>
<li><code>live_server_url</code> would point to your running Django application, often managed by a fixture like <code>django_live_server</code> from <code>pytest-django</code>.</li>
</ul>
</li>
<li><code>page.goto(...)</code>: Navigates the browser to the To-Do list page.</li>
<li><code>expect(add_form_details).to_be_hidden()</code>:
<ul>
<li>This line (and similar <code>expect</code> calls) uses Playwright's assertion library.</li>
<li>It checks an initial condition, perhaps that a part of the form controlled by Alpine's <code>x-show</code> is initially hidden. <code>add_form_details</code> would be a Playwright <code>Locator</code>.</li>
</ul>
</li>
<li><code>page.click("button[x-on\\:click='showDetails = !showDetails']")</code>:
<ul>
<li>Simulates a user click on a button that has an Alpine.js <code>x-on:click</code> handler.</li>
<li>This tests the Alpine.js client-side interactivity.</li>
</ul>
</li>
<li><code>expect(add_form_details).to_be_visible()</code>: Asserts that the Alpine.js action had the desired effect (showing the form details).</li>
<li><code>page.fill(...)</code> and <code>page.click("button[hx-post]")</code>:
<ul>
<li>Simulates filling out a form field and clicking a submit button that is HTMX-enabled (e.g., has an <code>hx-post</code> attribute).</li>
<li>This triggers the HTMX request to the Django backend.</li>
</ul>
</li>
<li><code>expect(new_todo_item).to_be_visible()</code>:
<ul>
<li>After the HTMX request completes and swaps content, this assertion verifies that the new To-Do item (which should have been added to the list via an HTML partial from the server) is now visible in the DOM.</li>
<li>This tests the full Django (process POST, save data, render partial) -&gt; HTMX (swap content) flow.</li>
</ul>
</li>
<li>The final <code>expect(add_form_details).to_be_hidden()</code> could test if, for example, the form's Alpine state resets after a successful submission.</li>
</ol>
<p><strong>Why E2E tests are important:</strong></p>
<ul>
<li><strong>User Perspective:</strong> They test the application as a user would experience it, catching issues that unit or integration tests might miss.</li>
<li><strong>Integration Verification:</strong> They confirm that Django, HTMX, and Alpine.js are all working together correctly in a live browser environment.</li>
<li><strong>Confidence:</strong> Passing E2E tests provide high confidence that the core reactive features of your application are functional.</li>
</ul>
<p><strong>Trade-offs:</strong> E2E tests are generally slower to run and can be more brittle (i.e., more prone to breaking due to minor UI changes) than server-side tests. Therefore, use them judiciously for critical user flows and complex interactions, complementing a strong base of Django unit/integration tests.</p>
</li>
</ol>
<p>A balanced testing strategy involves using Django's test client for thorough testing of server-side logic and partial generation, and E2E tests for validating key user interactions and the integration of all three technologies (Django, HTMX, Alpine.js). This layered approach ensures both robustness and a positive user experience.</p>
<h3 id="1353-error-handling-consistency" tabindex="-1"><a class="anchor" href="#1353-error-handling-consistency" name="1353-error-handling-consistency" tabindex="-1"><span class="octicon octicon-link"></span></a>13.5.3 Error Handling Consistency</h3>
<p>Consistent and user-friendly error handling is a hallmark of a well-crafted application. When using HTMX, which often updates only portions of a page, it's crucial to have a strategy for communicating errors that occur during these partial updates.</p>
<p><strong>Server-Side Error Handling (Django Views)</strong></p>
<ol>
<li>
<p><strong>HTTP Status Codes for HTMX:</strong></p>
<ul>
<li>When an HTMX request results in an error, your Django view should return an appropriate HTTP status code from the 4xx (client errors) or 5xx (server errors) range.</li>
<li>HTMX can react to these status codes. For example, by default, a 4xx or 5xx response will not be swapped into the target element unless <code>hx-swap</code> is configured to handle specific status codes (e.g., <code>hx-swap="innerHTML swap:1s settle:500ms transition:true target:#errors status:422"</code>).</li>
<li><strong>Common Practice:</strong> For validation errors (e.g., form submission fails), return a <code>422 Unprocessable Entity</code> or <code>400 Bad Request</code> status code. The response body should be the form partial, re-rendered with error messages. HTMX can then swap this back into place, showing the user the errors inline.</li>
</ul>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># myapp/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponseBadRequest<span class="token punctuation">,</span> HttpResponse
<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> ItemForm
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Item

<span class="token keyword">def</span> <span class="token function">create_item_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> ItemForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            item <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
                <span class="token comment"># On success, return a partial of the new item or updated list</span>
                <span class="token comment"># For simplicity, let's assume we return a success message partial</span>
                <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_success_message.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Item created!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment"># Handle non-HTMX success (e.g., redirect)</span>
            <span class="token comment"># ...</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Form is invalid</span>
            <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
                <span class="token comment"># Return the form partial with errors, and a 422 status code</span>
                context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span>
                response <span class="token operator">=</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_item_form.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
                response<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">422</span> <span class="token comment"># Unprocessable Entity</span>
                <span class="token keyword">return</span> response
            <span class="token comment"># Handle non-HTMX form errors (e.g., re-render full page with form errors)</span>
            <span class="token comment"># ...</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> ItemForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>htmx<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/partials/_item_form.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myapp/create_item_page.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre>
<p>Let's examine the error handling in this view:</p>
<ol>
<li>The view handles both GET (to display the form) and POST (to submit the form) requests.</li>
<li><code>if form.is_valid()</code>:
<ul>
<li>If the form is valid, the item is saved.</li>
<li>For an HTMX request, it returns a success message partial (or could be the newly created item, or an updated list). The status code is implicitly 200 OK.</li>
</ul>
</li>
<li><code>else: # Form is invalid</code>:
<ul>
<li>This block handles form validation errors.</li>
<li><code>if request.htmx:</code>: This is key for HTMX error handling.
<ul>
<li><code>context = {'form': form}</code>: The invalid form instance (which now contains error messages) is passed to the context.</li>
<li><code>response = render(request, 'myapp/partials/_item_form.html', context)</code>: The form partial (<code>_item_form.html</code>) is re-rendered. This partial should be designed to display form errors (e.g., <code>{{ form.non_field_errors }}</code> and <code>{{ field.errors }}</code>).</li>
<li><code>response.status_code = 422</code>: <strong>Crucially</strong>, the HTTP status code of the response is set to <code>422 Unprocessable Entity</code>. This signals to HTMX that the request was understood but could not be processed due to validation errors.</li>
<li><code>return response</code>: The re-rendered form partial with the 422 status is returned.</li>
</ul>
</li>
<li>If it's not an HTMX request, standard Django form error handling would apply (e.g., re-rendering the full page with the form and its errors).</li>
</ul>
</li>
<li>This approach allows HTMX to receive the form with errors and swap it back into the page, providing inline validation feedback without a full page reload. The <code>hx-target</code> attribute on the submitting element would point to the container of the form.</li>
</ol>
</li>
<li>
<p><strong>HTMX Error Handling Attributes/Events:</strong></p>
<ul>
<li><code>hx-swap</code> with status codes: You can specify different swap behaviors for different status codes.<!-- THIS_CODE_SNIPPET -->
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- Example: Swapping error content into a dedicated error div for 500 errors --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">hx-post</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/submit-data<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#response-area<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML swap:1s status:500:innerHTML target:#error-message-div<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    Submit
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response-area<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error-message-div<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<ul>
<li>In this example, if the POST to <code>/submit-data</code> returns a 2xx status, the content is swapped into <code>#response-area</code>.</li>
<li>If it returns a 500 status, the response content (which should be an error message from the server) is swapped into <code>#error-message-div</code>.</li>
</ul>
</li>
<li>HTMX Events: HTMX dispatches events like <code>htmx:responseError</code> or <code>htmx:sendError</code> that can be listened to by JavaScript (including Alpine.js) to implement custom error handling logic (e.g., displaying toast notifications).</li>
</ul>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- In your template, potentially in base.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">x-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ errorMessage: '' }<span class="token punctuation">"</span></span>
     <span class="token attr-name">x-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>errorMessage<span class="token punctuation">"</span></span>
     <span class="token attr-name">x-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>errorMessage<span class="token punctuation">"</span></span>
     <span class="token attr-name"><span class="token namespace">@htmx:</span>response-error.window</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>errorMessage = 'A server error occurred: ' + $event.detail.xhr.statusText; setTimeout(() =&gt; errorMessage = '', 5000)<span class="token punctuation">"</span></span>
     <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error-toast<span class="token punctuation">"</span></span>
     <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span>fixed<span class="token punctuation">;</span> <span class="token property">top</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span> <span class="token property">right</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span> <span class="token property">background</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>white<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span> <span class="token property">z-index</span><span class="token punctuation">:</span>1000<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Let's break down this Alpine.js component for global HTMX error notifications:</p>
<ol>
<li><code>&lt;div x-data="{ errorMessage: '' }"</code>: Initializes an Alpine.js component with an <code>errorMessage</code> state, initially empty.</li>
<li><code>x-show="errorMessage"</code>: The div is only visible if <code>errorMessage</code> has a value.</li>
<li><code>x-text="errorMessage"</code>: The content of the div will be the <code>errorMessage</code>.</li>
<li><code>@htmx:response-error.window="errorMessage = 'A server error occurred: ' + $event.detail.xhr.statusText; setTimeout(() =&gt; errorMessage = '', 5000)"</code>:
<ul>
<li>This is the core of the error handling. It listens for the <code>htmx:responseError</code> event, which HTMX dispatches on the <code>window</code> object when an AJAX request results in an error status code (4xx or 5xx) and is not otherwise handled by a <code>status:</code> specific swap.</li>
<li><code>$event.detail.xhr</code> provides access to the XMLHttpRequest object, allowing you to get details like <code>statusText</code> or <code>responseText</code>.</li>
<li>When the event occurs, it sets <code>errorMessage</code> to a generic message including the status text.</li>
<li><code>setTimeout(() =&gt; errorMessage = '', 5000)</code>: Hides the message after 5 seconds.</li>
</ul>
</li>
<li><code>class="error-toast"</code> and <code>style</code>: Basic styling for a toast-like notification.</li>
</ol>
<ul>
<li><strong>Why this is useful:</strong> This provides a global, non-intrusive way to inform the user about unexpected server errors during HTMX operations, even if the specific HTMX interaction doesn't have its own detailed error display mechanism.</li>
</ul>
</li>
</ol>
<p><strong>Consistency in Presenting Errors</strong></p>
<ul>
<li>
<p><strong>Django Messages Framework:</strong> You can leverage Django's messages framework with HTMX, often using out-of-band swaps (<code>hx-swap-oob="true"</code>). Your Django view can add messages, and a dedicated partial for displaying messages can be included in the HTMX response with <code>hx-swap-oob</code>.</p>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># myapp/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> messages
<span class="token comment"># ... inside a view after an error ...</span>
<span class="token comment"># if request.htmx:</span>
<span class="token comment">#     messages.error(request, "Failed to update item.")</span>
<span class="token comment">#     # Return a response that includes an OOB swap for messages</span>
<span class="token comment">#     return render(request, 'myapp/partials/_item_detail_and_messages.html', context)</span>
</code></pre>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- myapp/templates/myapp/partials/_item_detail_and_messages.html --&gt;</span>
<span class="token comment">&lt;!-- This partial might be returned by an HTMX request --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-detail-{{ item.id }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Updated item content --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ item.name }} - {{ item.description }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Out-of-Band Swap for Messages --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messages-container<span class="token punctuation">"</span></span> <span class="token attr-name">hx-swap-oob</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% if messages %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messages<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            {% for message in messages %}
                &lt;li{% if message.tags %} class="{{ message.tags }}"{% endif %}&gt;{{ message }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            {% endfor %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    {% endif %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Explanation of OOB message handling:</p>
<ol>
<li><strong>Python View (<code>myapp/views.py</code>):</strong>
<ul>
<li><code>messages.error(request, "Failed to update item.")</code>: A standard Django message is added.</li>
<li>The view then renders a template (<code>_item_detail_and_messages.html</code>) that contains both the primary content update and the messages partial.</li>
</ul>
</li>
<li><strong>HTML Template (<code>_item_detail_and_messages.html</code>):</strong>
<ul>
<li><code>&lt;div id="item-detail-{{ item.id }}"&gt;</code>: This is the primary content that HTMX will swap into the target specified by the original <code>hx-target</code> attribute.</li>
<li><code>&lt;div id="messages-container" hx-swap-oob="true"&gt;</code>: This is the out-of-band swap.
<ul>
<li><code>id="messages-container"</code>: This ID must match an existing element in your main page layout where messages are displayed.</li>
<li><code>hx-swap-oob="true"</code>: This tells HTMX to find an element with the ID <code>messages-container</code> in the main document and replace its content with this div, <em>in addition</em> to the primary swap.</li>
<li>The content of this div is the standard Django messages rendering logic.</li>
</ul>
</li>
</ul>
</li>
</ol>
<ul>
<li><strong>Why this is powerful:</strong> It allows you to update a specific part of the page (e.g., an item detail) while also updating a global messages area (e.g., at the top of the page) in a single HTMX response. This maintains consistency in how feedback and errors are presented.</li>
</ul>
</li>
<li>
<p><strong>Visual Cues:</strong> Use consistent styling for error messages, whether they appear inline in a form, in a dedicated error section, or as toast notifications.</p>
</li>
<li>
<p><strong>Clear Language:</strong> Error messages should be clear, concise, and helpful to the user, guiding them on how to resolve the issue if possible.</p>
</li>
</ul>
<p>By thoughtfully handling errors at the server level, leveraging HTMX's capabilities for error display, and maintaining consistency in presentation, you create a more resilient and user-friendly application.</p>
<h3 id="1354-progressive-enhancement" tabindex="-1"><a class="anchor" href="#1354-progressive-enhancement" name="1354-progressive-enhancement" tabindex="-1"><span class="octicon octicon-link"></span></a>13.5.4 Progressive Enhancement</h3>
<p>Progressive Enhancement is a powerful design philosophy that aligns perfectly with the strengths of Django, HTMX, and Alpine.js. It advocates for building a baseline of functionality in HTML that works for all users, then layering on enhancements (CSS for presentation, JavaScript for interactivity) for browsers that can support them.</p>
<p><strong>Core Principles in the Django/HTMX/Alpine.js Context</strong></p>
<ol>
<li>
<p><strong>Start with Server-Rendered HTML (Django):</strong></p>
<ul>
<li>Your Django application should, at its core, be able to render functional HTML pages. Forms should submit via standard HTTP requests, links should navigate to new pages, and content should be accessible.</li>
<li><strong>The "Why":</strong> This ensures a baseline level of accessibility for users with JavaScript disabled (or where it fails to load) and provides search engine crawlers with content. It forms the "robust foundation."</li>
</ul>
</li>
<li>
<p><strong>Enhance with HTMX for Interactivity:</strong></p>
<ul>
<li>Once the baseline HTML is functional, use HTMX attributes to enhance existing elements.
<ul>
<li>A standard <code>&lt;form method="POST"&gt;</code> can be enhanced with <code>hx-post</code>, <code>hx-target</code>, and <code>hx-swap</code> to submit asynchronously and update only a portion of the page.</li>
<li>A standard <code>&lt;a&gt;</code> link can be enhanced with <code>hx-get</code> to load content into a modal or a section of the page.</li>
</ul>
</li>
<li><strong>The "Why":</strong> HTMX provides significant UX improvements (faster updates, no full page reloads) without requiring complex JavaScript frameworks. It builds upon the existing HTML structure.</li>
</ul>
<!-- THIS_CODE_SNIPPET -->
<pre class="language-html" tabindex="0"><code class="language-html"><span class="token comment">&lt;!-- Example of a progressively enhanced form --&gt;</span>

<span class="token comment">&lt;!-- Baseline HTML form (works without JavaScript/HTMX) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'submit_my_form' %}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span>
      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my-form<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-post</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'submit_my_form_htmx' %}<span class="token punctuation">"</span></span>  <span class="token attr-name">{#</span> <span class="token attr-name">HTMX</span> <span class="token attr-name">uses</span> <span class="token attr-name">this</span> <span class="token attr-name">URL</span> <span class="token attr-name">#}</span>
      <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#form-result<span class="token punctuation">"</span></span>
      <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerHTML<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% csrf_token %}
    {{ form.as_p }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-result<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Let's analyze this progressively enhanced form:</p>
<ol>
<li><code>&lt;form action="{% url 'submit_my_form' %}" method="POST"&gt;</code>:
<ul>
<li>This is a standard HTML form. If JavaScript is disabled or HTMX doesn't initialize, submitting this form will make a traditional POST request to the URL specified in <code>action</code>. The Django view at <code>submit_my_form</code> would handle this as a full page submission and typically respond with a redirect or a re-rendered full page.</li>
<li>This provides the baseline functionality.</li>
</ul>
</li>
<li><code>id="my-form"</code>: An ID for potential JavaScript interaction or styling.</li>
<li><code>hx-post="{% url 'submit_my_form_htmx' %}"</code>:
<ul>
<li>This HTMX attribute enhances the form. If HTMX is active, it will intercept the form submission.</li>
<li>Instead of a standard POST to the <code>action</code> URL, HTMX will make an AJAX POST request to the URL specified in <code>hx-post</code>. This could be the same URL if the view handles both, or a dedicated URL for HTMX submissions as shown here (<code>submit_my_form_htmx</code>).</li>
<li>This allows for a different server-side handling or response type (partial HTML) for HTMX requests.</li>
</ul>
</li>
<li><code>hx-target="#form-result"</code>: Specifies that the response from the HTMX POST request should be placed into the HTML element with the ID <code>form-result</code>.</li>
<li><code>hx-swap="innerHTML"</code>: Dictates that the content of <code>#form-result</code> should be replaced with the HTML response.</li>
<li><code>{% csrf_token %}</code>: Standard Django CSRF protection, essential for both traditional and HTMX form submissions.</li>
<li><code>{{ form.as_p }}</code>: Renders the Django form fields.</li>
<li><code>&lt;button type="submit"&gt;Submit&lt;/button&gt;</code>: A standard submit button.</li>
<li><code>&lt;div id="form-result"&gt;&lt;/div&gt;</code>: The container where HTMX will place the response.</li>
</ol>
<ul>
<li><strong>The "Why" of this pattern:</strong>
<ul>
<li><strong>Accessibility &amp; Robustness:</strong> The form works even if HTMX fails to load or JavaScript is disabled. The user can still submit their data.</li>
<li><strong>Enhanced Experience:</strong> For users with HTMX enabled, they get a smoother, faster experience with partial page updates.</li>
<li><strong>Clear Separation:</strong> The HTML structure defines the form, and HTMX attributes declaratively add the dynamic behavior.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Add Alpine.js for Client-Side Finesse:</strong></p>
<ul>
<li>Use Alpine.js for purely client-side UI enhancements that don't necessarily require server interaction or that complement HTMX-driven updates.
<ul>
<li>Examples: Toggling visibility of elements (<code>x-show</code>), simple client-side validation feedback (e.g., character counters), managing dropdowns/modals, or adding subtle animations (<code>x-transition</code>).</li>
</ul>
</li>
<li><strong>The "Why":</strong> Alpine.js allows for rich client-side interactions with minimal JavaScript, keeping logic close to the HTML it affects. It can operate on content loaded by HTMX, further enhancing the user experience.</li>
</ul>
</li>
</ol>
<p><strong>Benefits of Progressive Enhancement</strong></p>
<ul>
<li><strong>Accessibility:</strong> Applications are usable by a wider range of users, including those with assistive technologies or older browsers.</li>
<li><strong>Robustness:</strong> The application gracefully degrades if JavaScript enhancements fail. The core functionality remains.</li>
<li><strong>SEO:</strong> Server-rendered content from Django is easily crawlable by search engines, improving discoverability. HTMX, by primarily dealing with HTML, also maintains this advantage.</li>
<li><strong>Maintainability:</strong> Separating concerns (structure in HTML, enhancement via HTMX/Alpine) can lead to cleaner, more maintainable code.</li>
<li><strong>Developer Experience:</strong> It often simplifies development by allowing you to focus on server-side logic first, then layer on interactivity.</li>
</ul>
<p><strong>Practical Implementation Considerations</strong></p>
<ul>
<li><strong>Design for No-JS First:</strong> When designing a new feature, briefly consider how it would work without any client-side JavaScript. This mindset helps identify the core server-side requirements.</li>
<li><strong>Use HTMX for Server Interactions:</strong> If an interaction requires data from the server or needs to persist changes on the server, HTMX is generally the right tool.</li>
<li><strong>Use Alpine.js for UI Polish:</strong> If an interaction is purely presentational or manages local client-side state without needing server round-trips, Alpine.js is a good fit.</li>
<li><strong>Test Degraded States:</strong> Occasionally test your application with JavaScript disabled (or by blocking HTMX/Alpine.js via browser dev tools) to ensure the core functionality remains intact.</li>
</ul>
<p>Progressive enhancement is not just a technique but a philosophy. By embracing it, you build applications that are more resilient, accessible, and user-friendly, leveraging the strengths of Django's server-side rendering, HTMX's hypermedia-driven interactivity, and Alpine.js's lightweight client-side enhancements. This approach ensures that your applications deliver value to all users, regardless of their browser capabilities, while providing a rich, reactive experience for those who can support it.</p>
<h2 id="136-chapter-conclusion-mastering-the-djangohtmxalpine-stack" tabindex="-1"><a class="anchor" href="#136-chapter-conclusion-mastering-the-djangohtmxalpine-stack" name="136-chapter-conclusion-mastering-the-djangohtmxalpine-stack" tabindex="-1"><span class="octicon octicon-link"></span></a>13.6 Chapter Conclusion: Mastering the Django/HTMX/Alpine Stack</h2>
<p>Having journeyed through the practical construction of several applications in this chapter—the Interactive To-Do List, the Live Search and Filterable Product Catalog, and the Simple Real-Time Notification Feed—we now stand at a significant vantage point. This chapter was meticulously designed not merely as a showcase of disparate projects, but as a crucible where the foundational principles of Django, the reactive power of HTMX, and the client-side finesse of Alpine.js were intentionally fused. The objective was to move beyond theoretical understanding and into the realm of applied mastery, demonstrating how these technologies synergize to create modern, interactive user experiences.</p>
<p>The path we've traversed was deliberate, incrementally layering complexity to build robust technical skills. Each project served as a practical demonstration, dissecting intricate challenges into manageable components and reinforcing the <em>why</em> behind each architectural choice and implementation detail. Now, let us distill the essence of the skills you've honed and consider how to carry this knowledge forward into your own development endeavors.</p>
<h3 id="1361-summary-of-skills-demonstrated" tabindex="-1"><a class="anchor" href="#1361-summary-of-skills-demonstrated" name="1361-summary-of-skills-demonstrated" tabindex="-1"><span class="octicon octicon-link"></span></a>13.6.1 Summary of Skills Demonstrated</h3>
<p>The applications built in this chapter served as a comprehensive proving ground for the concepts explored throughout this book. They were not mere academic exercises but reflections of real-world challenges, designed to cultivate a deep intuition for the Django/HTMX/Alpine stack. Let's revisit the core competencies you've actively developed:</p>
<ol>
<li>
<p><strong>Solidified Django Mastery for a Reactive World:</strong></p>
<ul>
<li><strong>Robust Model Design:</strong> You continued to leverage Django models as the immutable bedrock of your applications, providing a solid data foundation for all dynamic interactions.</li>
<li><strong>Versatile View Craftsmanship:</strong> A crucial skill demonstrated was the ability to write Django views adept at handling dual responsibilities: serving full initial page loads and, critically, returning precise HTML partials for HTMX requests. Understanding how to detect HTMX requests (e.g., via <code>request.htmx</code>) and tailor responses accordingly is fundamental to this paradigm. This allows the server to remain the source of truth for UI generation, minimizing client-side state.</li>
<li><strong>Effective Form Handling:</strong> You saw how Django's powerful form processing capabilities seamlessly integrate with HTMX-driven submissions, ensuring data validation and business logic remain centralized and secure on the server, even for asynchronous interactions.</li>
<li><strong>Modular Template Architecture:</strong> The projects emphasized the importance of structuring Django templates for reusability, particularly through the strategic use of <code>{% include %}</code> and <code>{% block %}</code> tags. This modularity is paramount for HTMX, which relies on swapping well-defined fragments of HTML to update the UI surgically.</li>
<li><strong>Efficient Data Management:</strong> Leveraging Django QuerySets for optimized data retrieval and manipulation remained central, forming the backbone of dynamic content generation for features like live search, filtering, and list updates.</li>
<li><strong>Asynchronous Potential:</strong> With the notification feed, we touched upon Django's capacity for handling real-time updates, whether through simplified polling mechanisms orchestrated by HTMX or by laying the groundwork for more advanced solutions like Server-Sent Events (SSE) via Django Channels. This showcased Django's adaptability to modern real-time requirements.</li>
</ul>
</li>
<li>
<p><strong>Harnessing HTMX for Hypermedia-Driven Interactivity:</strong></p>
<ul>
<li><strong>Core Attribute Fluency:</strong> You gained practical experience with essential HTMX attributes like <code>hx-get</code>, <code>hx-post</code>, <code>hx-target</code>, and <code>hx-swap</code>. The <em>why</em> here is profound: HTMX allows you to achieve rich interactivity by extending HTML's original hypermedia controls, keeping your primary logic server-centric and aligning perfectly with Django's strengths.</li>
<li><strong>Seamless CRUD Operations:</strong> The To-Do list, in particular, demonstrated how to implement Create, Read, Update, and Delete operations that feel instantaneous to the user. This was achieved by having Django views return only the necessary HTML fragments for HTMX to swap into the DOM, avoiding full-page reloads.</li>
<li><strong>Fine-Grained Request Control:</strong> Attributes like <code>hx-trigger</code> (e.g., <code>keyup changed delay:500ms</code> for live search) and <code>hx-indicator</code> were used to refine the user experience, providing control over when requests are made and offering visual feedback during data fetching.</li>
<li><strong>Advanced Swapping Strategies:</strong> The concept of Out-of-Band (OOB) swaps (<code>hx-swap-oob</code>) was introduced, illustrating a powerful pattern for updating multiple, disparate parts of the page from a single server response—essential for more complex UIs like updating a list item and a notification badge simultaneously.</li>
<li><strong>Browser History and Shareability:</strong> Using <code>hx-push-url</code>, you learned to update the browser's URL in response to HTMX-driven content changes, ensuring that application states remain bookmarkable and shareable, a key aspect of good web application design.</li>
<li><strong>Real-Time Feature Implementation:</strong> The notification project explored how HTMX, through attributes like <code>hx-sse</code> or timed polling via <code>hx-trigger="every 5s"</code>, can integrate with backend systems to deliver real-time updates to the client.</li>
</ul>
</li>
<li>
<p><strong>Leveraging Alpine.js for Client-Side Polish and State Management:</strong></p>
<ul>
<li><strong>Declarative Component State:</strong> You utilized <code>x-data</code> to define self-contained component state directly within your HTML markup. The <em>why</em> is crucial: Alpine.js promotes keeping client-side logic localized and declarative, making it easier to understand and manage, especially for UI enhancements that don't warrant a full server round-trip.</li>
<li><strong>Conditional Rendering and Dynamic Attributes:</strong> Directives like <code>x-show</code>, <code>x-if</code>, and <code>x-bind</code> were employed for responsive UI behaviors, such as toggling visibility, dynamically setting CSS classes, or enabling/disabling form elements based on local Alpine state.</li>
<li><strong>Client-Side Event Handling:</strong> <code>x-on</code> allowed you to capture user interactions (clicks, input changes) and trigger client-side logic or even orchestrate HTMX requests, demonstrating a clear separation of concerns.</li>
<li><strong>Synergy with HTMX:</strong> A key takeaway was observing how Alpine.js can gracefully complement HTMX. Alpine can manage ephemeral UI state (e.g., dropdown visibility, modal states) while HTMX handles server communication. Furthermore, HTMX events (like <code>htmx:afterSwap</code>) can be used to initialize or interact with Alpine components within newly loaded content.</li>
</ul>
</li>
<li>
<p><strong>Mastering the Integrated Stack – The "Django/HTMX/Alpine Way":</strong></p>
<ul>
<li><strong>Complementary Strengths:</strong> The overarching skill developed is the deep understanding of how these three technologies form a cohesive and powerful stack. Django provides the robust, secure backend and initial server-side render. HTMX extends HTML to enable rich, server-driven interactions via hypermedia principles. Alpine.js then sprinkles in lightweight, declarative JavaScript for client-side enhancements precisely where needed.</li>
<li><strong>Reduced Client-Side Complexity:</strong> This integrated approach empowers you to build highly reactive applications while significantly minimizing the amount of custom JavaScript you need to write and maintain. This reduces overall complexity and leverages Django's full capabilities.</li>
<li><strong>Progressive Enhancement in Action:</strong> The projects implicitly followed a progressive enhancement strategy. Core functionality is delivered via server-rendered HTML (accessible and functional even without JavaScript), with HTMX and Alpine.js layering on richer, more dynamic experiences.</li>
</ul>
</li>
</ol>
<p>By working through these projects, you've not just learned <em>how</em> these systems function, but gained insight into the <em>reasoning</em> behind their design and their combined utility. You've moved from understanding isolated details to internalizing the principles of crafting reactive applications in a Django-centric manner.</p>
<h3 id="1362-encouragement-for-applying-patterns" tabindex="-1"><a class="anchor" href="#1362-encouragement-for-applying-patterns" name="1362-encouragement-for-applying-patterns" tabindex="-1"><span class="octicon octicon-link"></span></a>13.6.2 Encouragement for Applying Patterns</h3>
<p>The journey through Chapter 13 has equipped you with a potent set of patterns and a practical understanding of how Django, HTMX, and Alpine.js can be orchestrated to build sophisticated, modern web applications. As you move forward, we encourage you to view the applications we built—the To-Do list, the Product Catalog, and the Notification Feed—not as rigid templates, but as adaptable blueprints and sources of inspiration.</p>
<p>The true mastery of this stack lies in recognizing the underlying principles and applying them creatively to the unique challenges your own projects will present.</p>
<ul>
<li><strong>Experiment and Adapt:</strong> Do not hesitate to deconstruct the examples, modify them, and extend their functionality. How might you introduce more complex filtering to the product catalog? Could the to-do list benefit from collaborative features? Use these projects as springboards for your own innovation.</li>
<li><strong>Embrace the Philosophy:</strong> The "Django/HTMX/Alpine Way" is as much a philosophy as it is a technology stack. It champions server-side intelligence, hypermedia as the engine of application state (HATEOAS) via HTMX, and judicious use of client-side JavaScript for UI polish via Alpine.js. This approach often leads to applications that are more maintainable, more performant (due to smaller client-side footprints), and quicker to develop, as you remain largely within the familiar and productive Django ecosystem.</li>
<li><strong>Focus on Progressive Enhancement:</strong> Continue to build with progressive enhancement in mind. Ensure your core functionality is accessible and works with server-rendered HTML, then layer HTMX and Alpine.js to enrich the user experience. This creates resilient and inclusive applications.</li>
<li><strong>Solve Real Problems:</strong> The true test of these skills will come when you apply them to solve real-world problems. Look for opportunities in your existing Django projects to introduce HTMX for targeted dynamic updates or Alpine.js for enhanced client-side interactivity where it makes sense. Consider this stack for new projects where a full SPA might be overkill, but a traditional request/response cycle feels too static.</li>
</ul>
<p>The path to deep expertise is paved with practice and thoughtful application. You have now seen firsthand how complexity can be framed as a scaffolded journey, where each step reinforces prior concepts while preparing you for more advanced applications. The skills demonstrated in this chapter are designed to empower you to craft applications that are not only technically sound and performant but also a pleasure for users to interact with and for you, the developer, to build and maintain.</p>
<p>Take the foundational understanding, the methodical demonstrations, and the practical examples from this chapter. Internalize the principles, question the <em>why</em> behind different approaches, and confidently apply these patterns. The world of reactive, Django-powered applications awaits your contribution.</p>
</div></div><script>
document.addEventListener('DOMContentLoaded', function() {
  const preTags = document.querySelectorAll('pre');
  
  preTags.forEach(function(pre) {
    const existingContainer = pre.closest('.pre-container');
    if (existingContainer) {
      // If pre is already in a container (e.g. script ran multiple times or manual structure)
      // Ensure button is there or add it. For simplicity, we assume if container exists, button might too.
      // A more robust check would be to see if a .copy-btn already exists for this pre.
      // For now, let's prevent adding duplicate buttons if script re-runs on dynamic content.
      if (existingContainer.querySelector('.copy-btn')) {
          return; // Skip if button already there
      }
    }

    const container = document.createElement('div');
    container.className = 'pre-container';
    
    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'Copy';
    copyBtn.className = 'copy-btn';
    
    copyBtn.addEventListener('click', function() {
      const textToCopy = pre.innerText || pre.textContent; // .innerText is often better for user-visible text
      navigator.clipboard.writeText(textToCopy).then(
        function() {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          copyBtn.classList.remove('failed');
          
          setTimeout(function() {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove('copied');
          }, 2000);
        },
        function() {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Failed!';
          copyBtn.classList.add('failed');
          copyBtn.classList.remove('copied');
          
          setTimeout(function() {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove('failed');
          }, 2000);
        }
      );
    });
    
    // Structure: parent -> container -> pre & button
    if (pre.parentNode) {
        pre.parentNode.insertBefore(container, pre);
    }
    container.appendChild(pre); // Move pre into container
    container.appendChild(copyBtn); // Add button to container
  });
});
</script></body></html>